<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>eks - 小厮</title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="xiaosi" /><meta name="keywords" content='eks, aws' /><meta itemprop="name" content="eks">
<meta itemprop="description" content=""><meta itemprop="datePublished" content="2023-06-08T10:49:32+08:00" />
<meta itemprop="dateModified" content="2024-02-03T14:48:49+08:00" />
<meta itemprop="wordCount" content="8009">
<meta itemprop="keywords" content="eks,aws," /><meta property="og:title" content="eks" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/awsEks/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-08T10:49:32+08:00" />
<meta property="article:modified_time" content="2024-02-03T14:48:49+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="eks"/>
<meta name="twitter:description" content=""/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#ffffff" data-dark="#252627" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="/awsEks/" /><link rel="prev" href="/calicoForKubernets/" /><link rel="next" href="/awsEksctl/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "eks",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "\/awsEks\/"
    },"genre": "posts","keywords": "eks, aws","wordcount":  8009 ,
    "url": "\/awsEks\/","datePublished": "2023-06-08T10:49:32+08:00","dateModified": "2024-02-03T14:48:49+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "小厮"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="wide"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="小厮"><span class="header-title-text">首页</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class='fa-solid fa-archive fa-fw fa-sm'></i> 所有文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="小厮"><span class="header-title-text">首页</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class='fa-solid fa-archive fa-fw fa-sm'></i> 所有文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container container-reverse"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>eks</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      小厮</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/aws/" class="post-category" title="分类 - aws"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> aws</a></span></div><div class="post-meta-line"><span title="发布于 2023-06-08 10:49:32"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2023-06-08">2023-06-08</time></span>&nbsp;<span title="更新于 2024-02-03 14:48:49"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden="true"></i><time datetime="2024-02-03">2024-02-03</time></span>&nbsp;<span title="8009 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 8100 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 16 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#使用-eksctl-搭建-eks-集群">使用 eksctl 搭建 eks 集群</a>
      <ul>
        <li><a href="#安装-eksctl">安装 eksctl</a></li>
        <li><a href="#安装-aws-cli">安装 AWS CLI</a></li>
        <li><a href="#安装-kubectl">安装 kubectl</a></li>
        <li><a href="#创建集群">创建集群</a></li>
      </ul>
    </li>
    <li><a href="#使用-aws-命令创建节点组">使用 aws 命令创建节点组</a></li>
    <li><a href="#使用-eksctl-创建节点组">使用 eksctl 创建节点组</a></li>
    <li><a href="#ebs-存储">EBS 存储</a></li>
    <li><a href="#aws-load-balancer-ingress-控制器">AWS Load Balancer Ingress 控制器</a>
      <ul>
        <li><a href="#定义-aws-alb-资源配置">定义 AWS ALB 资源配置</a>
          <ul>
            <li><a href="#资源标签">资源标签</a></li>
            <li><a href="#是否公有">是否公有</a></li>
            <li><a href="#监听端口">监听端口</a></li>
            <li><a href="#指定操作条件">指定操作条件</a></li>
            <li><a href="#指定操作类型">指定操作类型</a></li>
            <li><a href="#后端地址类型">后端地址类型</a></li>
            <li><a href="#alb-属性">alb 属性</a></li>
            <li><a href="#目标组属性">目标组属性</a></li>
            <li><a href="#目标组健康检查">目标组健康检查</a></li>
            <li><a href="#tls">TLS</a></li>
          </ul>
        </li>
        <li><a href="#alb-http-示例一">ALB HTTP 示例一</a></li>
        <li><a href="#alb-https-示例一">ALB HTTPS 示例一</a></li>
        <li><a href="#定义-aws-nlb-资源">定义 AWS NLB 资源</a>
          <ul>
            <li><a href="#资源标签-1">资源标签</a></li>
            <li><a href="#是否公有-1">是否公有</a></li>
            <li><a href="#后端地址类型-1">后端地址类型</a></li>
            <li><a href="#路由子网">路由子网</a></li>
            <li><a href="#公网-ip">公网 IP</a></li>
            <li><a href="#nlb-属性">nlb 属性</a></li>
            <li><a href="#目标组属性-1">目标组属性</a></li>
            <li><a href="#目标组健康检查-1">目标组健康检查</a></li>
          </ul>
        </li>
        <li><a href="#nlb-示例">NLB 示例</a></li>
      </ul>
    </li>
    <li><a href="#控制层面日志">控制层面日志</a></li>
    <li><a href="#error">ERROR</a>
      <ul>
        <li><a href="#failed-build-model-due-to-unable-to-resolve-at-least-one-subnet-0-match-vpc-and-tags">Failed build model due to unable to resolve at least one subnet (0 match VPC and tags)</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><!-- FileID: FID -->
<p>内容来自以下文档：</p>
<ul>
<li><a href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/create-cluster.html"target="_blank" rel="external nofollow noopener noreferrer">EKS 用户指南</a></li>
<li><a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.4/guide/service/nlb/#worker-node-security-groups-selection"target="_blank" rel="external nofollow noopener noreferrer">AWS 负载均衡器控制器</a></li>
</ul>
<!-- 网址链接 -->
<!-- 图片链接 -->
<!-- 其它链接 -->
<h1 id="使用-eksctl-搭建-eks-集群" class="heading-element">
  <a href="#%e4%bd%bf%e7%94%a8-eksctl-%e6%90%ad%e5%bb%ba-eks-%e9%9b%86%e7%be%a4" class="heading-mark"></a>使用 eksctl 搭建 eks 集群</h1><h2 id="安装-eksctl" class="heading-element">
  <a href="#%e5%ae%89%e8%a3%85-eksctl" class="heading-mark"></a>安装 eksctl</h2><div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># https://github.com/weaveworks/eksctl/releases</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># history  | grep eks</span>
</span></span><span class="line"><span class="cl">wget https://github.com/weaveworks/eksctl/releases/download/v0.143.0/eksctl_Linux_amd64.tar.gz
</span></span><span class="line"><span class="cl">tar zxf eksctl_Linux_amd64.tar.gz
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> eksctl_Linux_amd64.tar.gz
</span></span><span class="line"><span class="cl">./eksctl --help
</span></span><span class="line"><span class="cl">mv eksctl /usr/local/bin/
</span></span><span class="line"><span class="cl">eksctl --help
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># eksctl version</span>
</span></span><span class="line"><span class="cl">0.143.0</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="安装-aws-cli" class="heading-element">
  <a href="#%e5%ae%89%e8%a3%85-aws-cli" class="heading-mark"></a>安装 AWS CLI</h2><!--
## 确认权限

```bash
# 查看当前身份信息
[root@localhost ~]# aws sts get-caller-identity | jq .
{
  "UserId": "AIDATIE4A5KS5IXIT2O2G",
  "Account": "223665515173",
  "Arn": "arn:aws:iam::223665515173:user/xiaosi"
}
```

```bash
# 查看权限，EvalDecision 字段值为 allowed 
[root@localhost ~]# aws iam simulate-principal-policy \
> --policy-source-arn "arn:aws:iam::223665515173:user/xiaosi" \
> --action-names "eks:*" \
> --profile xiaosi | jq .
{
  "EvaluationResults": [
    {
      "EvalActionName": "eks:*",
      "EvalResourceName": "*",
      "EvalDecision": "allowed",
      "MatchedStatements": [
        {
          "SourcePolicyId": "AdministratorAccess",
          "SourcePolicyType": "IAM Policy",
          "StartPosition": {
            "Line": 3,
            "Column": 17
          },
          "EndPosition": {
            "Line": 8,
            "Column": 6
          }
        }
      ],
      "MissingContextValues": [],
      "OrganizationsDecisionDetail": {
        "AllowedByOrganizations": true
      }
    }
  ]
}
```
-->
<h2 id="安装-kubectl" class="heading-element">
  <a href="#%e5%ae%89%e8%a3%85-kubectl" class="heading-mark"></a>安装 kubectl</h2><div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
</span></span><span class="line"><span class="cl">[kubernetes]
</span></span><span class="line"><span class="cl">name=Kubernetes
</span></span><span class="line"><span class="cl">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
</span></span><span class="line"><span class="cl">enabled=1
</span></span><span class="line"><span class="cl">gpgcheck=1
</span></span><span class="line"><span class="cl">gpgkey=https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</span></span><span class="line"><span class="cl">exclude=kubelet kubeadm kubectl
</span></span><span class="line"><span class="cl">EOF</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># yum install -y kubectl --disableexcludes=kubernetes</span>
</span></span><span class="line"><span class="cl">Loaded plugins: fastestmirror
</span></span><span class="line"><span class="cl">Loading mirror speeds from cached hostfile
</span></span><span class="line"><span class="cl">....</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="创建集群" class="heading-element">
  <a href="#%e5%88%9b%e5%bb%ba%e9%9b%86%e7%be%a4" class="heading-mark"></a>创建集群</h2><div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># eksctl create cluster \</span>
</span></span><span class="line"><span class="cl">--profile <span class="s2">&#34;xiaosi&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--region <span class="s2">&#34;ap-southeast-1&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--name <span class="s2">&#34;eks01&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--version <span class="s2">&#34;1.27&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--without-nodegroup <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--kubeconfig <span class="s2">&#34;/root/.kube/singapore-eks01-config&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--tags <span class="s2">&#34;user=xiaosi&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2023-07-23 16:40:42 <span class="o">[</span>ℹ<span class="o">]</span>  eksctl version 0.143.0
</span></span><span class="line"><span class="cl">2023-07-23 16:40:42 <span class="o">[</span>ℹ<span class="o">]</span>  using region ap-southeast-1
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">2023-07-23 16:52:48 <span class="o">[</span>✔<span class="o">]</span>  saved kubeconfig as <span class="s2">&#34;/root/.kube/singapore-eks01-config&#34;</span>
</span></span><span class="line"><span class="cl">2023-07-23 16:52:48 <span class="o">[</span>ℹ<span class="o">]</span>  no tasks
</span></span><span class="line"><span class="cl">2023-07-23 16:52:48 <span class="o">[</span>✔<span class="o">]</span>  all EKS cluster resources <span class="k">for</span> <span class="s2">&#34;eks01&#34;</span> have been created
</span></span><span class="line"><span class="cl">2023-07-23 16:52:50 <span class="o">[</span>ℹ<span class="o">]</span>  kubectl <span class="nb">command</span> should work with <span class="s2">&#34;/root/.kube/singapore-eks01-config&#34;</span>, try <span class="s1">&#39;kubectl --kubeconfig=/root/.kube/singapore-eks01-config get nodes&#39;</span>
</span></span><span class="line"><span class="cl">2023-07-23 16:52:50 <span class="o">[</span>✔<span class="o">]</span>  EKS cluster <span class="s2">&#34;eks01&#34;</span> in <span class="s2">&#34;ap-southeast-1&#34;</span> region is ready</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-6"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># eksctl get cluster --profile &#34;xiaosi&#34; --region &#34;ap-southeast-1&#34;</span>
</span></span><span class="line"><span class="cl">NAME    REGION          EKSCTL CREATED
</span></span><span class="line"><span class="cl">eks01   ap-southeast-1  True</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="使用-aws-命令创建节点组" class="heading-element">
  <a href="#%e4%bd%bf%e7%94%a8-aws-%e5%91%bd%e4%bb%a4%e5%88%9b%e5%bb%ba%e8%8a%82%e7%82%b9%e7%bb%84" class="heading-mark"></a>使用 aws 命令创建节点组</h1><p>格式</p>
<div class="highlight" id="id-7"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">https://awscli.amazonaws.com/v2/documentation/api/latest/reference/eks/create-nodegroup.html
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">aws eks create-nodegroup 
</span></span><span class="line"><span class="cl">--cluster-name &lt;value&gt;  <span class="c1"># eks名称</span>
</span></span><span class="line"><span class="cl">--nodegroup-name &lt;value&gt;  <span class="c1"># 节点组名称</span>
</span></span><span class="line"><span class="cl">--subnets &lt;value&gt;   <span class="c1"># 节点组子网</span>
</span></span><span class="line"><span class="cl">--node-role &lt;value&gt;  <span class="c1"># 节点角色ARN</span>
</span></span><span class="line"><span class="cl">--remote-access &lt;value&gt;  <span class="c1"># 指定 允许远程访问的列表</span>
</span></span><span class="line"><span class="cl">--scaling-config &lt;value&gt;  <span class="c1"># 自动扩缩</span>
</span></span><span class="line"><span class="cl">--ami-type &lt;value&gt;  <span class="c1"># AMI 类型</span>
</span></span><span class="line"><span class="cl">--instance-types &lt;value&gt;  <span class="c1"># 实例类型</span>
</span></span><span class="line"><span class="cl">--capacity-type &lt;value&gt; <span class="c1"># 购买模型</span></span></span></code></pre></td></tr></table>
</div>
</div><p>示例</p>
<div class="highlight" id="id-8"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">aws eks create-nodegroup <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--cluster <span class="s2">&#34;eks01&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--nodegroup-name <span class="s2">&#34;work-arm64-spot&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--subnets <span class="s2">&#34;subnet-03f985d37e90c79e2&#34;</span>  <span class="s2">&#34;subnet-05b08efbdc8bb1e69&#34;</span> <span class="s2">&#34;subnet-0f783da364e506e14&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--node-role <span class="s2">&#34;arn:aws:iam::223665515173:role/eks-nodegroup&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--remote-access <span class="s2">&#34;ec2SshKey=xiaosi-singapore-ec2&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--scaling-config <span class="s2">&#34;minSize=1,maxSize=6,desiredSize=1&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ami-type <span class="s2">&#34;AL2_ARM_64&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--instance-types  <span class="s2">&#34;c6g.large&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--capacity-type <span class="s2">&#34;SPOT&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--profile <span class="s2">&#34;yh-xiaosi&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--region <span class="s2">&#34;ap-southeast-1&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>示例</p>
<div class="highlight" id="id-9"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">aws eks create-nodegroup <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--cluster <span class="s2">&#34;xiaosi&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--nodegroup-name <span class="s2">&#34;private-a&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--subnets <span class="s2">&#34;subnet-0921ac14d1573d55f&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--remote-access <span class="s2">&#34;ec2SshKey=ec2&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--node-role <span class="s2">&#34;arn:aws:iam::223665515173:role/KarpenterNodeRole-xiaosi&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ami-type <span class="s2">&#34;AL2_ARM_64&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--instance-types  <span class="s2">&#34;c6g.large&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--capacity-type <span class="s2">&#34;ON_DEMAND&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--scaling-config <span class="s2">&#34;minSize=1,maxSize=2,desiredSize=1&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--profile <span class="s2">&#34;yh-xiaosi&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--region <span class="s2">&#34;ap-southeast-1&#34;</span> <span class="p">|</span> jq </span></span></code></pre></td></tr></table>
</div>
</div><p>示例</p>
<div class="highlight" id="id-10"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># aws eks create-nodegroup \</span>
</span></span><span class="line"><span class="cl">--cluster <span class="s2">&#34;xiaosi&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--nodegroup-name <span class="s2">&#34;private-b&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--subnets <span class="s2">&#34;subnet-0821ddb76fdf30d03&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--remote-access <span class="s2">&#34;ec2SshKey=ec2&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--node-role <span class="s2">&#34;arn:aws:iam::223665515173:role/KarpenterNodeRole-xiaosi&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ami-type <span class="s2">&#34;AL2_ARM_64&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--instance-types  <span class="s2">&#34;c6g.large&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--capacity-type <span class="s2">&#34;ON_DEMAND&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--scaling-config <span class="s2">&#34;minSize=1,maxSize=2,desiredSize=1&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--profile <span class="s2">&#34;yh-xiaosi&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--region <span class="s2">&#34;ap-southeast-1&#34;</span> <span class="p">|</span> jq
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;nodegroup&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">  ...</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="使用-eksctl-创建节点组" class="heading-element">
  <a href="#%e4%bd%bf%e7%94%a8-eksctl-%e5%88%9b%e5%bb%ba%e8%8a%82%e7%82%b9%e7%bb%84" class="heading-mark"></a>使用 eksctl 创建节点组</h1><p>只有使用<code>eksctl</code>命令创建的<code>eks</code>集群才能被<code>eksctl</code>识别</p>
<div class="highlight" id="id-11"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ssh-keygen -t rsa -N &#34;&#34; -f .eks/zjc-yuhai/singapore/node01</span>
</span></span><span class="line"><span class="cl">Generating public/private rsa key pair.
</span></span><span class="line"><span class="cl">Your identification has been saved in .eks/zjc-yuhai/singapore/node01.
</span></span><span class="line"><span class="cl">Your public key has been saved in .eks/zjc-yuhai/singapore/node01.pub.
</span></span><span class="line"><span class="cl">...</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-12"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 命令行</span>
</span></span><span class="line"><span class="cl">eksctl create nodegroup <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--profile <span class="s2">&#34;zjc-yuhai&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--region <span class="s2">&#34;ap-southeast-1&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--cluster <span class="s2">&#34;eks01&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--spot <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--name <span class="s2">&#34;node01&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--nodes <span class="m">1</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--nodes-max <span class="m">6</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--node-zones <span class="s2">&#34;ap-southeast-1a&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--node-labels <span class="s2">&#34;user=xiaosi,zone=ap-southeast-1a&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--instance-types<span class="o">=</span><span class="s2">&#34;c6a.xlarge,c5a.xlarge,c6i.xlarge,c5.xlarge&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ssh-access <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ssh-public-key ~/.eks/zjc-yuhai/singapore/node01.pub </span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-13"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost singapore<span class="o">]</span><span class="c1"># cat eks01-node01.yaml</span>
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl"><span class="c1"># https://eksctl.io/usage/schema/</span>
</span></span><span class="line"><span class="cl">apiVersion: eksctl.io/v1alpha5
</span></span><span class="line"><span class="cl">kind: ClusterConfig
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: eks01 <span class="c1"># 集群名称</span>
</span></span><span class="line"><span class="cl">  region: ap-southeast-1 <span class="c1"># 区域</span>
</span></span><span class="line"><span class="cl">managedNodeGroups:
</span></span><span class="line"><span class="cl">  - name: node01 <span class="c1"># 节点组名称</span>
</span></span><span class="line"><span class="cl">    labels: <span class="c1"># 节点标签</span>
</span></span><span class="line"><span class="cl">      user: xiaosi
</span></span><span class="line"><span class="cl">    availabilityZones:
</span></span><span class="line"><span class="cl">    - ap-southeast-1a
</span></span><span class="line"><span class="cl">    instanceTypes:  <span class="c1"># 节点实例类型列表</span>
</span></span><span class="line"><span class="cl">    - c6a.xlarge
</span></span><span class="line"><span class="cl">    - c5a.xlarge
</span></span><span class="line"><span class="cl">    - c6i.xlarge
</span></span><span class="line"><span class="cl">    - c5.xlarge
</span></span><span class="line"><span class="cl">    desiredCapacity: <span class="m">1</span> <span class="c1"># 所需节点数据</span>
</span></span><span class="line"><span class="cl">    minSize: <span class="m">1</span> <span class="c1"># 最小节点数</span>
</span></span><span class="line"><span class="cl">    maxSize: <span class="m">6</span> <span class="c1"># 最大节点数</span>
</span></span><span class="line"><span class="cl">    volumeSize: <span class="m">80</span>  <span class="c1"># 节点容量，单位为G</span>
</span></span><span class="line"><span class="cl">    privateNetworking: <span class="nb">false</span> <span class="c1"># 是否部署在私有子网</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 购买 spot 类型，最多存在 8 小时，到期删除节点组</span>
</span></span><span class="line"><span class="cl">    spot: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">    ssh:
</span></span><span class="line"><span class="cl">      <span class="c1"># 启用 AWS Session Manager</span>
</span></span><span class="line"><span class="cl">      enableSsm: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># 启用ssh远程连接</span>
</span></span><span class="line"><span class="cl">      allow: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># ssh 公钥路径</span>
</span></span><span class="line"><span class="cl">      publicKeyPath: ~/.eks/zjc-yuhai/singapore/ssh-node.pub
</span></span><span class="line"><span class="cl">    taints: <span class="c1"># k8s 节点污点</span>
</span></span><span class="line"><span class="cl">    - key: zone
</span></span><span class="line"><span class="cl">      value: <span class="s2">&#34;ap-southeast-1a&#34;</span>
</span></span><span class="line"><span class="cl">      effect: NoSchedule
</span></span><span class="line"><span class="cl">    - key: application
</span></span><span class="line"><span class="cl">      value: <span class="s2">&#34;test&#34;</span>
</span></span><span class="line"><span class="cl">      effect: NoSchedule
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost singapore<span class="o">]</span><span class="c1"># eksctl create nodegroup --profile &#34;zjc-yuhai&#34; -f eks01-node01.yaml</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">2023-07-24 11:30:44 <span class="o">[</span>✔<span class="o">]</span>  created <span class="m">0</span> nodegroup<span class="o">(</span>s<span class="o">)</span> in cluster <span class="s2">&#34;eks01&#34;</span>
</span></span><span class="line"><span class="cl">2023-07-24 11:30:44 <span class="o">[</span>ℹ<span class="o">]</span>  nodegroup <span class="s2">&#34;node01&#34;</span> has <span class="m">1</span> node<span class="o">(</span>s<span class="o">)</span>
</span></span><span class="line"><span class="cl">2023-07-24 11:30:44 <span class="o">[</span>ℹ<span class="o">]</span>  node <span class="s2">&#34;ip-192-168-1-34.ap-southeast-1.compute.internal&#34;</span> is ready
</span></span><span class="line"><span class="cl">2023-07-24 11:30:44 <span class="o">[</span>ℹ<span class="o">]</span>  waiting <span class="k">for</span> at least <span class="m">1</span> node<span class="o">(</span>s<span class="o">)</span> to become ready in <span class="s2">&#34;node01&#34;</span>
</span></span><span class="line"><span class="cl">2023-07-24 11:30:44 <span class="o">[</span>ℹ<span class="o">]</span>  nodegroup <span class="s2">&#34;node01&#34;</span> has <span class="m">1</span> node<span class="o">(</span>s<span class="o">)</span>
</span></span><span class="line"><span class="cl">2023-07-24 11:30:44 <span class="o">[</span>ℹ<span class="o">]</span>  node <span class="s2">&#34;ip-192-168-1-34.ap-southeast-1.compute.internal&#34;</span> is ready
</span></span><span class="line"><span class="cl">2023-07-24 11:30:44 <span class="o">[</span>✔<span class="o">]</span>  created <span class="m">1</span> managed nodegroup<span class="o">(</span>s<span class="o">)</span> in cluster <span class="s2">&#34;eks01&#34;</span>
</span></span><span class="line"><span class="cl">2023-07-24 11:30:45 <span class="o">[</span>ℹ<span class="o">]</span>  checking security group configuration <span class="k">for</span> all nodegroups
</span></span><span class="line"><span class="cl">2023-07-24 11:30:45 <span class="o">[</span>ℹ<span class="o">]</span>  all nodegroups have up-to-date cloudformation templates</span></span></code></pre></td></tr></table>
</div>
</div><p>查看节点<code>IP</code>地址</p>
<div class="highlight" id="id-14"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost singapore<span class="o">]</span><span class="c1"># alias zjcSingaporeEks01=&#34;kubectl --kubeconfig=/root/.eks/zjc-yuhai/singapore/eks01-kube.config&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost singapore<span class="o">]</span><span class="c1"># zjcSingaporeEks01 get nodes ip-192-168-1-89.ap-southeast-1.compute.internal  -o json | jq &#39;.status.addresses[]&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;address&#34;</span>: <span class="s2">&#34;192.168.1.89&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;InternalIP&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;address&#34;</span>: <span class="s2">&#34;54.179.59.221&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;ExternalIP&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;address&#34;</span>: <span class="s2">&#34;ip-192-168-1-89.ap-southeast-1.compute.internal&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;InternalDNS&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;address&#34;</span>: <span class="s2">&#34;ip-192-168-1-89.ap-southeast-1.compute.internal&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;Hostname&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;address&#34;</span>: <span class="s2">&#34;ec2-54-179-59-221.ap-southeast-1.compute.amazonaws.com&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;ExternalDNS&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h1 id="ebs-存储" class="heading-element">
  <a href="#ebs-%e5%ad%98%e5%82%a8" class="heading-mark"></a>EBS 存储</h1><ol>
<li>
<p>查找集群是否有<code>OIDC ID</code></p>
<div class="highlight" id="id-15"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/enable-iam-roles-for-service-accounts.html</span>
</span></span><span class="line"><span class="cl"><span class="c1">##  搜索 OIDC ID ，确定集群是否拥有现有 IAM OIDC 提供商。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># aws eks describe-cluster \</span>
</span></span><span class="line"><span class="cl">--profile  <span class="s2">&#34;zjc-yuhai&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--region <span class="s2">&#34;ap-southeast-1&#34;</span>  <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--name <span class="s2">&#34;eks01&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--query <span class="s2">&#34;cluster.identity.oidc.issuer&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--output text <span class="p">|</span> cut -d <span class="s1">&#39;/&#39;</span> -f <span class="m">5</span>
</span></span><span class="line"><span class="cl">363BFA878EE4DF9B3569DE2E5010DAA5</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>确定账户中是否已存在集群<code>IAM OIDC ID</code>商。下面表示没有</p>
<div class="highlight" id="id-16"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># aws iam list-open-id-connect-providers \</span>
</span></span><span class="line"><span class="cl">--profile  <span class="s2">&#34;zjc-yuhai&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--region <span class="s2">&#34;ap-southeast-1&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;OpenIDConnectProviderList&#34;</span>: <span class="o">[]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>创建 <code>IAM OIDC</code></p>
<div class="highlight" id="id-17"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># eksctl utils associate-iam-oidc-provider \</span>
</span></span><span class="line"><span class="cl">--profile <span class="s2">&#34;zjc-yuhai&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--region <span class="s2">&#34;ap-southeast-1&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--cluster <span class="s2">&#34;eks01&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--approve</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>再次验证</p>
<div class="highlight" id="id-18"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># aws iam  --profile  &#34;zjc-yuhai&#34; --region &#34;ap-southeast-1&#34; list-open-id-connect-providers</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;OpenIDConnectProviderList&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Arn&#34;</span>: <span class="s2">&#34;arn:aws:iam::968767926216:oidc-provider/oidc.eks.ap-southeast-1.amazonaws.com/id/363BFA878EE4DF9B3569DE2E5010DAA5&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>创建拥有使用<code>EBS</code>的<code>IAM</code>角色附加给<code>EKS</code></p>
<div class="highlight" id="id-19"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/csi-iam-role.html</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果集群位于 AWS GovCloud（美国东部）或 AWS GovCloud（美国西部）AWS 区域，则将 arn:aws: 替换为 arn:aws-us-gov:。</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost singapore<span class="o">]</span><span class="c1"># eksctl create iamserviceaccount \</span>
</span></span><span class="line"><span class="cl">--profile  <span class="s2">&#34;zjc-yuhai&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--region <span class="s2">&#34;ap-southeast-1&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--cluster <span class="s2">&#34;eks01&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--name ebs-csi-controller-sa <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--namespace kube-system <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--role-name AmazonEKS_EBS_CSI_DriverRole <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--role-only <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--attach-policy-arn arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--approve</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-20"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># eksctl get iamserviceaccount \</span>
</span></span><span class="line"><span class="cl">--profile  <span class="s2">&#34;zjc-yuhai&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--region <span class="s2">&#34;ap-southeast-1&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--cluster <span class="s2">&#34;eks01&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--name ebs-csi-controller-sa <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--output json <span class="p">|</span> jq</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>添加 <code>EBS CSI</code> 组件</p>
<div class="highlight" id="id-21"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost singapore<span class="o">]</span><span class="c1"># eksctl create addon \</span>
</span></span><span class="line"><span class="cl">--profile <span class="s2">&#34;zjc-yuhai&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--region <span class="s2">&#34;ap-southeast-1&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--name <span class="s2">&#34;aws-ebs-csi-driver&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--cluster <span class="s2">&#34;eks01&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--service-account-role-arn arn:aws:iam::968767926216:role/AmazonEKS_EBS_CSI_DriverRole <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--force</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>查看 <code>EBS</code> 插件状态</p>
<div class="highlight" id="id-22"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost yh-eks<span class="o">]</span><span class="c1"># eksctl get addon \</span>
</span></span><span class="line"><span class="cl">&gt; --profile <span class="s2">&#34;zjc-yuhai&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt; --region <span class="s2">&#34;ap-southeast-1&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt; --cluster <span class="s2">&#34;yh-eks&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt; --name <span class="s2">&#34;aws-ebs-csi-driver&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt; --output json <span class="p">|</span> jq
</span></span><span class="line"><span class="cl">2023-07-27 15:56:02 <span class="o">[</span>ℹ<span class="o">]</span>  Kubernetes version <span class="s2">&#34;1.27&#34;</span> in use by cluster <span class="s2">&#34;yh-eks&#34;</span>
</span></span><span class="line"><span class="cl">2023-07-27 15:56:03 <span class="o">[</span>ℹ<span class="o">]</span>  to see issues <span class="k">for</span> an addon run <span class="sb">`</span>eksctl get addon --name &lt;addon-name&gt; --cluster &lt;cluster-name&gt;<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>
</span></span><span class="line"><span class="cl">  <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Name&#34;</span>: <span class="s2">&#34;aws-ebs-csi-driver&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Version&#34;</span>: <span class="s2">&#34;v1.21.0-eksbuild.1&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;NewerVersion&#34;</span>: <span class="s2">&#34;&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;IAMRole&#34;</span>: <span class="s2">&#34;arn:aws:iam::968767926216:role/AmazonEKS_EBS_CSI_DriverRole&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Status&#34;</span>: <span class="s2">&#34;ACTIVE&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;ConfigurationValues&#34;</span>: <span class="s2">&#34;&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Issues&#34;</span>: null
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">]</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>EKS</code> 不会自动为集群更新 <code>Amazon EBS CSI</code>。使用下面命令更新 EBS 驱动插件(如果需要)</p>
<div class="highlight" id="id-23"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># eksctl update addon \</span>
</span></span><span class="line"><span class="cl">--name <span class="s2">&#34;aws-ebs-csi-driver&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--version <span class="s2">&#34;v1.11.4-eksbuild.1&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--cluster <span class="s2">&#34;my-cluster&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--force</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>删除默认的<code>GP2</code>存储类，后续创建 <code>GP3</code> 做为默认的存储类</p>
<div class="highlight" id="id-24"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># kubectl delete storageclass gp2 \</span>
</span></span><span class="line"><span class="cl">--kubeconfig .kube/singapore-eks01-config</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>创建<code>gp3</code> 为默认存储类</p>
<div class="highlight" id="id-25"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># cat aws-ebs.yaml</span>
</span></span><span class="line"><span class="cl">apiVersion: storage.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: StorageClass
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    storageclass.kubernetes.io/is-default-class: <span class="s2">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">  name: aws-ebs
</span></span><span class="line"><span class="cl">provisioner: ebs.csi.aws.com
</span></span><span class="line"><span class="cl">reclaimPolicy: Delete
</span></span><span class="line"><span class="cl">volumeBindingMode: WaitForFirstConsumer
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># kubectl apply -f aws-ebs.yaml --kubeconfig /root/.kube/singapore-eks01-config</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>创建资源测试</p>
</li>
</ol>
<div class="highlight" id="id-26"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost yh-eks<span class="o">]</span><span class="c1"># cat eks-ebs-csi-test.yaml</span>
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: storage.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: StorageClass
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: ebs-test
</span></span><span class="line"><span class="cl">provisioner: ebs.csi.aws.com
</span></span><span class="line"><span class="cl">volumeBindingMode: WaitForFirstConsumer
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: PersistentVolumeClaim
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: ebs-claim
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  accessModes:
</span></span><span class="line"><span class="cl">    - ReadWriteOnce
</span></span><span class="line"><span class="cl">  storageClassName: ebs-test
</span></span><span class="line"><span class="cl">  resources:
</span></span><span class="line"><span class="cl">    requests:
</span></span><span class="line"><span class="cl">      storage: 4Gi
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: app
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  affinity:
</span></span><span class="line"><span class="cl">    nodeAffinity:
</span></span><span class="line"><span class="cl">      requiredDuringSchedulingIgnoredDuringExecution:
</span></span><span class="line"><span class="cl">        nodeSelectorTerms:
</span></span><span class="line"><span class="cl">        - matchExpressions:
</span></span><span class="line"><span class="cl">          - key: alpha.eksctl.io/nodegroup-name
</span></span><span class="line"><span class="cl">            operator: In
</span></span><span class="line"><span class="cl">            values:
</span></span><span class="line"><span class="cl">            - <span class="nb">test</span>
</span></span><span class="line"><span class="cl">  tolerations:
</span></span><span class="line"><span class="cl">  - key: <span class="s2">&#34;zone&#34;</span>
</span></span><span class="line"><span class="cl">    value: <span class="s2">&#34;ap-southeast-1a&#34;</span>
</span></span><span class="line"><span class="cl">    operator: <span class="s2">&#34;Equal&#34;</span>
</span></span><span class="line"><span class="cl">  - key: <span class="s2">&#34;application&#34;</span>
</span></span><span class="line"><span class="cl">    value: <span class="s2">&#34;test&#34;</span>
</span></span><span class="line"><span class="cl">    operator: <span class="s2">&#34;Equal&#34;</span>
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: app
</span></span><span class="line"><span class="cl">    image: centos
</span></span><span class="line"><span class="cl">    command: <span class="o">[</span><span class="s2">&#34;/bin/sh&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">    args: <span class="o">[</span><span class="s2">&#34;-c&#34;</span>, <span class="s2">&#34;while true; do echo </span><span class="k">$(</span>date -u<span class="k">)</span><span class="s2"> &gt;&gt; /usr/share/nginx/html/index.html; sleep 99; done&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">    volumeMounts:
</span></span><span class="line"><span class="cl">    - name: persistent-storage
</span></span><span class="line"><span class="cl">      mountPath: /usr/share/nginx/html/
</span></span><span class="line"><span class="cl">  volumes:
</span></span><span class="line"><span class="cl">  - name: persistent-storage
</span></span><span class="line"><span class="cl">    persistentVolumeClaim:
</span></span><span class="line"><span class="cl">      claimName: ebs-claim
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># kubectl apply -f eks-ebs-csi-test.yaml --kubeconfig /root/.kube/singapore-eks01-config</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>验证</li>
</ol>
<div class="highlight" id="id-27"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># kubectl --kubeconfig /root/.kube/singapore-eks01-config \</span>
</span></span><span class="line"><span class="cl">get StorageClass,pv,pvc,pod 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                                 PROVISIONER       RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
</span></span><span class="line"><span class="cl">storageclass.storage.k8s.io/ebs-sc   ebs.csi.aws.com   Delete          WaitForFirstConsumer   <span class="nb">false</span>                  90m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM               STORAGECLASS   REASON   AGE
</span></span><span class="line"><span class="cl">persistentvolume/pvc-82433b8c-e7b6-4a2c-afe4-c1c448d8aeee   4Gi        RWO            Delete           Bound    default/ebs-claim   ebs-sc                  90m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
</span></span><span class="line"><span class="cl">persistentvolumeclaim/ebs-claim   Bound    pvc-82433b8c-e7b6-4a2c-afe4-c1c448d8aeee   4Gi        RWO            ebs-sc         90m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># kubectl --kubeconfig /root/.kube/singapore-eks01-config \</span>
</span></span><span class="line"><span class="cl"><span class="nb">exec</span> app -- cat /usr/share/nginx/html/index.html
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Sun Jul <span class="m">9</span> 05:21:47 UTC <span class="m">2023</span>
</span></span><span class="line"><span class="cl">Sun Jul <span class="m">9</span> 05:21:47 UTC <span class="m">2023</span>
</span></span><span class="line"><span class="cl">Sun Jul <span class="m">9</span> 05:21:47 UTC <span class="m">2023</span>
</span></span><span class="line"><span class="cl">Sun Jul <span class="m">9</span> 05:21:47 UTC <span class="m">2023</span>
</span></span><span class="line"><span class="cl">Sun Jul <span class="m">9</span> 05:21:47 UTC <span class="m">2023</span>
</span></span><span class="line"><span class="cl">Sun Jul <span class="m">9</span> 05:21:47 UTC <span class="m">2023</span>
</span></span><span class="line"><span class="cl">Sun Jul <span class="m">9</span> 05:21:47 UTC <span class="m">2023</span>
</span></span><span class="line"><span class="cl">Sun Jul <span class="m">9</span> 05:21:47 UTC <span class="m">2023</span>
</span></span><span class="line"><span class="cl">Sun Jul <span class="m">9</span> 05:21:47 UTC <span class="m">2023</span>
</span></span><span class="line"><span class="cl">Sun Jul <span class="m">9</span> 05:21:47 UTC <span class="m">2023</span>
</span></span><span class="line"><span class="cl">Sun Jul <span class="m">9</span> 05:21:47 UTC <span class="m">2023</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 手动创建 pv 时，指定字段值 PersistentVolume.metadata.annotations:pv.kubernetes.io/provisioned-by: ebs.csi.aws.com</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># kubectl get pv pvc-82433b8c-e7b6-4a2c-afe4-c1c448d8aeee -o yaml --kubeconfig .kube/singapore-eks01-config</span>
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: PersistentVolume
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    pv.kubernetes.io/provisioned-by: ebs.csi.aws.com</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="aws-load-balancer-ingress-控制器" class="heading-element">
  <a href="#aws-load-balancer-ingress-%e6%8e%a7%e5%88%b6%e5%99%a8" class="heading-mark"></a>AWS Load Balancer Ingress 控制器</h1><ol>
<li>
<p>创建 <code>iam</code> 策略</p>
<div class="highlight" id="id-28"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## github: https://github.com/kubernetes-sigs/aws-load-balancer-controller</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 美国地区使用：https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.7/docs/install/iam_policy_us-gov.json</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># mkdir AwsLoadBalancerController ; cd AwsLoadBalancerController</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 下载 IAM 策略文件</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># curl -Os https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.5.3/docs/install/iam_policy.json</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># ls</span>
</span></span><span class="line"><span class="cl">iam_policy.json
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建策略</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># aws iam create-policy \</span>
</span></span><span class="line"><span class="cl">--policy-name AWSLoadBalancerControllerIAMPolicy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--policy-document file://iam_policy.json <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--region <span class="s2">&#34;ap-southeast-1&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--profile <span class="s2">&#34;zjc-yuhai&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Policy&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;PolicyName&#34;</span>: <span class="s2">&#34;AWSLoadBalancerControllerIAMPolicy&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;PolicyId&#34;</span>: <span class="s2">&#34;ANPA6DDYRN7EOPWLETHPG&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Arn&#34;</span>: <span class="s2">&#34;arn:aws:iam::968767926216:policy/AWSLoadBalancerControllerIAMPolicy&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Path&#34;</span>: <span class="s2">&#34;/&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;DefaultVersionId&#34;</span>: <span class="s2">&#34;v1&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;AttachmentCount&#34;</span>: 0,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;PermissionsBoundaryUsageCount&#34;</span>: 0,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;IsAttachable&#34;</span>: true,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;CreateDate&#34;</span>: <span class="s2">&#34;2023-07-09T08:35:26+00:00&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;UpdateDate&#34;</span>: <span class="s2">&#34;2023-07-09T08:35:26+00:00&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>创建角色，引用上面创建的策略</p>
<div class="highlight" id="id-29"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># eksctl create iamserviceaccount \</span>
</span></span><span class="line"><span class="cl">--cluster<span class="o">=</span>eks01 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--namespace<span class="o">=</span>kube-system <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--name<span class="o">=</span>aws-load-balancer-controller <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--role-name AmazonEKSLoadBalancerControllerRole <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--attach-policy-arn<span class="o">=</span>arn:aws:iam::968767926216:policy/AWSLoadBalancerControllerIAMPolicy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--approve <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--region <span class="s2">&#34;ap-southeast-1&#34;</span> --profile <span class="s2">&#34;zjc-yuhai&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-30"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># wget https://github.com/jetstack/cert-manager/releases/download/v1.12.3/cert-manager.yaml</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># kubectl apply --validate=false  -f cert-manager.yaml --kubeconfig /root/.kube/singapore-eks01-config</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>安装 <code>AWS Load Balancer Controller</code> 附加组件</p>
<div class="highlight" id="id-31"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># wget https://github.com/kubernetes-sigs/aws-load-balancer-controller/releases/download/v2.5.3/v2_5_3_full.yaml \</span>
</span></span><span class="line"><span class="cl">-O aws-load-balancer-controller-v2_5_3_full.yaml</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>删除服务账户</p>
<div class="highlight" id="id-32"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># sed -i.bak -e &#39;595,603d&#39; aws-load-balancer-controller-v2_5_3_full.yaml</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>修改集群名称</p>
<div class="highlight" id="id-33"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># sed -i.bak -e &#39;s/your-cluster-name/eks01/&#39;  aws-load-balancer-controller-v2_5_3_full.yaml</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>创建 <code>AWS Load Balancer Controller</code></p>
<div class="highlight" id="id-34"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># kubectl apply -f aws-load-balancer-controller-v2_5_3_full.yaml \</span>
</span></span><span class="line"><span class="cl">--kubeconfig /root/.kube/singapore-eks01-config</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h2 id="定义-aws-alb-资源配置" class="heading-element">
  <a href="#%e5%ae%9a%e4%b9%89-aws-alb-%e8%b5%84%e6%ba%90%e9%85%8d%e7%bd%ae" class="heading-mark"></a>定义 AWS ALB 资源配置</h2><p><code>Ingress.metadata.annotations</code> 可用注解在<a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.5/guide/ingress/annotations/"target="_blank" rel="external nofollow noopener noreferrer">AWS Load Balancer Controller Igresss Annotations</a> 查看完整理的说明</p>
<p><code>ALB</code>,（<code>Application Load Balancer</code>）使用注意事项</p>
<ul>
<li><code>Service.spec.loadBalancerClass</code>: 字段值必须显示指定为 <code>service.k8s.aws/alb</code>，否则会同时创建 <code>nlb</code></li>
<li><code>IngressClass.spec.controller</code>: 指定为 <code>ingress.k8s.aws/alb</code></li>
<li><code>Ingress</code> 资源被创建时才会创建<code>alb</code>，反之删除相关<code>Ingress</code>也会回收<code>alb</code></li>
</ul>
<h3 id="资源标签" class="heading-element">
  <a href="#%e8%b5%84%e6%ba%90%e6%a0%87%e7%ad%be" class="heading-mark"></a>资源标签</h3><p>创建 <code>aws alb</code> 资源时会默认加入以下标签：</p>
<div class="highlight" id="id-35"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">elbv2.k8s.aws/cluster: ${clusterName}
</span></span><span class="line"><span class="cl">ingress.k8s.aws/stack: ${stackID}
</span></span><span class="line"><span class="cl">ingress.k8s.aws/resource: ${resourceID}</span></span></code></pre></td></tr></table>
</div>
</div><p>可使用<code>alb.ingress.kubernetes.io/tags</code>标签添加标签</p>
<div class="highlight" id="id-36"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">alb.ingress.kubernetes.io/tags: <span class="nv">user</span><span class="o">=</span>xiaosi,application<span class="o">=</span>Equal</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="是否公有" class="heading-element">
  <a href="#%e6%98%af%e5%90%a6%e5%85%ac%e6%9c%89" class="heading-mark"></a>是否公有</h3><p><code>alb.ingress.kubernetes.io/scheme</code> 标签有以下值</p>
<ul>
<li><code>internet-facing</code>: 公有，会分配一个公有<code>IP</code>地址</li>
<li><code>internal</code>: 仅<code>vpc</code>内部可用</li>
</ul>
<h3 id="监听端口" class="heading-element">
  <a href="#%e7%9b%91%e5%90%ac%e7%ab%af%e5%8f%a3" class="heading-mark"></a>监听端口</h3><p><code>alb.ingress.kubernetes.io/listen-ports</code> 标签指定监听端口列表，默认会监听 <code>80</code> 或 <code>443</code>(取决是否使用<code>alb.ingress.kubernetes.io/certificate-arn</code>注解)</p>
<div class="highlight" id="id-37"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  name: ingress
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    alb.ingress.kubernetes.io/listen-ports: <span class="p">|</span>
</span></span><span class="line"><span class="cl">      <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span><span class="s2">&#34;HTTP&#34;</span>: 80<span class="o">}</span>,
</span></span><span class="line"><span class="cl">        <span class="o">{</span><span class="s2">&#34;HTTPS&#34;</span>: 443<span class="o">}</span>,
</span></span><span class="line"><span class="cl">        <span class="o">{</span><span class="s2">&#34;HTTP&#34;</span>: 8080<span class="o">}</span>,
</span></span><span class="line"><span class="cl">        <span class="o">{</span><span class="s2">&#34;HTTPS&#34;</span>: 8443<span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">]</span>
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  <span class="c1"># ... (rest of the spec)</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="指定操作条件" class="heading-element">
  <a href="#%e6%8c%87%e5%ae%9a%e6%93%8d%e4%bd%9c%e6%9d%a1%e4%bb%b6" class="heading-mark"></a>指定操作条件</h3><p><code>ingress</code> 本身满足基于路径与主机名的条件，其它基于源<code>IP</code>、<code>HTTP</code>请求头部、<code>HTTP</code>请求方法、查询字符串（<code>url</code> 中<code>?</code>以后的部分）需要添加 <code>alb.ingress.kubernetes.io/conditions.${conditions-name}</code> 注解指定<a href="https://docs.aws.amazon.com/zh_cn/elasticloadbalancing/latest/application/load-balancer-listeners.html#rule-condition-types"target="_blank" rel="external nofollow noopener noreferrer">ALB 规则条件类型</a></p>
<div class="highlight" id="id-38"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/scheme</span><span class="p">:</span><span class="w"> </span><span class="l">internet-facing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/actions.rule-path1</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      {
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;type&#34;: &#34;fixed-response&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;fixedResponseConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;contentType&#34;: &#34;text/plain&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;statusCode&#34;: &#34;200&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;messageBody&#34;: &#34;Host is www.example.com OR anno.example.com&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">      }</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/conditions.rule-path1</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      [
</span></span></span><span class="line"><span class="cl"><span class="sd">        {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;field&#34;: &#34;host-header&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;hostHeaderConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;values&#34;: [&#34;anno.example.com&#34;]
</span></span></span><span class="line"><span class="cl"><span class="sd">          }
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">      ]</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/actions.rule-path2</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      {
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;type&#34;: &#34;fixed-response&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;fixedResponseConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;contentType&#34;: &#34;text/plain&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;statusCode&#34;: &#34;200&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;messageBody&#34;: &#34;Path is /path2 OR /anno/path2&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">      }</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/conditions.rule-path2</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      [
</span></span></span><span class="line"><span class="cl"><span class="sd">        {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;field&#34;: &#34;path-pattern&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;pathPatternConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;values&#34;: [&#34;/anno/path2&#34;]
</span></span></span><span class="line"><span class="cl"><span class="sd">          }
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">      ]</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/actions.rule-path3</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      {
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;type&#34;: &#34;fixed-response&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;fixedResponseConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;contentType&#34;: &#34;text/plain&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;statusCode&#34;: &#34;200&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;messageBody&#34;: &#34;Http header HeaderName is HeaderValue1 OR HeaderValue2&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">      }</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/conditions.rule-path3</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      [
</span></span></span><span class="line"><span class="cl"><span class="sd">        {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;field&#34;: &#34;http-header&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;httpHeaderConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;httpHeaderName&#34;: &#34;HeaderName&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;values&#34;: [&#34;HeaderValue1&#34;, &#34;HeaderValue2&#34;]
</span></span></span><span class="line"><span class="cl"><span class="sd">          }
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">      ]</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/actions.rule-path4</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      {
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;type&#34;: &#34;fixed-response&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;fixedResponseConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;contentType&#34;: &#34;text/plain&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;statusCode&#34;: &#34;200&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;messageBody&#34;: &#34;Http request method is GET OR HEAD&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">      }</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/conditions.rule-path4</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      [
</span></span></span><span class="line"><span class="cl"><span class="sd">        {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;field&#34;: &#34;http-request-method&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;httpRequestMethodConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;Values&#34;: [&#34;GET&#34;, &#34;HEAD&#34;]
</span></span></span><span class="line"><span class="cl"><span class="sd">          }
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">      ]</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/actions.rule-path5</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      {
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;type&#34;: &#34;fixed-response&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;fixedResponseConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;contentType&#34;: &#34;text/plain&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;statusCode&#34;: &#34;200&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;messageBody&#34;: &#34;Query string is paramA:valueA1 OR paramA:valueA2&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">      }</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/conditions.rule-path5</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      [
</span></span></span><span class="line"><span class="cl"><span class="sd">        {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;field&#34;: &#34;query-string&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;queryStringConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;values&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="sd">              {&#34;key&#34;: &#34;paramA&#34;, &#34;value&#34;: &#34;valueA1&#34;},
</span></span></span><span class="line"><span class="cl"><span class="sd">              {&#34;key&#34;: &#34;paramA&#34;, &#34;value&#34;: &#34;valueA2&#34;}
</span></span></span><span class="line"><span class="cl"><span class="sd">            ]
</span></span></span><span class="line"><span class="cl"><span class="sd">          }
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">      ]</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/actions.rule-path6</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      {
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;type&#34;: &#34;fixed-response&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;fixedResponseConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;contentType&#34;: &#34;text/plain&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;statusCode&#34;: &#34;200&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;messageBody&#34;: &#34;Source IP is 192.168.0.0/16 OR 172.16.0.0/16&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">      }</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/conditions.rule-path6</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      [
</span></span></span><span class="line"><span class="cl"><span class="sd">        {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;field&#34;: &#34;source-ip&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;sourceIpConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;values&#34;: [&#34;192.168.0.0/16&#34;, &#34;172.16.0.0/16&#34;]
</span></span></span><span class="line"><span class="cl"><span class="sd">          }
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">      ]</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/actions.rule-path7</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      {
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;type&#34;: &#34;fixed-response&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;fixedResponseConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;contentType&#34;: &#34;text/plain&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;statusCode&#34;: &#34;200&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;messageBody&#34;: &#34;multiple conditions applies&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">      }</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/conditions.rule-path7</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      [
</span></span></span><span class="line"><span class="cl"><span class="sd">        {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;field&#34;: &#34;http-header&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;httpHeaderConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;httpHeaderName&#34;: &#34;HeaderName&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;values&#34;: [&#34;HeaderValue&#34;]
</span></span></span><span class="line"><span class="cl"><span class="sd">          }
</span></span></span><span class="line"><span class="cl"><span class="sd">        },
</span></span></span><span class="line"><span class="cl"><span class="sd">        {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;field&#34;: &#34;query-string&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;queryStringConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;values&#34;: [{&#34;key&#34;: &#34;paramA&#34;, &#34;value&#34;: &#34;valueA&#34;}]
</span></span></span><span class="line"><span class="cl"><span class="sd">          }
</span></span></span><span class="line"><span class="cl"><span class="sd">        },
</span></span></span><span class="line"><span class="cl"><span class="sd">        {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;field&#34;: &#34;query-string&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;queryStringConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;values&#34;: [{&#34;key&#34;: &#34;paramB&#34;, &#34;value&#34;: &#34;valueB&#34;}]
</span></span></span><span class="line"><span class="cl"><span class="sd">          }
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">      ]</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">alb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">www.example.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/path1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Exact</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rule-path1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">use-annotation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/path2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Exact</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rule-path2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">use-annotation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/path3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Exact</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rule-path3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">use-annotation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/path4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Exact</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rule-path4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">use-annotation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/path5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Exact</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rule-path5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">use-annotation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/path6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Exact</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rule-path6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">use-annotation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/path7</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Exact</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rule-path7</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">use-annotation</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="指定操作类型" class="heading-element">
  <a href="#%e6%8c%87%e5%ae%9a%e6%93%8d%e4%bd%9c%e7%b1%bb%e5%9e%8b" class="heading-mark"></a>指定操作类型</h3><p><code>alb.ingress.kubernetes.io/actions.${action-name}</code> 指定<a href="https://docs.aws.amazon.com/zh_cn/elasticloadbalancing/latest/application/load-balancer-listeners.html#rule-action-types"target="_blank" rel="external nofollow noopener noreferrer">ALB 规则操作类型</a>。有以下注意事项</p>
<ul>
<li>同一个<code>alb.ingress.kubernetes.io/actions</code>注解的规则冲突或配置错误会导致<code>alb</code>创建失败</li>
<li><code>Ingress.spec.rules.http.paths.backend.service.prot.name</code> 值必须是<code>use-annotation</code>。如果指定了值但没有指定其注解会默认创建 <code>503</code> 状态码</li>
<li><code>${action-name}</code>值必须与<code>Ingress.spec.rules.http.paths.backend.service.name</code>值相同</li>
<li><code>${action-name}</code>值与<code>Service.spec.use-annotation</code>相同且会默认创建流量转发（到<code>EC2</code>或<code>pod ip</code>）</li>
</ul>
<p>下面是官网的一个示例</p>
<div class="highlight" id="id-39"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/scheme</span><span class="p">:</span><span class="w"> </span><span class="l">internet-facing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 自定义 503 响应码</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/actions.response-503</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      {
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;type&#34;: &#34;fixed-response&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;fixedResponseConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;contentType&#34;: &#34;text/plain&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;statusCode&#34;: &#34;503&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;messageBody&#34;: &#34;503 error text&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">      }</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 重定向</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/actions.redirect-to-eks</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      {
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;type&#34;: &#34;redirect&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;redirectConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;host&#34;: &#34;aws.amazon.com&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;path&#34;: &#34;/eks/&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;port&#34;: &#34;443&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;protocol&#34;: &#34;HTTPS&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;query&#34;: &#34;k=v&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;statusCode&#34;: &#34;HTTP_302&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">      }</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 转发到指定目标组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/actions.forward-single-tg</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      {
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;type&#34;: &#34;forward&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;targetGroupARN&#34;: &#34;arn-of-your-target-group&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">      }</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 按权重转发到目标</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/actions.forward-multiple-tg</span><span class="p">:</span><span class="w"> </span><span class="l">| </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;type&#34;: </span><span class="s2">&#34;forward&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;forwardConfig&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">&#34;targetGroups&#34;: </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">&#34;serviceName&#34;: </span><span class="s2">&#34;service-1&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">&#34;servicePort&#34;: </span><span class="s2">&#34;http&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">&#34;weight&#34;: </span><span class="m">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">&#34;serviceName&#34;: </span><span class="s2">&#34;service-2&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">&#34;servicePort&#34;: </span><span class="m">80</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">&#34;weight&#34;: </span><span class="m">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">&#34;targetGroupARN&#34;: </span><span class="s2">&#34;arn-of-your-non-k8s-target-group&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">&#34;weight&#34;: </span><span class="m">60</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">],</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">&#34;targetGroupStickinessConfig&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">&#34;enabled&#34;: </span><span class="kc">true</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">&#34;durationSeconds&#34;: </span><span class="m">200</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">alb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/503</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Exact</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">response-503</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">use-annotation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/eks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Exact</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redirect-to-eks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">use-annotation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/path1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Exact</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">forward-single-tg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">use-annotation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/path2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Exact</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">forward-multiple-tg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">use-annotation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如果操作类型冲突，可以创建<code>Ingress.spec.rules</code>时指定多个记录，如下面<code>301</code>跳转与流量转发示例</p>
<div class="highlight" id="id-40"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="p">[</span><span class="l">root@localhost alb]# cat alb-ingress.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">game-2048-alb-https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-2048-alb-https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/tags</span><span class="p">:</span><span class="w"> </span><span class="l">user=xiaosi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/scheme</span><span class="p">:</span><span class="w"> </span><span class="l">internet-facing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/target-type</span><span class="p">:</span><span class="w"> </span><span class="l">ip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/certificate-arn</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      arn:aws:acm:ap-southeast-1:968767926216:certificate/3487a0a2-c072-4eac-8da5-3d3c0f02275e</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/listen-ports</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      [
</span></span></span><span class="line"><span class="cl"><span class="sd">        {&#34;HTTP&#34;: 80},
</span></span></span><span class="line"><span class="cl"><span class="sd">        {&#34;HTTPS&#34;: 443}
</span></span></span><span class="line"><span class="cl"><span class="sd">      ]</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># http 重定向到 https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/actions.http-301</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">        {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;Type&#34;: &#34;redirect&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;RedirectConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;Protocol&#34;: &#34;HTTPS&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;Port&#34;: &#34;443&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;Host&#34;: &#34;#{host}&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;Path&#34;: &#34;/#{path}&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;Query&#34;: &#34;#{query}&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;StatusCode&#34;: &#34;HTTP_301&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">          }
</span></span></span><span class="line"><span class="cl"><span class="sd">        }</span><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 后端转发</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alb.ingress.kubernetes.io/actions.service-2048-alb-https</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">        {
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;type&#34;: &#34;forward&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">          &#34;forwardConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;targetGroups&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="sd">              {
</span></span></span><span class="line"><span class="cl"><span class="sd">                &#34;serviceName&#34;: &#34;service-2048-alb-https&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">                &#34;servicePort&#34;: 80,
</span></span></span><span class="line"><span class="cl"><span class="sd">                &#34;weight&#34;: 20
</span></span></span><span class="line"><span class="cl"><span class="sd">              }
</span></span></span><span class="line"><span class="cl"><span class="sd">            ],
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#34;targetGroupStickinessConfig&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">              &#34;enabled&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="sd">              &#34;durationSeconds&#34;: 200
</span></span></span><span class="line"><span class="cl"><span class="sd">            }
</span></span></span><span class="line"><span class="cl"><span class="sd">          }
</span></span></span><span class="line"><span class="cl"><span class="sd">        }</span><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">aws-alb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">game2048s.xiaosi.host</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">game2048s.xiaosi.host</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http-301</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">use-annotation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">game2048s.xiaosi.host</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-2048-alb-https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">use-annotation</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="后端地址类型" class="heading-element">
  <a href="#%e5%90%8e%e7%ab%af%e5%9c%b0%e5%9d%80%e7%b1%bb%e5%9e%8b" class="heading-mark"></a>后端地址类型</h3><p><code>alb.ingress.kubernetes.io/target-type</code> 标签值指定<code>alb</code>通过何种方式把流量转发到后端。有以下值</p>
<ul>
<li><code>instance</code>: 流量转发到<code>EC2</code>实例<code>IP</code>，使用该方式 <code>service</code> 类型必须是 <code>NodePort</code> 方式</li>
<li><code>ip</code>: 流量直接转发到 <code>pod IP</code></li>
</ul>
<h3 id="alb-属性" class="heading-element">
  <a href="#alb-%e5%b1%9e%e6%80%a7" class="heading-mark"></a>alb 属性</h3><p><code>alb.ingress.kubernetes.io/load-balancer-attributes</code> 指定<a href="https://docs.aws.amazon.com/zh_cn/elasticloadbalancing/latest/APIReference/API_LoadBalancerAttribute.html"target="_blank" rel="external nofollow noopener noreferrer">负载均衡器属性</a></p>
<h3 id="目标组属性" class="heading-element">
  <a href="#%e7%9b%ae%e6%a0%87%e7%bb%84%e5%b1%9e%e6%80%a7" class="heading-mark"></a>目标组属性</h3><p><code>alb.ingress.kubernetes.io/target-group-attributes</code> 指定<a href="https://docs.aws.amazon.com/zh_cn/elasticloadbalancing/latest/application/load-balancer-target-groups.html#target-group-attributes"target="_blank" rel="external nofollow noopener noreferrer">alb 目标组属性</a></p>
<h3 id="目标组健康检查" class="heading-element">
  <a href="#%e7%9b%ae%e6%a0%87%e7%bb%84%e5%81%a5%e5%ba%b7%e6%a3%80%e6%9f%a5" class="heading-mark"></a>目标组健康检查</h3><ul>
<li><code>alb.ingress.kubernetes.io/healthcheck-protocol</code>: 指定使用协议，值为 <code>HTTPS</code> 或 <code>HTTP</code></li>
<li><code>alb.ingress.kubernetes.io/healthcheck-port</code>: 指定目标检测端口，有以下值
<ul>
<li>指定一个<code>tcp</code>端口，如 <code>80</code></li>
<li><code>traffic-port</code>: （默认值）<code>alb.ingress.kubernetes.io/target-type: instance</code> 且 <code>k8s sevice</code> 类型为 <code>NodePort</code> 时自动获取端口</li>
<li><code>my-port</code>: <code>alb.ingress.kubernetes.io/target-type</code> 值为 <code>instance</code> 或 <code>ip</code> 时自动获取端口</li>
</ul>
</li>
<li><code>alb.ingress.kubernetes.io/healthcheck-path</code>: 指定请求路径</li>
<li><code>alb.ingress.kubernetes.io/healthcheck-interval-seconds</code>: 指定健康检查时间间隔，单位为秒</li>
<li><code>alb.ingress.kubernetes.io/healthcheck-timeout-seconds</code>: 指定健康检查超时时间，单位为秒</li>
<li><code>alb.ingress.kubernetes.io/success-codes</code>: 指定健康检查正常响应码，如 <code>200</code>。多种响应码使用逗号分隔，如<code>200,201</code>。如果是连续的，可以使用连字符，如 <code>200-230</code></li>
<li><code>alb.ingress.kubernetes.io/healthy-threshold-count</code>: 连续多少次探测成功视为健康</li>
<li><code>alb.ingress.kubernetes.io/unhealthy-threshold-count</code>: 连续多少次探测失败视为不健康</li>
</ul>
<h3 id="tls" class="heading-element">
  <a href="#tls" class="heading-mark"></a>TLS</h3><p><code>alb.ingress.kubernetes.io/certificate-arn</code>: 指定 <code>tls</code> 证书地址，该证书地址必须是 <a href="https://docs.aws.amazon.com/zh_cn/acm/latest/userguide/import-certificate.html"target="_blank" rel="external nofollow noopener noreferrer">AWS Certificate Manager</a> 生成的<code>ARN</code>地址。多个地址使用逗号分隔</p>
<p>它等效以下<code>alb.ingress.kubernetes.io/actions</code>规则</p>
<div class="highlight" id="id-41"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">    alb.ingress.kubernetes.io/listen-ports: <span class="p">|</span>
</span></span><span class="line"><span class="cl">      <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span><span class="s2">&#34;HTTP&#34;</span>: 80<span class="o">}</span>,
</span></span><span class="line"><span class="cl">        <span class="o">{</span><span class="s2">&#34;HTTPS&#34;</span>: 443<span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">]</span>
</span></span><span class="line"><span class="cl">    alb.ingress.kubernetes.io/actions.http-301: <span class="p">|</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;Type&#34;</span>: <span class="s2">&#34;redirect&#34;</span>,
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;RedirectConfig&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Protocol&#34;</span>: <span class="s2">&#34;HTTPS&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Port&#34;</span>: <span class="s2">&#34;443&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Host&#34;</span>: <span class="s2">&#34;#{host}&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Path&#34;</span>: <span class="s2">&#34;/#{path}&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Query&#34;</span>: <span class="s2">&#34;#{query}&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;StatusCode&#34;</span>: <span class="s2">&#34;HTTP_301&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="alb-http-示例一" class="heading-element">
  <a href="#alb-http-%e7%a4%ba%e4%be%8b%e4%b8%80" class="heading-mark"></a>ALB HTTP 示例一</h2><p>创建 <code>IngressClass</code></p>
<div class="highlight" id="id-42"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># cat albIngressClass.yaml</span>
</span></span><span class="line"><span class="cl">apiVersion: networking.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: IngressClass
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app.kubernetes.io/name: aws-load-balancer-controller
</span></span><span class="line"><span class="cl">  name: aws-alb
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  controller: ingress.k8s.aws/alb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># zjcSingaporeYh apply -f albIngressClass.yaml</span>
</span></span><span class="line"><span class="cl">ingressclass.networking.k8s.io/aws-alb unchanged</span></span></code></pre></td></tr></table>
</div>
</div><p>创建示例应用</p>
<div class="highlight" id="id-43"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># cat alb-http.yaml</span>
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Namespace
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: game-2048-alb-http
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: Deployment
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  namespace: game-2048-alb-http
</span></span><span class="line"><span class="cl">  name: deployment-2048-alb-http
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app.kubernetes.io/name: app-2048-alb-http
</span></span><span class="line"><span class="cl">  replicas: <span class="m">5</span>
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app.kubernetes.io/name: app-2048-alb-http
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      affinity:
</span></span><span class="line"><span class="cl">        nodeAffinity:
</span></span><span class="line"><span class="cl">          requiredDuringSchedulingIgnoredDuringExecution:
</span></span><span class="line"><span class="cl">            nodeSelectorTerms:
</span></span><span class="line"><span class="cl">            - matchExpressions:
</span></span><span class="line"><span class="cl">              - key: alpha.eksctl.io/nodegroup-name
</span></span><span class="line"><span class="cl">                operator: In
</span></span><span class="line"><span class="cl">                values:
</span></span><span class="line"><span class="cl">                - <span class="nb">test</span>
</span></span><span class="line"><span class="cl">      tolerations:
</span></span><span class="line"><span class="cl">      - key: <span class="s2">&#34;zone&#34;</span>
</span></span><span class="line"><span class="cl">        value: <span class="s2">&#34;ap-southeast-1a&#34;</span>
</span></span><span class="line"><span class="cl">        operator: <span class="s2">&#34;Equal&#34;</span>
</span></span><span class="line"><span class="cl">      - key: <span class="s2">&#34;application&#34;</span>
</span></span><span class="line"><span class="cl">        value: <span class="s2">&#34;test&#34;</span>
</span></span><span class="line"><span class="cl">        operator: <span class="s2">&#34;Equal&#34;</span>
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - image: public.ecr.aws/l6m2t8p7/docker-2048:latest
</span></span><span class="line"><span class="cl">        imagePullPolicy: Always
</span></span><span class="line"><span class="cl">        name: app-2048-alb-http
</span></span><span class="line"><span class="cl">        ports:
</span></span><span class="line"><span class="cl">        - containerPort: <span class="m">80</span>
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  namespace: game-2048-alb-http
</span></span><span class="line"><span class="cl">  name: service-2048-alb-http
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">  - name: http
</span></span><span class="line"><span class="cl">    port: <span class="m">80</span>
</span></span><span class="line"><span class="cl">    targetPort: <span class="m">80</span>
</span></span><span class="line"><span class="cl">    protocol: TCP
</span></span><span class="line"><span class="cl">  type: LoadBalancer
</span></span><span class="line"><span class="cl">  loadBalancerClass: service.k8s.aws/alb
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app.kubernetes.io/name: app-2048-alb-http
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: networking.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: Ingress
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  namespace: game-2048-alb-http
</span></span><span class="line"><span class="cl">  name: ingress-2048-alb-http
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    alb.ingress.kubernetes.io/tags: <span class="nv">user</span><span class="o">=</span>xiaosi,protocol<span class="o">=</span>http
</span></span><span class="line"><span class="cl">    alb.ingress.kubernetes.io/scheme: internet-facing
</span></span><span class="line"><span class="cl">    alb.ingress.kubernetes.io/target-type: ip
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  ingressClassName: aws-alb
</span></span><span class="line"><span class="cl">  rules:
</span></span><span class="line"><span class="cl">  - host: game2048.xiaosi.host
</span></span><span class="line"><span class="cl">    http:
</span></span><span class="line"><span class="cl">      paths:
</span></span><span class="line"><span class="cl">      - path: /
</span></span><span class="line"><span class="cl">        pathType: Prefix
</span></span><span class="line"><span class="cl">        backend:
</span></span><span class="line"><span class="cl">          service:
</span></span><span class="line"><span class="cl">            name: service-2048-alb-http
</span></span><span class="line"><span class="cl">            port:
</span></span><span class="line"><span class="cl">              name: http
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># zjcSingaporeYh apply -f alb-http.yaml</span>
</span></span><span class="line"><span class="cl">namespace/game-2048-alb-http unchanged
</span></span><span class="line"><span class="cl">deployment.apps/deployment-2048-alb-http unchanged
</span></span><span class="line"><span class="cl">service/service-2048-alb-http unchanged
</span></span><span class="line"><span class="cl">ingress.networking.k8s.io/ingress-2048-alb-http unchanged</span></span></code></pre></td></tr></table>
</div>
</div><p>查看<code>alb dns</code>，域名解析<code>cnaame</code> 到该 <code>DNS</code></p>
<div class="highlight" id="id-44"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># zjcSingaporeYh -n game-2048-alb-http get ingress ingress-2048-alb-http -o json | jq &#39;.status.loadBalancer&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;ingress&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;hostname&#34;</span>: <span class="s2">&#34;k8s-game2048-ingress2-fd8e68509a-912052858.ap-southeast-1.elb.amazonaws.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># curl -I game2048.xiaosi.host</span>
</span></span><span class="line"><span class="cl">HTTP/1.1 <span class="m">200</span> OK
</span></span><span class="line"><span class="cl">Date: Tue, <span class="m">01</span> Aug <span class="m">2023</span> 08:55:31 GMT
</span></span><span class="line"><span class="cl">Content-Type: text/html
</span></span><span class="line"><span class="cl">Content-Length: <span class="m">3988</span>
</span></span><span class="line"><span class="cl">Connection: keep-alive
</span></span><span class="line"><span class="cl">Server: nginx
</span></span><span class="line"><span class="cl">Last-Modified: Wed, <span class="m">06</span> Oct <span class="m">2021</span> 17:35:37 GMT
</span></span><span class="line"><span class="cl">ETag: <span class="s2">&#34;615dde69-f94&#34;</span>
</span></span><span class="line"><span class="cl">Accept-Ranges: bytes</span></span></code></pre></td></tr></table>
</div>
</div><p>清理资源</p>
<div class="highlight" id="id-45"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># zjcSingaporeYh delete -f alb-http.yaml</span>
</span></span><span class="line"><span class="cl">namespace <span class="s2">&#34;game-2048-alb-http&#34;</span> deleted
</span></span><span class="line"><span class="cl">deployment.apps <span class="s2">&#34;deployment-2048-alb-http&#34;</span> deleted
</span></span><span class="line"><span class="cl">service <span class="s2">&#34;service-2048-alb-http&#34;</span> deleted
</span></span><span class="line"><span class="cl">ingress.networking.k8s.io <span class="s2">&#34;ingress-2048-alb-http&#34;</span> deleted</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="alb-https-示例一" class="heading-element">
  <a href="#alb-https-%e7%a4%ba%e4%be%8b%e4%b8%80" class="heading-mark"></a>ALB HTTPS 示例一</h2><p>部署 <code>IngressClass</code></p>
<div class="highlight" id="id-46"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost yh-eks<span class="o">]</span><span class="c1"># cat albIngressClass.yaml</span>
</span></span><span class="line"><span class="cl">apiVersion: networking.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: IngressClass
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app.kubernetes.io/name: aws-load-balancer-controller
</span></span><span class="line"><span class="cl">  name: aws-alb
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  controller: ingress.k8s.aws/alb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost yh-eks<span class="o">]</span><span class="c1"># zjcSingaporeYh apply -f albIngressClass.yaml</span>
</span></span><span class="line"><span class="cl">ingressclass.networking.k8s.io/aws-alb unchanged</span></span></code></pre></td></tr></table>
</div>
</div><p>在<a href="https://console.aws.amazon.com/acm/home"target="_blank" rel="external nofollow noopener noreferrer">ACM 控制台</a>中上传<code>TLS</code>证书，获取到<code>ARN</code>地址</p>
<p>创建资源</p>
<div class="highlight" id="id-47"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost yh-eks<span class="o">]</span><span class="c1"># cat albIngressClass.yaml</span>
</span></span><span class="line"><span class="cl">apiVersion: networking.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: IngressClass
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app.kubernetes.io/name: aws-load-balancer-controller
</span></span><span class="line"><span class="cl">  name: aws-alb
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  controller: ingress.k8s.aws/alb
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost yh-eks<span class="o">]</span><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost yh-eks<span class="o">]</span><span class="c1"># cat alb-https.yaml</span>
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Namespace
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: game-2048-alb-https
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: Deployment
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  namespace: game-2048-alb-https
</span></span><span class="line"><span class="cl">  name: deployment-2048-alb-https
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app.kubernetes.io/name: app-2048-alb-https
</span></span><span class="line"><span class="cl">  replicas: <span class="m">5</span>
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app.kubernetes.io/name: app-2048-alb-https
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      affinity:
</span></span><span class="line"><span class="cl">        nodeAffinity:
</span></span><span class="line"><span class="cl">          requiredDuringSchedulingIgnoredDuringExecution:
</span></span><span class="line"><span class="cl">            nodeSelectorTerms:
</span></span><span class="line"><span class="cl">            - matchExpressions:
</span></span><span class="line"><span class="cl">              - key: alpha.eksctl.io/nodegroup-name
</span></span><span class="line"><span class="cl">                operator: In
</span></span><span class="line"><span class="cl">                values:
</span></span><span class="line"><span class="cl">                - <span class="nb">test</span>
</span></span><span class="line"><span class="cl">      tolerations:
</span></span><span class="line"><span class="cl">      - key: <span class="s2">&#34;zone&#34;</span>
</span></span><span class="line"><span class="cl">        value: <span class="s2">&#34;ap-southeast-1a&#34;</span>
</span></span><span class="line"><span class="cl">        operator: <span class="s2">&#34;Equal&#34;</span>
</span></span><span class="line"><span class="cl">      - key: <span class="s2">&#34;application&#34;</span>
</span></span><span class="line"><span class="cl">        value: <span class="s2">&#34;test&#34;</span>
</span></span><span class="line"><span class="cl">        operator: <span class="s2">&#34;Equal&#34;</span>
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - image: public.ecr.aws/l6m2t8p7/docker-2048:latest
</span></span><span class="line"><span class="cl">        imagePullPolicy: Always
</span></span><span class="line"><span class="cl">        name: app-2048-alb-https
</span></span><span class="line"><span class="cl">        ports:
</span></span><span class="line"><span class="cl">        - containerPort: <span class="m">80</span>
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  namespace: game-2048-alb-https
</span></span><span class="line"><span class="cl">  name: service-2048-alb-https
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">  - name: use-annotation
</span></span><span class="line"><span class="cl">    port: <span class="m">80</span>
</span></span><span class="line"><span class="cl">    targetPort: <span class="m">80</span>
</span></span><span class="line"><span class="cl">    protocol: TCP
</span></span><span class="line"><span class="cl">  type: LoadBalancer
</span></span><span class="line"><span class="cl">  loadBalancerClass: service.k8s.aws/alb
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app.kubernetes.io/name: app-2048-alb-https
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: networking.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: Ingress
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  namespace: game-2048-alb-https
</span></span><span class="line"><span class="cl">  name: ingress-2048-alb-https
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    alb.ingress.kubernetes.io/tags: <span class="nv">user</span><span class="o">=</span>xiaosi
</span></span><span class="line"><span class="cl">    alb.ingress.kubernetes.io/scheme: internet-facing
</span></span><span class="line"><span class="cl">    alb.ingress.kubernetes.io/target-type: ip
</span></span><span class="line"><span class="cl">    alb.ingress.kubernetes.io/certificate-arn: <span class="p">|</span>
</span></span><span class="line"><span class="cl">      arn:aws:acm:ap-southeast-1:968767926216:certificate/3487a0a2-c072-4eac-8da5-3d3c0f02275e
</span></span><span class="line"><span class="cl">    alb.ingress.kubernetes.io/listen-ports: <span class="p">|</span>
</span></span><span class="line"><span class="cl">      <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span><span class="s2">&#34;HTTP&#34;</span>: 80<span class="o">}</span>,
</span></span><span class="line"><span class="cl">        <span class="o">{</span><span class="s2">&#34;HTTPS&#34;</span>: 443<span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">]</span>
</span></span><span class="line"><span class="cl">    alb.ingress.kubernetes.io/actions.service-2048-alb-https: <span class="p">|</span>
</span></span><span class="line"><span class="cl">      <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;Type&#34;</span>: <span class="s2">&#34;redirect&#34;</span>,
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;RedirectConfig&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;Protocol&#34;</span>: <span class="s2">&#34;HTTPS&#34;</span>,
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;Port&#34;</span>: <span class="s2">&#34;443&#34;</span>,
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;Host&#34;</span>: <span class="s2">&#34;#{host}&#34;</span>,
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;Path&#34;</span>: <span class="s2">&#34;/#{path}&#34;</span>,
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;Query&#34;</span>: <span class="s2">&#34;#{query}&#34;</span>,
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;StatusCode&#34;</span>: <span class="s2">&#34;HTTP_301&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  ingressClassName: aws-alb
</span></span><span class="line"><span class="cl">  rules:
</span></span><span class="line"><span class="cl">  - host: game2048s.xiaosi.host
</span></span><span class="line"><span class="cl">    http:
</span></span><span class="line"><span class="cl">      paths:
</span></span><span class="line"><span class="cl">      - path: /
</span></span><span class="line"><span class="cl">        pathType: Prefix
</span></span><span class="line"><span class="cl">        backend:
</span></span><span class="line"><span class="cl">          service:
</span></span><span class="line"><span class="cl">            name: service-2048-alb-https
</span></span><span class="line"><span class="cl">            port:
</span></span><span class="line"><span class="cl">              name: use-annotation
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost yh-eks<span class="o">]</span><span class="c1"># zjcSingaporeYh apply -f alb-https.yaml</span>
</span></span><span class="line"><span class="cl">namespace/game-2048-alb-https created
</span></span><span class="line"><span class="cl">deployment.apps/deployment-2048-alb-https created
</span></span><span class="line"><span class="cl">service/service-2048-alb-https created
</span></span><span class="line"><span class="cl">ingress.networking.k8s.io/ingress-2048-alb-https created</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="定义-aws-nlb-资源" class="heading-element">
  <a href="#%e5%ae%9a%e4%b9%89-aws-nlb-%e8%b5%84%e6%ba%90" class="heading-mark"></a>定义 AWS NLB 资源</h2><p><code>Service.metadata.annotations</code>可用注解在<a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.5/guide/service/annotations/"target="_blank" rel="external nofollow noopener noreferrer">AWS Load Balancer Controller Service Annotations</a>查看完整说明，使用<code>ELB</code>(<code>Network Load Balancers</code>)有以下注意事项</p>
<ul>
<li><code>Service.spec.loadBalancerClass</code>: 指定为 <code>ingress.k8s.aws/nlb</code></li>
</ul>
<h3 id="资源标签-1" class="heading-element">
  <a href="#%e8%b5%84%e6%ba%90%e6%a0%87%e7%ad%be-1" class="heading-mark"></a>资源标签</h3><h3 id="是否公有-1" class="heading-element">
  <a href="#%e6%98%af%e5%90%a6%e5%85%ac%e6%9c%89-1" class="heading-mark"></a>是否公有</h3><p><code>service.beta.kubernetes.io/aws-load-balancer-scheme</code> 注解有以下值：</p>
<ul>
<li><code>internet-facing</code>: 表示面向互联网</li>
<li><code>internal</code>: 面向内部，即私有子网</li>
</ul>
<h3 id="后端地址类型-1" class="heading-element">
  <a href="#%e5%90%8e%e7%ab%af%e5%9c%b0%e5%9d%80%e7%b1%bb%e5%9e%8b-1" class="heading-mark"></a>后端地址类型</h3><p><code>service.beta.kubernetes.io/aws-load-balancer-nlb-target-type</code> 标签值指定<code>nlb</code>通过何种方式把流量转发到后端。有以下值</p>
<ul>
<li><code>instance</code>: 流量转发到<code>EC2</code>实例<code>IP</code>，使用该方式 <code>service</code> 类型必须是 <code>NodePort</code> 方式</li>
<li><code>ip</code>: 流量直接转发到 <code>pod IP</code></li>
</ul>
<h3 id="路由子网" class="heading-element">
  <a href="#%e8%b7%af%e7%94%b1%e5%ad%90%e7%bd%91" class="heading-mark"></a>路由子网</h3><p><code>service.beta.kubernetes.io/aws-load-balancer-subnets</code> 注解指定面向上游请求的子网<code>ID</code>，如面向公网，则指定公有子网。默认请问下会根据后端服务可用区自动识别可用子网</p>
<div class="highlight" id="id-48"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">service.beta.kubernetes.io/aws-load-balancer-subnets</span><span class="p">:</span><span class="w"> </span><span class="l">subnet-0d3e58597af009c84</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="公网-ip" class="heading-element">
  <a href="#%e5%85%ac%e7%bd%91-ip" class="heading-mark"></a>公网 IP</h3><p>默认情况下，<code>AWS</code> 随机分配公网 <code>IP</code> 地址。可以通过<code>service.beta.kubernetes.io/aws-load-balancer-eip-allocations</code> 注解指定弹性<code>elb</code>使用的<code>EIP ID</code>来分配固定<code>IP</code>，有以下注意事项</p>
<ul>
<li><code>service.beta.kubernetes.io/aws-load-balancer-scheme</code> 注解值必须是<code>internet-facing</code></li>
<li><code>EIP</code>数量必须与<code>nlb</code>路由公有子网数量相同，多个<code>EIP ID</code> 使用逗号分隔</li>
</ul>
<p>下面是个示例</p>
<div class="highlight" id="id-49"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost yh-eks<span class="o">]</span><span class="c1"># cat nlb-service.yaml</span>
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  namespace: nlb-nginx
</span></span><span class="line"><span class="cl">  name: service-nlb
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
</span></span><span class="line"><span class="cl">    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
</span></span><span class="line"><span class="cl">    service.beta.kubernetes.io/aws-load-balancer-type: external
</span></span><span class="line"><span class="cl">    service.beta.kubernetes.io/aws-load-balancer-subnets: subnet-0d3e58597af009c84
</span></span><span class="line"><span class="cl">    service.beta.kubernetes.io/aws-load-balancer-eip-allocations: eipalloc-07ceee1a128133e5f
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">  - name: tcp
</span></span><span class="line"><span class="cl">    port: <span class="m">80</span>
</span></span><span class="line"><span class="cl">    targetPort: <span class="m">80</span>
</span></span><span class="line"><span class="cl">    protocol: TCP
</span></span><span class="line"><span class="cl">  type: LoadBalancer
</span></span><span class="line"><span class="cl">  loadBalancerClass: service.k8s.aws/nlb
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app: nginx</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="nlb-属性" class="heading-element">
  <a href="#nlb-%e5%b1%9e%e6%80%a7" class="heading-mark"></a>nlb 属性</h3><p><code>service.beta.kubernetes.io/aws-load-balancer-attributes</code> 指定<a href="https://docs.aws.amazon.com/zh_cn/elasticloadbalancing/latest/APIReference/API_LoadBalancerAttribute.html"target="_blank" rel="external nofollow noopener noreferrer">负载均衡器属性</a></p>
<div class="highlight" id="id-50"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">service.beta.kubernetes.io/aws-load-balancer-attributes: access_logs.s3.enabled<span class="o">=</span>true,access_logs.s3.bucket<span class="o">=</span>my-access-log-bucket,access_logs.s3.prefix<span class="o">=</span>my-app</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="目标组属性-1" class="heading-element">
  <a href="#%e7%9b%ae%e6%a0%87%e7%bb%84%e5%b1%9e%e6%80%a7-1" class="heading-mark"></a>目标组属性</h3><p><code>service.beta.kubernetes.io/aws-load-balancer-target-group-attributes</code> 指定<a href="https://docs.aws.amazon.com/zh_cn/elasticloadbalancing/latest/network/load-balancer-target-groups.html#target-group-attributes"target="_blank" rel="external nofollow noopener noreferrer">nlb 目标组属性</a></p>
<div class="highlight" id="id-51"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">stickiness.enabled=true,stickiness.type=source_ip</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="目标组健康检查-1" class="heading-element">
  <a href="#%e7%9b%ae%e6%a0%87%e7%bb%84%e5%81%a5%e5%ba%b7%e6%a3%80%e6%9f%a5-1" class="heading-mark"></a>目标组健康检查</h3><ul>
<li><code>service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol</code>: 指定与后端服务进行健康检查使用的协议
<ul>
<li>可用值有 <code>tcp</code>（默认值）、<code>http</code>、<code>https</code></li>
<li>当 <code>Service.spec.externalTrafficPolicy: Cluster</code> 默认值为 <code>tcp</code></li>
<li>当 <code>Service.spec.externalTrafficPolicy: Local</code> 值不能为 <code>tcp</code>，它默认值为 <code>http</code></li>
</ul>
</li>
<li><code>service.beta.kubernetes.io/aws-load-balancer-healthcheck-port</code>: 指定与后端服务进行检查检查使用的端口</li>
<li><code>service.beta.kubernetes.io/aws-load-balancer-healthcheck-healthy-threshold</code>: 连续多少次探测成功视为健康</li>
<li><code>service.beta.kubernetes.io/aws-load-balancer-healthcheck-unhealthy-threshold</code>: 连续多少次探测失败视为不健康</li>
<li><code>service.beta.kubernetes.io/aws-load-balancer-healthcheck-interval</code>: 指定健康检查时间间隔，单位为秒</li>
<li><code>service.beta.kubernetes.io/aws-load-balancer-healthcheck-timeout</code>: 指定健康检查超时时间，单位为秒</li>
<li><code>service.beta.kubernetes.io/aws-load-balancer-healthcheck-path</code>: 指定<code>http[s]</code>检测路径，默认值为<code>/healthz</code></li>
<li><code>service.beta.kubernetes.io/aws-load-balancer-healthcheck-success-codes</code>: 指定<code>http[s]</code> 指定健康检查正常响应码，如 <code>200</code>。多种响应码使用逗号分隔，如<code>200,201</code>。如果是连续的，可以使用连字符，如 <code>200-230</code></li>
<li><code>service.beta.kubernetes.io/aws-load-balancer-ssl-cert</code>: 与后端服务使用<code>HTTPS</code>进行健康时使用的<code>TLS</code>证书地址，该证书地址必须是 <a href="https://docs.aws.amazon.com/zh_cn/acm/latest/userguide/import-certificate.html"target="_blank" rel="external nofollow noopener noreferrer">AWS Certificate Manager</a> 生成的<code>ARN</code>地址。多个地址使用逗号分隔</li>
</ul>
<h2 id="nlb-示例" class="heading-element">
  <a href="#nlb-%e7%a4%ba%e4%be%8b" class="heading-mark"></a>NLB 示例</h2><p><code>NLB</code> 由 <code>service</code> 资源引用，以下是示例</p>
<div class="highlight" id="id-52"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="p">[</span><span class="l">root@localhost AwsLoadBalancerController]# cat game-2048-elb.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">game-2048-elb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">game-2048-elb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">deployment-2048-elb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">app-2048-elb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">app-2048-elb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">alpha.eksctl.io/nodegroup-name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;zone&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ap-southeast-1a&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Equal&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;application&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;test&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Equal&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">public.ecr.aws/l6m2t8p7/docker-2048:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-2048-elb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tcp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">game-2048-elb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-2048-elb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service.beta.kubernetes.io/aws-load-balancer-type</span><span class="p">:</span><span class="w"> </span><span class="l">external</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service.beta.kubernetes.io/aws-load-balancer-nlb-target-type</span><span class="p">:</span><span class="w"> </span><span class="l">ip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service.beta.kubernetes.io/aws-load-balancer-scheme</span><span class="p">:</span><span class="w"> </span><span class="l">internet-facing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">app-2048-elb</span></span></span></code></pre></td></tr></table>
</div>
</div><p>部署资源</p>
<div class="highlight" id="id-53"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># zjcSingaporeYh apply -f game-2048-elb.yaml</span>
</span></span><span class="line"><span class="cl">namespace/game-2048-elb unchanged
</span></span><span class="line"><span class="cl">deployment.apps/deployment-2048-elb unchanged
</span></span><span class="line"><span class="cl">service/service-2048-elb created</span></span></code></pre></td></tr></table>
</div>
</div><p>检查资源运行状况</p>
<div class="highlight" id="id-54"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># zjcSingaporeYh -n game-2048-elb get pod,service</span>
</span></span><span class="line"><span class="cl">NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod/deployment-2048-elb-7ff4bc8674-4vh8j   1/1     Running   <span class="m">0</span>          11m
</span></span><span class="line"><span class="cl">pod/deployment-2048-elb-7ff4bc8674-8l5w5   1/1     Running   <span class="m">0</span>          11m
</span></span><span class="line"><span class="cl">pod/deployment-2048-elb-7ff4bc8674-bsxg2   1/1     Running   <span class="m">0</span>          11m
</span></span><span class="line"><span class="cl">pod/deployment-2048-elb-7ff4bc8674-gl5rt   1/1     Running   <span class="m">0</span>          11m
</span></span><span class="line"><span class="cl">pod/deployment-2048-elb-7ff4bc8674-ktlk5   1/1     Running   <span class="m">0</span>          11m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                       TYPE           CLUSTER-IP      EXTERNAL-IP                                                                          PORT<span class="o">(</span>S<span class="o">)</span>        AGE
</span></span><span class="line"><span class="cl">service/service-2048-elb   LoadBalancer   10.100.10.216   k8s-game2048-service2-45fa707215-5dcf47f226fcbff8.elb.ap-southeast-1.amazonaws.com   80:30018/TCP   9m51s</span></span></code></pre></td></tr></table>
</div>
</div><p>尝试请求</p>
<div class="highlight" id="id-55"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost AwsLoadBalancerController<span class="o">]</span><span class="c1"># curl -I k8s-game2048-service2-45fa707215-5dcf47f226fcbff8.elb.ap-southeast-1.amazonaws.com</span>
</span></span><span class="line"><span class="cl">HTTP/1.1 <span class="m">200</span> OK
</span></span><span class="line"><span class="cl">Server: nginx
</span></span><span class="line"><span class="cl">Date: Fri, <span class="m">28</span> Jul <span class="m">2023</span> 14:36:11 GMT
</span></span><span class="line"><span class="cl">Content-Type: text/html
</span></span><span class="line"><span class="cl">Content-Length: <span class="m">3988</span>
</span></span><span class="line"><span class="cl">Last-Modified: Wed, <span class="m">06</span> Oct <span class="m">2021</span> 17:35:37 GMT
</span></span><span class="line"><span class="cl">Connection: keep-alive
</span></span><span class="line"><span class="cl">ETag: <span class="s2">&#34;615dde69-f94&#34;</span>
</span></span><span class="line"><span class="cl">Accept-Ranges: bytes</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="控制层面日志" class="heading-element">
  <a href="#%e6%8e%a7%e5%88%b6%e5%b1%82%e9%9d%a2%e6%97%a5%e5%bf%97" class="heading-mark"></a>控制层面日志</h1><p>集群控制层面日志不会发送到 <code>CloudWatch Logs</code> 中。必须单独启用每个日志类型来为集群发送日志</p>
<div class="highlight" id="id-56"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 版本必须大于 16.139</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># aws --version</span>
</span></span><span class="line"><span class="cl">aws-cli/2.13.1 Python/3.11.4 Linux/3.10.0-1160.92.1.el7.x86_64 exe/x86_64.centos.7 prompt/off</span></span></code></pre></td></tr></table>
</div>
</div><p>以下集群控制层面日志类型可用。每个日志类型对应一个 Kubernetes 控制面板组件</p>
<ul>
<li><code>api</code>: 集群的 <code>API server</code></li>
<li><code>audit</code>:  审计日志提供单个用户、管理员或影响集群的系统组件的记录</li>
<li><code>authenticator</code>: 身份验证器日志对于 <code>Amazon</code> <code>EKS</code> 是唯一的。这些日志代表 <code>Amazon</code> <code>EKS</code> 使用 <code>IAM</code> 凭证用于 <code>Kubernetes</code> 基于角色的访问控制 (<code>RBAC</code>, <code>Role</code> <code>based</code> <code>access</code> <code>control</code>) 身份验证的控制面板组件</li>
<li><code>controllerManager</code>: <code> kube-controller-manager</code> 日志</li>
<li><code>scheduler</code>: <code>kube-scheduler</code>日志</li>
</ul>
<p>使用 <code>aws</code> 命令启用相关日志</p>
<div class="highlight" id="id-57"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># aws eks update-cluster-config \</span>
</span></span><span class="line"><span class="cl">--profile <span class="s2">&#34;zjc-yuhai&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--region <span class="s2">&#34;ap-southeast-1&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--name <span class="s2">&#34;yh-eks&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--logging <span class="s1">&#39;{&#34;clusterLogging&#34;:[{&#34;types&#34;:[&#34;api&#34;,&#34;audit&#34;,&#34;authenticator&#34;,&#34;controllerManager&#34;,&#34;scheduler&#34;],&#34;enabled&#34;:true}]}&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;update&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;id&#34;</span>: <span class="s2">&#34;53156b6d-3417-4975-ae32-06acc9614767&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;status&#34;</span>: <span class="s2">&#34;InProgress&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;LoggingUpdate&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;params&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;ClusterLogging&#34;</span>,
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;value&#34;</span>: <span class="s2">&#34;{\&#34;clusterLogging\&#34;:[{\&#34;types\&#34;:[\&#34;api\&#34;,\&#34;audit\&#34;,\&#34;authenticator\&#34;,\&#34;controllerManager\&#34;,\&#34;scheduler\&#34;],\&#34;enabled\&#34;:true}]}&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">]</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;createdAt&#34;</span>: <span class="s2">&#34;2023-07-30T15:26:03.362000+08:00&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;errors&#34;</span>: <span class="o">[]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可以根据上面的<code>.update.id</code> 字段值查看状态，当 <code>update.status</code> 字段值为 <code>Successful</code> 表示成功。可以在相同区域中 的<code>CloudWatch</code> 日志组（<code>/aws/eks/eksname/cluster</code>）查看日志</p>
<div class="highlight" id="id-58"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># aws eks describe-update \</span>
</span></span><span class="line"><span class="cl">--profile <span class="s2">&#34;zjc-yuhai&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--region <span class="s2">&#34;ap-southeast-1&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--name <span class="s2">&#34;yh-eks&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--update-id <span class="s2">&#34;53156b6d-3417-4975-ae32-06acc9614767&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;update&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;id&#34;</span>: <span class="s2">&#34;53156b6d-3417-4975-ae32-06acc9614767&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;status&#34;</span>: <span class="s2">&#34;Successful&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;LoggingUpdate&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;params&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;ClusterLogging&#34;</span>,
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;value&#34;</span>: <span class="s2">&#34;{\&#34;clusterLogging\&#34;:[{\&#34;types\&#34;:[\&#34;api\&#34;,\&#34;audit\&#34;,\&#34;authenticator\&#34;,\&#34;controllerManager\&#34;,\&#34;scheduler\&#34;],\&#34;enabled\&#34;:true}]}&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">]</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;createdAt&#34;</span>: <span class="s2">&#34;2023-07-30T15:26:03.362000+08:00&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;errors&#34;</span>: <span class="o">[]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h1 id="error" class="heading-element">
  <a href="#error" class="heading-mark"></a>ERROR</h1><h2 id="failed-build-model-due-to-unable-to-resolve-at-least-one-subnet-0-match-vpc-and-tags" class="heading-element">
  <a href="#failed-build-model-due-to-unable-to-resolve-at-least-one-subnet-0-match-vpc-and-tags" class="heading-mark"></a>Failed build model due to unable to resolve at least one subnet (0 match VPC and tags)</h2><ul>
<li>
<p>错误情况</p>
<ul>
<li><code>LoadBalancer</code> 处于 <code>pending</code> 状态</li>
</ul>
<div class="highlight" id="id-59"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost prometheus<span class="o">]</span><span class="c1"># kubectl get -f grafanaService.yaml</span>
</span></span><span class="line"><span class="cl">NAME      TYPE           CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
</span></span><span class="line"><span class="cl">grafana   LoadBalancer   172.20.127.75   &lt;pending&gt;     80:31943/TCP   87s</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>事件显示没有指定<code>vpc</code>子网</li>
</ul>
<div class="highlight" id="id-60"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost prometheus<span class="o">]</span><span class="c1"># kubectl describe service grafana -n prometheus</span>
</span></span><span class="line"><span class="cl">Name:                     grafana
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type     Reason            Age   From     Message
</span></span><span class="line"><span class="cl">  ----     ------            ----  ----     -------
</span></span><span class="line"><span class="cl">  Warning  FailedBuildModel  118s  service  Failed build model due to unable to resolve at least one subnet <span class="o">(</span><span class="m">0</span> match VPC and tags<span class="o">)</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>原因：子网缺少以下标签，<code>aws-load-balancer-controller</code>自动识别子网失败</p>
<ul>
<li>私有子网：<code>kubernetes.io/role/internal-elb: 1</code></li>
<li>公有子网：<code>kubernetes.io/role/elb: 1</code></li>
</ul>
</li>
<li>
<p>解决：对应子网添加相应标签后，重新部署资源</p>
</li>
</ul>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2024-02-03 14:48:49">更新于 2024-02-03&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/eks/" class="post-tag" title="标签 - eks">eks</a><a href="/tags/aws/" class="post-tag" title="标签 - aws">aws</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/calicoForKubernets/" class="post-nav-item" rel="prev" title="k8s 网络插件 calico"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>k8s 网络插件 calico</a>
      <a href="/awsEksctl/" class="post-nav-item" rel="next" title="eksctl">eksctl<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.115.3"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.1"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2022 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/pangu/pangu.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"lightgallery":true,"pangu":{"enable":true,"selector":"article"},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":true,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.3,"type":"fuse","useExtendedSearch":false}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
