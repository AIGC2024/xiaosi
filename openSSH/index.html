<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>OpenSSH - SSH 协议远程登录连接工具 - 小厮</title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="OpenSSH是使用SSH协议远程登录的首要连接工具。它对所有流量进行加密，以消除窃听、连接劫持和其他攻击" /><meta name="keywords" content='ssh' /><meta itemprop="name" content="OpenSSH - SSH 协议远程登录连接工具">
<meta itemprop="description" content="OpenSSH是使用SSH协议远程登录的首要连接工具。它对所有流量进行加密，以消除窃听、连接劫持和其他攻击"><meta itemprop="datePublished" content="2022-10-25T11:05:41+08:00" />
<meta itemprop="dateModified" content="2023-05-12T19:15:24+08:00" />
<meta itemprop="wordCount" content="2796">
<meta itemprop="keywords" content="ssh," /><meta property="og:title" content="OpenSSH - SSH 协议远程登录连接工具" />
<meta property="og:description" content="OpenSSH是使用SSH协议远程登录的首要连接工具。它对所有流量进行加密，以消除窃听、连接劫持和其他攻击" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/openSSH/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-25T11:05:41+08:00" />
<meta property="article:modified_time" content="2023-05-12T19:15:24+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="OpenSSH - SSH 协议远程登录连接工具"/>
<meta name="twitter:description" content="OpenSSH是使用SSH协议远程登录的首要连接工具。它对所有流量进行加密，以消除窃听、连接劫持和其他攻击"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#ffffff" data-dark="#252627" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="/openSSH/" /><link rel="prev" href="/%E4%BA%94%E7%AC%94/" /><link rel="next" href="/linuxCmdPs/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "OpenSSH - SSH 协议远程登录连接工具",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "\/openSSH\/"
    },"genre": "posts","keywords": "ssh","wordcount":  2796 ,
    "url": "\/openSSH\/","datePublished": "2022-10-25T11:05:41+08:00","dateModified": "2023-05-12T19:15:24+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "小厮"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="wide"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="小厮"><span class="header-title-text">首页</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class='fa-solid fa-archive fa-fw fa-sm'></i> 所有文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="小厮"><span class="header-title-text">首页</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class='fa-solid fa-archive fa-fw fa-sm'></i> 所有文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container container-reverse"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>OpenSSH - SSH 协议远程登录连接工具</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      小厮</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/linux/" class="post-category" title="分类 - linux"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> linux</a></span></div><div class="post-meta-line"><span title="发布于 2022-10-25 11:05:41"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2022-10-25">2022-10-25</time></span>&nbsp;<span title="更新于 2023-05-12 19:15:24"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden="true"></i><time datetime="2023-05-12">2023-05-12</time></span>&nbsp;<span title="2796 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 2800 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 6 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#sshd">sshd</a></li>
    <li><a href="#相关文件">相关文件</a>
      <ul>
        <li><a href="#服务端配置文件">服务端配置文件</a></li>
        <li><a href="#known_hosts-文件"><code>known_hosts</code> 文件</a></li>
        <li><a href="#authorized_keys-文件"><code>authorized_keys</code> 文件</a></li>
        <li><a href="#服务端配置文件选项">服务端配置文件选项</a></li>
        <li><a href="#基于用户名方式远程">基于用户名方式远程</a></li>
        <li><a href="#基于密钥方式远程用自己的私钥连接对方前提是对方有自己的公钥">基于密钥方式远程(用自己的私钥连接对方，前提是对方有自己的公钥)</a></li>
        <li><a href="#文件说明">文件说明</a></li>
        <li><a href="#日志">日志</a></li>
        <li><a href="#安全建议">安全建议</a></li>
        <li><a href="#修改端口">修改端口</a></li>
        <li><a href="#安全防护">安全防护</a>
          <ul>
            <li><a href="#centos7-使用pam机制防暴力破解sshd服务"><code>centos7</code> 使用<code>PAM</code>机制防暴力破解<code>sshd</code>服务</a></li>
            <li><a href="#centos8-使用pam机制防暴力破解sshd服务"><code>centos8</code> 使用<code>PAM</code>机制防暴力破解<code>sshd</code>服务</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#错误处理">错误处理</a>
      <ul>
        <li><a href="#ssh_exchange_identification-connection-closed-by-remote-host">ssh_exchange_identification: Connection closed by remote host</a></li>
        <li><a href="#client_loop-send-disconnect-connection-reset">client_loop: send disconnect: Connection reset</a></li>
        <li><a href="#error-bind-to-port-failed-permission-denied">error: Bind to port failed: Permission denied</a></li>
        <li><a href="#load-key-rootsshid_rsa-bad-permissions">Load key &ldquo;/root/.ssh/id_rsa&rdquo;: bad permissions</a></li>
        <li><a href="#did-not-receive-identification-string-from">Did not receive identification string from</a></li>
      </ul>
    </li>
    <li><a href="#scp">scp</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><!-- FileID: FID -->
<blockquote>
<p>运行环境：</p>
<ul>
<li>centos: 8</li>
<li>centos: 7</li>
</ul>
<p>内容来自以下文档：</p>
<ul>
<li><a href="http://www.openssh.com/manual.html"target="_blank" rel="external nofollow noopener noreferrer">OpenSSH 官方文档</a></li>
</ul>
</blockquote>
<!-- 网址链接 -->
<!-- 图片链接 -->
<!-- 其它链接 -->
<h1 id="sshd" class="heading-element">
  <a href="#sshd" class="heading-mark"></a>sshd</h1><p><code>sshd</code> 是服务端守护进程。</p>
<h1 id="相关文件" class="heading-element">
  <a href="#%e7%9b%b8%e5%85%b3%e6%96%87%e4%bb%b6" class="heading-mark"></a>相关文件</h1><h2 id="服务端配置文件" class="heading-element">
  <a href="#%e6%9c%8d%e5%8a%a1%e7%ab%af%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" class="heading-mark"></a>服务端配置文件</h2><h2 id="known_hosts-文件" class="heading-element">
  <a href="#known_hosts-%e6%96%87%e4%bb%b6" class="heading-mark"></a><code>known_hosts</code> 文件</h2><p>服务端 <code>/etc/ssh/ssh_host*.pub</code> 文件保存了公钥，当客户端第一次远程时会保存在客户端 <code>~/.ssh/known_hosts</code> 文件中。客户端下次远程内容与服务端不一样时，则阻止远程。需要删除相关记录</p>
<h2 id="authorized_keys-文件" class="heading-element">
  <a href="#authorized_keys-%e6%96%87%e4%bb%b6" class="heading-mark"></a><code>authorized_keys</code> 文件</h2><p>服务端<code>~/.ssh/authorized_keys</code> 文件保存了公钥，客户端使用对应密钥可远程该主机。客户端的密钥保存在 <code>~/.ssh/</code> 中</p>
<h2 id="服务端配置文件选项" class="heading-element">
  <a href="#%e6%9c%8d%e5%8a%a1%e7%ab%af%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e9%80%89%e9%a1%b9" class="heading-mark"></a>服务端配置文件选项</h2><div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">centos7 ssh配置文件：<span class="o">(</span><span class="c1">#+空格才表示注释)</span>
</span></span><span class="line"><span class="cl">/etc/ssh/sshd_config
</span></span><span class="line"><span class="cl">Port <span class="m">22</span> <span class="c1">#端口号</span>
</span></span><span class="line"><span class="cl">ListenAddress  <span class="c1">#监听的IP</span>
</span></span><span class="line"><span class="cl">Protocol <span class="c1">#SSH协议</span>
</span></span><span class="line"><span class="cl">HostKey <span class="c1">#主机密钥路径</span>
</span></span><span class="line"><span class="cl">KeyRegenerationInterval <span class="c1">#重新生成密钥倒计时</span>
</span></span><span class="line"><span class="cl">ServerKeyBits <span class="c1">#密钥长度</span>
</span></span><span class="line"><span class="cl">LogLevel <span class="c1">#日志级别</span>
</span></span><span class="line"><span class="cl">LoginGraceTime <span class="c1">#登陆连接中切断连接倒计时</span>
</span></span><span class="line"><span class="cl">PermitRootLogin				<span class="c1">#是否允许超级用户ssh 登陆</span>
</span></span><span class="line"><span class="cl">StrictModes				<span class="c1">#ssh接收登陆请求之前是否坚持用户根目录和rhosts权限</span>
</span></span><span class="line"><span class="cl">MaxAuthTries				<span class="c1">#指定每个连接允许的最大身份验证尝试次数</span>
</span></span><span class="line"><span class="cl">MaxSessions					<span class="c1">#指定每个网络允许的最大打开shell</span>
</span></span><span class="line"><span class="cl">MaxStartups：x:y:z,			<span class="c1">#同一地址的并发连接数量为z，则拒绝这个地址所有连接</span>
</span></span><span class="line"><span class="cl">RSAAuthentication			<span class="c1">#是个开启RAS密钥验证</span>
</span></span><span class="line"><span class="cl">PubkeyAuthentication		<span class="c1">#是否开启公钥验证</span>
</span></span><span class="line"><span class="cl">AuthorizedKeysFile			<span class="c1">#公钥验证文件路径</span>
</span></span><span class="line"><span class="cl">PasswordAuthentication		<span class="c1">#是否开启密码验证登录</span>
</span></span><span class="line"><span class="cl">PrintMotd					<span class="c1">#登陆时是否显示/etc/motd中的消息</span>
</span></span><span class="line"><span class="cl">Subsystem <span class="c1">#是否支持sft子系统</span>
</span></span><span class="line"><span class="cl">X11Forwarding <span class="c1"># 是否开启图形化程序</span>
</span></span><span class="line"><span class="cl">UseDNS yes <span class="c1">#是否反检查DNS</span>
</span></span><span class="line"><span class="cl">PidFile <span class="c1">#父进程号保存的文件</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#登陆请求记录文件</span>
</span></span><span class="line"><span class="cl">/var/log/secure
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">限制登陆名单，只能是用户名 且以空格分开
</span></span><span class="line"><span class="cl">黑名单：DenyUsers
</span></span><span class="line"><span class="cl">黑名单用户组：DenyGroups
</span></span><span class="line"><span class="cl">白名单：AllowUsers
</span></span><span class="line"><span class="cl">白名单用户组： AllowGroups</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="基于用户名方式远程" class="heading-element">
  <a href="#%e5%9f%ba%e4%ba%8e%e7%94%a8%e6%88%b7%e5%90%8d%e6%96%b9%e5%bc%8f%e8%bf%9c%e7%a8%8b" class="heading-mark"></a>基于用户名方式远程</h2><div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#远程目标与当前同名的用户</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@yh ~<span class="o">]</span><span class="c1"># ssh 192.168.157.21</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">#远程 192.168.157.21的user1用户</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@yh ~<span class="o">]</span><span class="c1"># ssh user1@192.168.157.21</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">#在 192.168.157.21 上用user1用户执行ls /  返回结果</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@yh ~<span class="o">]</span><span class="c1"># ssh user1@192.168.157.21 &#34;ls /&#34;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">#ssh -p 指定远程端口</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@yh ~<span class="o">]</span><span class="c1"># ssh 192.168.157.130 -p 22</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="基于密钥方式远程用自己的私钥连接对方前提是对方有自己的公钥" class="heading-element">
  <a href="#%e5%9f%ba%e4%ba%8e%e5%af%86%e9%92%a5%e6%96%b9%e5%bc%8f%e8%bf%9c%e7%a8%8b%e7%94%a8%e8%87%aa%e5%b7%b1%e7%9a%84%e7%a7%81%e9%92%a5%e8%bf%9e%e6%8e%a5%e5%af%b9%e6%96%b9%e5%89%8d%e6%8f%90%e6%98%af%e5%af%b9%e6%96%b9%e6%9c%89%e8%87%aa%e5%b7%b1%e7%9a%84%e5%85%ac%e9%92%a5" class="heading-mark"></a>基于密钥方式远程(用自己的私钥连接对方，前提是对方有自己的公钥)</h2><ol>
<li>
<p>生成密钥对</p>
<ul>
<li>交互式生成密钥对方式</li>
</ul>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 生成密钥，-t选择加密方式</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ssh-keygen -t rsa</span>
</span></span><span class="line"><span class="cl">Generating public/private rsa key pair.
</span></span><span class="line"><span class="cl">Enter file in which to save the key <span class="o">(</span>/root/.ssh/id_rsa<span class="o">)</span>:   <span class="c1">#密钥保存位置</span>
</span></span><span class="line"><span class="cl">Created directory <span class="s1">&#39;/root/.ssh&#39;</span>.
</span></span><span class="line"><span class="cl">Enter passphrase <span class="o">(</span>empty <span class="k">for</span> no passphrase<span class="o">)</span>:   <span class="c1"># 密钥密码</span>
</span></span><span class="line"><span class="cl">Enter same passphrase again:
</span></span><span class="line"><span class="cl">Your identification has been saved in /root/.ssh/id_rsa.    <span class="c1"># 密钥文件</span>
</span></span><span class="line"><span class="cl">Your public key has been saved in /root/.ssh/id_rsa.pub.    <span class="c1"># 公钥文件</span>
</span></span><span class="line"><span class="cl">The key fingerprint is:
</span></span><span class="line"><span class="cl">SHA256:jQZ27QOYwjt+VUaqCZlXQd3QpYMNXLLhh18nTDTnHDU root@localhost.localdomain
</span></span><span class="line"><span class="cl">The key<span class="err">&#39;</span>s randomart image is:
</span></span><span class="line"><span class="cl">+---<span class="o">[</span>RSA 2048<span class="o">]</span>----+
</span></span><span class="line"><span class="cl"><span class="p">|</span>       .++*<span class="o">=</span>.o<span class="o">=</span>E+<span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>   . o + <span class="o">=</span>oOo+ <span class="o">=</span>o<span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>    * * + <span class="nv">O</span> <span class="o">=</span> + +<span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>     * <span class="o">=</span> B o o o <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>    o o S + .    <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>   . . o   .     <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>    . .          <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>     .           <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>                 <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----<span class="o">[</span>SHA256<span class="o">]</span>-----+</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>非交互式生成密钥对方式</li>
</ul>
<div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># -P 指定密码 -f 指定保存私钥文件</span>
</span></span><span class="line"><span class="cl">ssh-keygen -t rsa  -P <span class="s2">&#34;&#34;</span> -f <span class="s2">&#34;/root/.ssh/ssh.rsa&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>把公钥文发给对方</p>
</li>
</ol>
<div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#把公钥文件发给131 -p 指定对方远程端口</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ssh-copy-id -i .ssh/id_rsa.pub -p 22 root@192.168.157.131</span>
</span></span><span class="line"><span class="cl">/usr/bin/ssh-copy-id: INFO: Source of key<span class="o">(</span>s<span class="o">)</span> to be installed: <span class="s2">&#34;/root/.ssh/id_rsa.pub&#34;</span>
</span></span><span class="line"><span class="cl">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key<span class="o">(</span>s<span class="o">)</span>, to filter out any that are already installed
</span></span><span class="line"><span class="cl">/usr/bin/ssh-copy-id: INFO: <span class="m">1</span> key<span class="o">(</span>s<span class="o">)</span> remain to be installed -- <span class="k">if</span> you are prompted now it is to install the new keys
</span></span><span class="line"><span class="cl">root@192.168.157.131<span class="s1">&#39;s password:    #输入192.168.157.131密码
</span></span></span><span class="line"><span class="cl"><span class="s1"> 
</span></span></span><span class="line"><span class="cl"><span class="s1">Number of key(s) added: 1
</span></span></span><span class="line"><span class="cl"><span class="s1"> 
</span></span></span><span class="line"><span class="cl"><span class="s1">Now try logging into the machine, with:   &#34;ssh &#39;</span>192.168.157.131<span class="err">&#39;</span><span class="s2">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">and check to make sure that only the key(s) you wanted were added.</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="文件说明" class="heading-element">
  <a href="#%e6%96%87%e4%bb%b6%e8%af%b4%e6%98%8e" class="heading-mark"></a>文件说明</h2><div class="highlight" id="id-6"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看公钥文件位置</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># grep &#34;AuthorizedKeysFile&#34;  /etc/ssh/sshd_config</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@yh ~<span class="o">]</span><span class="c1"># ls .ssh/</span>
</span></span><span class="line"><span class="cl">id_rsa  id_rsa.pub  known_hosts
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># rsa：私钥</span>
</span></span><span class="line"><span class="cl"><span class="c1"># rsa.pub：公钥</span>
</span></span><span class="line"><span class="cl"><span class="c1"># known_hosts：服务端保存的客户端的信息，</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     若果没有相关客户端信息 远程时则会咨询是否连接客户端</span>
</span></span><span class="line"><span class="cl"><span class="c1"># authorized_keys：客户端保存的服务器信息(内容与服务端生成的公钥相同)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     如果没有相关服务端信息，则不能通过密钥连接</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="日志" class="heading-element">
  <a href="#%e6%97%a5%e5%bf%97" class="heading-mark"></a>日志</h2><p>登录成功的日志会记录在<code>/var/run/utmp</code>文件，失败记录是 <code>/var/log/btmp</code> 文件。需要使用 <code>last -f</code> 命令查看</p>
<h2 id="安全建议" class="heading-element">
  <a href="#%e5%ae%89%e5%85%a8%e5%bb%ba%e8%ae%ae" class="heading-mark"></a>安全建议</h2><ul>
<li>修改默认端口</li>
<li>使用安全的连接方式</li>
<li>设置登陆用户列表（白名单）</li>
<li>设置空闲超时时长</li>
<li>防火墙访问策略</li>
<li>监听特定的IP</li>
<li>尽量使用密钥对验证</li>
<li>密码复杂度高</li>
<li>禁止管理员用户远程</li>
</ul>
<h2 id="修改端口" class="heading-element">
  <a href="#%e4%bf%ae%e6%94%b9%e7%ab%af%e5%8f%a3" class="heading-mark"></a>修改端口</h2><div class="highlight" id="id-7"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># grep &#34;Port&#34; /etc/ssh/sshd_config </span>
</span></span><span class="line"><span class="cl"><span class="c1">#Port 22</span>
</span></span><span class="line"><span class="cl"><span class="c1">#GatewayPorts no</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 添加端口</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># echo &#34;Port 2882&#34; &gt;&gt;/etc/ssh/sshd_config</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># echo &#39;IPQoS=throughput&#39; &gt;&gt;/etc/ssh/sshd_config</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 在selinux中添加sshd注册端口 </span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># semanage port -a -t ssh_port_t -p tcp 2882</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># semanage port -l | grep ssh</span>
</span></span><span class="line"><span class="cl">ssh_port_t                     tcp      2882, <span class="m">22</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 添加端口到防火墙</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># firewall-cmd --get-zone-of-interface=eno1</span>
</span></span><span class="line"><span class="cl">public
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># firewall-cmd --zone=public --add-port=2882/tcp &amp;&amp; firewall-cmd --runtime-to-permanent</span>
</span></span><span class="line"><span class="cl">success
</span></span><span class="line"><span class="cl">success
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 重启ssh服务</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># systemctl restart sshd</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ss -anltpd | grep ssh</span>
</span></span><span class="line"><span class="cl">tcp   LISTEN <span class="m">0</span>      <span class="m">128</span>          0.0.0.0:2882      0.0.0.0:*    users:<span class="o">((</span><span class="s2">&#34;sshd&#34;</span>,pid<span class="o">=</span>77582,fd<span class="o">=</span>4<span class="o">))</span>
</span></span><span class="line"><span class="cl">tcp   LISTEN <span class="m">0</span>      <span class="m">128</span>             <span class="o">[</span>::<span class="o">]</span>:2882         <span class="o">[</span>::<span class="o">]</span>:*    users:<span class="o">((</span><span class="s2">&#34;sshd&#34;</span>,pid<span class="o">=</span>77582,fd<span class="o">=</span>6<span class="o">))</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="安全防护" class="heading-element">
  <a href="#%e5%ae%89%e5%85%a8%e9%98%b2%e6%8a%a4" class="heading-mark"></a>安全防护</h2><ul>
<li>修改默认端口号减少被扫描风险</li>
<li>密码要有随机性、复杂性或禁用密码使用秘钥对</li>
<li>配置防火墙限制IP远程</li>
</ul>
<h3 id="centos7-使用pam机制防暴力破解sshd服务" class="heading-element">
  <a href="#centos7-%e4%bd%bf%e7%94%a8pam%e6%9c%ba%e5%88%b6%e9%98%b2%e6%9a%b4%e5%8a%9b%e7%a0%b4%e8%a7%a3sshd%e6%9c%8d%e5%8a%a1" class="heading-mark"></a><code>centos7</code> 使用<code>PAM</code>机制防暴力破解<code>sshd</code>服务</h3><p>使用以下方式锁定账号</p>
<div class="highlight" id="id-8"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># even_deny_root 也限制root用户；</span>
</span></span><span class="line"><span class="cl"><span class="c1"># deny 设置普通用户和root用户连续错误登陆的最大次数，超过最大次数，则锁定该用户</span>
</span></span><span class="line"><span class="cl"><span class="c1"># unlock_time 设定普通用户锁定后，多少时间后解锁，单位是秒；</span>
</span></span><span class="line"><span class="cl"><span class="c1"># root_unlock_time 设定root用户锁定后，多少时间后解锁，单位是秒；</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># echo &#39;auth required pam_tally2.so deny=3 unlock_time=999999 even_deny_root root_unlock_time=10800&#39; &gt;&gt; /etc/pam.d/sshd</span></span></span></code></pre></td></tr></table>
</div>
</div><p>使用 <code>pam_tally2</code> 查看登录失败的次数，<code>-u</code>选项可以指定具体的用户；<code>-r</code>选项可以清空统计次数</p>
<div class="highlight" id="id-9"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># pam_tally2</span>
</span></span><span class="line"><span class="cl">Login           Failures Latest failure     From
</span></span><span class="line"><span class="cl">root              <span class="m">212</span>    11/06/22 19:38:48  61.177.172.76
</span></span><span class="line"><span class="cl">git                 <span class="m">2</span>    11/06/22 19:18:18  43.134.4.104
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># pam_tally2 -u root</span>
</span></span><span class="line"><span class="cl">Login           Failures Latest failure     From
</span></span><span class="line"><span class="cl">root              <span class="m">213</span>    11/06/22 19:40:15  129.146.90.109</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="centos8-使用pam机制防暴力破解sshd服务" class="heading-element">
  <a href="#centos8-%e4%bd%bf%e7%94%a8pam%e6%9c%ba%e5%88%b6%e9%98%b2%e6%9a%b4%e5%8a%9b%e7%a0%b4%e8%a7%a3sshd%e6%9c%8d%e5%8a%a1" class="heading-mark"></a><code>centos8</code> 使用<code>PAM</code>机制防暴力破解<code>sshd</code>服务</h3><p><code>centos8</code> 使用 <code>pam_faillock</code> 替换 <code>pam_tally2</code> 模块。</p>
<p>在 <code>/etc/pam.d/system-auth</code> 与 <code>/etc/pam.d/password-auth</code> 文件添加以下行（注意模块类型、控制标记顺序）</p>
<div class="highlight" id="id-10"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 模块类型  控制标记      模块路径及参数</span>
</span></span><span class="line"><span class="cl">auth        required      pam_faillock.so even_deny_root preauth silent audit <span class="nv">deny</span><span class="o">=</span><span class="m">3</span> <span class="nv">unlock_time</span><span class="o">=</span><span class="m">300</span>   
</span></span><span class="line"><span class="cl">auth        sufficient    pam_unix.so nullok try_first_pass 
</span></span><span class="line"><span class="cl">auth        <span class="o">[</span><span class="nv">default</span><span class="o">=</span>die<span class="o">]</span>  pam_faillock.so even_deny_root authfail  audit  <span class="nv">deny</span><span class="o">=</span><span class="m">3</span>  <span class="nv">unlock_time</span><span class="o">=</span><span class="m">300</span>    
</span></span><span class="line"><span class="cl"><span class="c1"># 这行在 accpunt 块最片</span>
</span></span><span class="line"><span class="cl">account  required  pam_faillock.so</span></span></code></pre></td></tr></table>
</div>
</div><p>使用 <code>faillock</code> 查看登录失败的次数，<code>-u</code>选项可以指定具体的用户；<code>-r</code>选项可以清空统计次数</p>
<h1 id="错误处理" class="heading-element">
  <a href="#%e9%94%99%e8%af%af%e5%a4%84%e7%90%86" class="heading-mark"></a>错误处理</h1><h2 id="ssh_exchange_identification-connection-closed-by-remote-host" class="heading-element">
  <a href="#ssh_exchange_identification-connection-closed-by-remote-host" class="heading-mark"></a>ssh_exchange_identification: Connection closed by remote host</h2><div class="highlight" id="id-11"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ssh root@192.168.245.210 -p 2551</span>
</span></span><span class="line"><span class="cl">ssh_exchange_identification: Connection closed by remote host</span></span></code></pre></td></tr></table>
</div>
</div><p>解决方法：在 <code>known_hosts</code> 中删除该主机中的记录</p>
<div class="highlight" id="id-12"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># echo &gt;.ssh/known_hosts</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ssh root@192.168.245.210 -p 2551</span>
</span></span><span class="line"><span class="cl">The authenticity of host <span class="s1">&#39;[192.168.245.210]:2551 ([192.168.245.210]:2551)&#39;</span> can<span class="err">&#39;</span>t be established.
</span></span><span class="line"><span class="cl">ECDSA key fingerprint is SHA256:uzWQ3DhjrQwC5FsV+NFYa1GNcziBr/YK+TtGAut0qys.
</span></span><span class="line"><span class="cl">ECDSA key fingerprint is MD5:4b:9f:39:3b:d5:71:00:ee:ab:b5:29:1d:a1:90:0d:64.
</span></span><span class="line"><span class="cl">Are you sure you want to <span class="k">continue</span> connecting <span class="o">(</span>yes/no<span class="o">)</span>? yes
</span></span><span class="line"><span class="cl">...</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="client_loop-send-disconnect-connection-reset" class="heading-element">
  <a href="#client_loop-send-disconnect-connection-reset" class="heading-mark"></a>client_loop: send disconnect: Connection reset</h2><div class="highlight" id="id-13"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">PS E:<span class="se">\&gt;</span> ssh root@154.55.134.82 -p <span class="m">18671</span>
</span></span><span class="line"><span class="cl">root@154.55.134.82<span class="s1">&#39;s password:
</span></span></span><span class="line"><span class="cl"><span class="s1">client_loop: send disconnect: Connection reset
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Nov 19 09:13:00 HK02-5037MR-006-08 systemd[1]: Stopping OpenSSH server daemon...
</span></span></span><span class="line"><span class="cl"><span class="s1">Nov 19 09:13:00 HK02-5037MR-006-08 sshd[32010]: Received signal 15; terminating.
</span></span></span><span class="line"><span class="cl"><span class="s1">Nov 19 09:13:00 HK02-5037MR-006-08 systemd[1]: Stopped OpenSSH server daemon.
</span></span></span><span class="line"><span class="cl"><span class="s1">Nov 19 09:13:00 HK02-5037MR-006-08 systemd[1]: Starting OpenSSH server daemon...
</span></span></span><span class="line"><span class="cl"><span class="s1">Nov 19 09:13:00 HK02-5037MR-006-08 sshd[32045]: Server listening on 0.0.0.0 port 18671.
</span></span></span><span class="line"><span class="cl"><span class="s1">Nov 19 09:13:00 HK02-5037MR-006-08 sshd[32045]: Server listening on :: port 18671.
</span></span></span><span class="line"><span class="cl"><span class="s1">Nov 19 09:13:00 HK02-5037MR-006-08 systemd[1]: Started OpenSSH server daemon.
</span></span></span><span class="line"><span class="cl"><span class="s1">Nov 19 09:13:06 HK02-5037MR-006-08 sshd[32048]: Accepted publickey for root from 119.123.152.249 port 25367 ssh2: RSA SHA256:TzjxAthsEdqCvbFk5VTlmRgVfB9bOxPHJTL0/OBNfhs
</span></span></span><span class="line"><span class="cl"><span class="s1">Nov 19 09:13:06 HK02-5037MR-006-08 sshd[32048]: pam_unix(sshd:session): session opened for user root by (uid=0)
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">[root@HK02-5037MR-006-04 ~]# echo &#39;</span><span class="nv">IPQoS</span><span class="o">=</span>throughput<span class="err">&#39;</span> &gt;&gt;/etc/ssh/sshd_config 
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@HK02-5037MR-006-04 ~<span class="o">]</span><span class="c1"># systemctl restart sshd</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="error-bind-to-port-failed-permission-denied" class="heading-element">
  <a href="#error-bind-to-port-failed-permission-denied" class="heading-mark"></a>error: Bind to port failed: Permission denied</h2><p>修改<code>sshd</code>端口后无法重启</p>
<div class="highlight" id="id-14"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ssh<span class="o">]</span><span class="c1"># journalctl -xe</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">-- Unit sshd.service has begun starting up.
</span></span><span class="line"><span class="cl">Jan <span class="m">18</span> 14:11:58 localhost.localdomain sshd<span class="o">[</span>1741<span class="o">]</span>: error: Bind to port <span class="m">838</span> on 0.0.0.0 failed: Permission denied.
</span></span><span class="line"><span class="cl">Jan <span class="m">18</span> 14:11:58 localhost.localdomain sshd<span class="o">[</span>1741<span class="o">]</span>: error: Bind to port <span class="m">838</span> on :: failed: Permission denied.
</span></span><span class="line"><span class="cl">Jan <span class="m">18</span> 14:11:58 localhost.localdomain systemd<span class="o">[</span>1<span class="o">]</span>: sshd.service: Main process exited, <span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span>255/n/a
</span></span><span class="line"><span class="cl">Jan <span class="m">18</span> 14:11:58 localhost.localdomain sshd<span class="o">[</span>1741<span class="o">]</span>: fatal: Cannot <span class="nb">bind</span> any address.
</span></span><span class="line"><span class="cl">Jan <span class="m">18</span> 14:11:58 localhost.localdomain systemd<span class="o">[</span>1<span class="o">]</span>: sshd.service: Failed with result <span class="s1">&#39;exit-code&#39;</span>.
</span></span><span class="line"><span class="cl">-- Subject: Unit failed
</span></span><span class="line"><span class="cl">-- Defined-By: systemd
</span></span><span class="line"><span class="cl">-- Support: https://access.redhat.com/support</span></span></code></pre></td></tr></table>
</div>
</div><p><code>selinux</code>造成的</p>
<div class="highlight" id="id-15"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">方法1：改变selinux
</span></span><span class="line"><span class="cl"><span class="c1">## 在selinux中添加sshd注册端口</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ssh<span class="o">]</span><span class="c1"># semanage port -a -t ssh_port_t -p tcp 838</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ssh<span class="o">]</span><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 查看selinux中sshd当前的注册端口</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ssh<span class="o">]</span><span class="c1"># semanage port -l | grep ssh</span>
</span></span><span class="line"><span class="cl">ssh_port_t                     tcp      838, <span class="m">22</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 方法2：关闭selinux</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 临时关闭，立即生效</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ssh<span class="o">]</span><span class="c1"># setenforce 0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ssh<span class="o">]</span><span class="c1"># getenforce</span>
</span></span><span class="line"><span class="cl">Permissive
</span></span><span class="line"><span class="cl"><span class="c1">## 永久关闭，重启服务器后生效</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ssh<span class="o">]</span><span class="c1"># sed -i &#39;/^SELINUX=/ s/enforcing/disabled/g&#39; /etc/selinux/config</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ssh<span class="o">]</span><span class="c1"># systemctl restart sshd</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ssh<span class="o">]</span><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ssh<span class="o">]</span><span class="c1"># ss -altpdn | grep &#34;ssh&#34;</span>
</span></span><span class="line"><span class="cl">tcp   LISTEN <span class="m">0</span>      <span class="m">128</span>          0.0.0.0:838       0.0.0.0:*    users:<span class="o">((</span><span class="s2">&#34;sshd&#34;</span>,pid<span class="o">=</span>1818,fd<span class="o">=</span>4<span class="o">))</span>
</span></span><span class="line"><span class="cl">tcp   LISTEN <span class="m">0</span>      <span class="m">128</span>             <span class="o">[</span>::<span class="o">]</span>:838          <span class="o">[</span>::<span class="o">]</span>:*    users:<span class="o">((</span><span class="s2">&#34;sshd&#34;</span>,pid<span class="o">=</span>1818,fd<span class="o">=</span>6<span class="o">))</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="load-key-rootsshid_rsa-bad-permissions" class="heading-element">
  <a href="#load-key-rootsshid_rsa-bad-permissions" class="heading-mark"></a>Load key &ldquo;/root/.ssh/id_rsa&rdquo;: bad permissions</h2><p><code>/root/.ssh/id_rsa</code>的权限错误，应该为<code>600</code></p>
<div class="highlight" id="id-16"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@xiaosi ~<span class="o">]</span><span class="c1"># ll .ssh/id_rsa</span>
</span></span><span class="line"><span class="cl">-rwxr-xr-x. <span class="m">1</span> root root <span class="m">1675</span> Apr <span class="m">23</span> 17:36 .ssh/id_rsa
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xiaosi ~<span class="o">]</span><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xiaosi ~<span class="o">]</span><span class="c1"># chmod 600 .ssh/id_rsa</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xiaosi ~<span class="o">]</span><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xiaosi ~<span class="o">]</span><span class="c1"># ll .ssh/id_rsa</span>
</span></span><span class="line"><span class="cl">-rw-------. <span class="m">1</span> root root <span class="m">1675</span> Apr <span class="m">23</span> 17:36 .ssh/id_rsa</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="did-not-receive-identification-string-from" class="heading-element">
  <a href="#did-not-receive-identification-string-from" class="heading-mark"></a>Did not receive identification string from</h2><div class="highlight" id="id-17"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># systemctl -l status sshd</span>
</span></span><span class="line"><span class="cl">● sshd.service - OpenSSH server daemon
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">May <span class="m">12</span> 19:03:58 localhost.localdomain sshd<span class="o">[</span>3377<span class="o">]</span>: Did not receive identification string from x.x.x.x port <span class="m">33503</span>
</span></span><span class="line"><span class="cl">...</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="scp" class="heading-element">
  <a href="#scp" class="heading-mark"></a>scp</h1><div class="highlight" id="id-18"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">scp ：基于ssh复制文件
</span></span><span class="line"><span class="cl">-r：递归复制
</span></span><span class="line"><span class="cl">-p：保持文件属性
</span></span><span class="line"><span class="cl">-P：指定端口
</span></span><span class="line"><span class="cl">-q：静默模式
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">#本地复制到对方</span>
</span></span><span class="line"><span class="cl">scp  本地文件路径  用户名@ip:保存路径
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">#远程复制到本地</span>
</span></span><span class="line"><span class="cl">scp  用户名@ip:保存路径   本地文件路径</span></span></code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2023-05-12 19:15:24">更新于 2023-05-12&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/ssh/" class="post-tag" title="标签 - ssh">ssh</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/%E4%BA%94%E7%AC%94/" class="post-nav-item" rel="prev" title="五笔输入法"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>五笔输入法</a>
      <a href="/linuxCmdPs/" class="post-nav-item" rel="next" title="ps - 查看进程信息快照">ps - 查看进程信息快照<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.115.3"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.1"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2022 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/pangu/pangu.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"lightgallery":true,"pangu":{"enable":true,"selector":"article"},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":true,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.3,"type":"fuse","useExtendedSearch":false}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
