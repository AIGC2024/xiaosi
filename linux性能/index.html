<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>linux 性能 - 小厮</title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="内容来自以下文档： taozj mikelLam 性能优化 性能指标高并发和响应快对应着性能优化的两个核心指标：吞吐和延时。 应用负载角度：直接影响了产品终端的用户体验 系统" /><meta name="keywords" content='linux, 性能' /><meta itemprop="name" content="linux 性能">
<meta itemprop="description" content="内容来自以下文档： taozj mikelLam 性能优化 性能指标高并发和响应快对应着性能优化的两个核心指标：吞吐和延时。 应用负载角度：直接影响了产品终端的用户体验 系统"><meta itemprop="datePublished" content="2021-12-12T17:41:09+08:00" />
<meta itemprop="dateModified" content="2023-07-22T13:49:16+08:00" />
<meta itemprop="wordCount" content="13129">
<meta itemprop="keywords" content="linux,性能," /><meta property="og:title" content="linux 性能" />
<meta property="og:description" content="内容来自以下文档： taozj mikelLam 性能优化 性能指标高并发和响应快对应着性能优化的两个核心指标：吞吐和延时。 应用负载角度：直接影响了产品终端的用户体验 系统" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/linux%E6%80%A7%E8%83%BD/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-12T17:41:09+08:00" />
<meta property="article:modified_time" content="2023-07-22T13:49:16+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="linux 性能"/>
<meta name="twitter:description" content="内容来自以下文档： taozj mikelLam 性能优化 性能指标高并发和响应快对应着性能优化的两个核心指标：吞吐和延时。 应用负载角度：直接影响了产品终端的用户体验 系统"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#ffffff" data-dark="#252627" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="/linux%E6%80%A7%E8%83%BD/" /><link rel="prev" href="/vim-nginx/" /><link rel="next" href="/awk/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "linux 性能",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "\/linux%E6%80%A7%E8%83%BD\/"
    },"genre": "posts","keywords": "linux, 性能","wordcount":  13129 ,
    "url": "\/linux%E6%80%A7%E8%83%BD\/","datePublished": "2021-12-12T17:41:09+08:00","dateModified": "2023-07-22T13:49:16+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "小厮"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="wide"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="小厮"><span class="header-title-text">首页</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class='fa-solid fa-archive fa-fw fa-sm'></i> 所有文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="小厮"><span class="header-title-text">首页</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class='fa-solid fa-archive fa-fw fa-sm'></i> 所有文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container container-reverse"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>linux 性能</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      小厮</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/linux/" class="post-category" title="分类 - linux"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> linux</a></span></div><div class="post-meta-line"><span title="发布于 2021-12-12 17:41:09"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2021-12-12">2021-12-12</time></span>&nbsp;<span title="更新于 2023-07-22 13:49:16"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden="true"></i><time datetime="2023-07-22">2023-07-22</time></span>&nbsp;<span title="13129 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 13200 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 27 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#性能优化">性能优化</a>
      <ul>
        <li><a href="#性能指标">性能指标</a></li>
        <li><a href="#平均负载">平均负载</a></li>
      </ul>
    </li>
    <li><a href="#cpu">CPU</a>
      <ul>
        <li><a href="#cpu上下文切换">CPU上下文切换</a>
          <ul>
            <li><a href="#进程上下文切换">进程上下文切换</a></li>
            <li><a href="#线程上下文切换">线程上下文切换</a></li>
            <li><a href="#中断上下文切换">中断上下文切换</a></li>
          </ul>
        </li>
        <li><a href="#性能分析工具perf">性能分析工具perf</a></li>
        <li><a href="#进程状态">进程状态</a></li>
        <li><a href="#性能工具">性能工具</a></li>
      </ul>
    </li>
    <li><a href="#内存">内存</a>
      <ul>
        <li><a href="#内存映射">内存映射</a></li>
        <li><a href="#虚拟内存空间分布">虚拟内存空间分布</a></li>
        <li><a href="#内存分配">内存分配</a></li>
        <li><a href="#内存回收">内存回收</a></li>
        <li><a href="#如何查看内存使用情况">如何查看内存使用情况</a></li>
        <li><a href="#内存中的buffer和cache">内存中的Buffer和Cache</a></li>
        <li><a href="#缓存命中率">缓存命中率</a></li>
        <li><a href="#内存泄漏">内存泄漏</a></li>
        <li><a href="#swap原理">Swap原理</a></li>
        <li><a href="#numa-与-swap">NUMA 与 SWAP</a></li>
        <li><a href="#swappiness">swappiness</a></li>
      </ul>
    </li>
    <li><a href="#相关命令说明">相关命令说明</a>
      <ul>
        <li><a href="#top">top</a></li>
        <li><a href="#swap相关命令">swap相关命令</a></li>
        <li><a href="#procmeminfo">/proc/meminfo</a></li>
        <li><a href="#iotop">iotop</a></li>
        <li><a href="#lsof">lsof</a></li>
        <li><a href="#sar">sar</a></li>
        <li><a href="#sysbench">sysbench</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><!-- FileID: FID -->
<blockquote>
<p>内容来自以下文档：</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/lPgZBtKD7h-WHHKHoqGtGg" title="taozj"target="_blank" rel="external nofollow noopener noreferrer">taozj</a></li>
<li><a href="https://www.ctq6.cn/linux%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" title="mikelLam"target="_blank" rel="external nofollow noopener noreferrer">mikelLam</a></li>
</ul>
</blockquote>
<!-- 网址链接 -->
<!-- 图片链接 -->
<!-- 其它链接 -->
<h1 id="性能优化" class="heading-element">
  <a href="#%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96" class="heading-mark"></a>性能优化</h1><h2 id="性能指标" class="heading-element">
  <a href="#%e6%80%a7%e8%83%bd%e6%8c%87%e6%a0%87" class="heading-mark"></a>性能指标</h2><p>高并发和响应快对应着性能优化的两个核心指标：吞吐和延时。</p>
<ul>
<li>应用负载角度：直接影响了产品终端的用户体验</li>
<li>系统资源角度：资源使用率、饱和度等</li>
</ul>
<p>性能问题的本质就是系统资源已经到达瓶颈，但请求的处理还不够快，无法支撑更多的请求。 性能分析实际上就是找出应用或系统的瓶颈，设法去避免或缓解它们。</p>
<ul>
<li>选择指标评估应用程序和系统性能</li>
<li>为应用程序和系统设置性能目标</li>
<li>进行性能基准测试</li>
<li>性能分析定位瓶颈</li>
<li>性能监控和告警</li>
</ul>
<p>对于不同的性能问题要选取不同的性能分析工具。 下面是常用的Linux Performance Tools以及对应分析的性能问题类型。</p>
<p><img loading="lazy" src="./LinuxPerformanceTool.png" alt="LinuxPerformanceTool" srcset="./LinuxPerformanceTool.png?size=small, ./LinuxPerformanceTool.png?size=medium 1.5x, ./LinuxPerformanceTool.png?size=large 2x" sizes="auto" data-title="LinuxPerformanceTool" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="平均负载" class="heading-element">
  <a href="#%e5%b9%b3%e5%9d%87%e8%b4%9f%e8%bd%bd" class="heading-mark"></a>平均负载</h2><p>平均负载：在单位时间内，系统处于可运行状态和不可中断状态的平均进程数，也就是平均活跃进程数。
其中不可中断进程是正处于内核态关键流程中的进程（如常见的等待设备的I/O响应）。不可中断状态实际上是系统对进程和硬件设备的一种保护机制</p>
<p>实际生产环境中将系统的平均负载监控起来，根据历史数据判断负载的变化趋势。当负载存在明显升高趋势时，及时进行分析和调查。 当然也可以当设置阈值（如当平均负载高于CPU数量的70%时）</p>
<p>现实工作中我们会经常混淆平均负载和CPU使用率的概念，其实两者并不完全对等：</p>
<ul>
<li>CPU密集型进程，大量CPU使用会导致平均负载升高，此时两者一致</li>
<li>I/O密集型进程，等待I/O也会导致平均负载升高，此时CPU使用率并不一定高</li>
<li>大量等待CPU的进程调度会导致平均负载升高，此时CPU使用率也会比较高</li>
</ul>
<p>平均负载高时可能是CPU密集型进程导致，也可能是I/O繁忙导致。具体分析时可以结合mpstat/pidstat工具辅助分析负载来源</p>
<h1 id="cpu" class="heading-element">
  <a href="#cpu" class="heading-mark"></a>CPU</h1><p>通过vmstat可以查看系统总体的上下文切换情况</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 每隔5s输出一组数据</span>
</span></span><span class="line"><span class="cl">vmstat <span class="m">5</span>         
</span></span><span class="line"><span class="cl">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
</span></span><span class="line"><span class="cl"> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
</span></span><span class="line"><span class="cl"> <span class="m">1</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">103388</span> <span class="m">145412</span> <span class="m">511056</span>    <span class="m">0</span>    <span class="m">0</span>    <span class="m">18</span>    <span class="m">60</span>    <span class="m">1</span>    <span class="m">1</span>  <span class="m">2</span>  <span class="m">1</span> <span class="m">96</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">103388</span> <span class="m">145412</span> <span class="m">511076</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>     <span class="m">2</span>  <span class="m">450</span> <span class="m">1176</span>  <span class="m">1</span>  <span class="m">1</span> <span class="m">99</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">103388</span> <span class="m">145412</span> <span class="m">511076</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>     <span class="m">8</span>  <span class="m">429</span> <span class="m">1135</span>  <span class="m">1</span>  <span class="m">1</span> <span class="m">98</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">103388</span> <span class="m">145412</span> <span class="m">511076</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>     <span class="m">0</span>  <span class="m">431</span> <span class="m">1132</span>  <span class="m">1</span>  <span class="m">1</span> <span class="m">98</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">103388</span> <span class="m">145412</span> <span class="m">511076</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>    <span class="m">10</span>  <span class="m">467</span> <span class="m">1195</span>  <span class="m">1</span>  <span class="m">1</span> <span class="m">98</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">1</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">103388</span> <span class="m">145412</span> <span class="m">511076</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>     <span class="m">2</span>  <span class="m">426</span> <span class="m">1139</span>  <span class="m">1</span>  <span class="m">0</span> <span class="m">99</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">4</span>  <span class="m">0</span>      <span class="m">0</span>  <span class="m">95184</span> <span class="m">145412</span> <span class="m">511108</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>    <span class="m">74</span>  <span class="m">500</span> <span class="m">1228</span>  <span class="m">4</span>  <span class="m">1</span> <span class="m">94</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">103512</span> <span class="m">145416</span> <span class="m">511076</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>   <span class="m">455</span>  <span class="m">723</span> <span class="m">1573</span> <span class="m">12</span>  <span class="m">3</span> <span class="m">83</span>  <span class="m">2</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># cs （context switch） 每秒上下文切换次数</span>
</span></span><span class="line"><span class="cl"><span class="c1"># in （interrupt） 每秒中断次数</span>
</span></span><span class="line"><span class="cl"><span class="c1"># r （runnning or runnable）就绪队列的长度，正在运行和等待CPU的进程数</span>
</span></span><span class="line"><span class="cl"><span class="c1"># b （Blocked） 处于不可中断睡眠状态的进程数</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="cpu上下文切换" class="heading-element">
  <a href="#cpu%e4%b8%8a%e4%b8%8b%e6%96%87%e5%88%87%e6%8d%a2" class="heading-mark"></a>CPU上下文切换</h2><p>CPU上下文切换，就是把前一个任务的CPU上下文（CPU寄存器和PC）保存起来，然后加载新任务的上下文到这些寄存器和程序计数器，最后再跳转到程序计数器所指的位置，运行新任务。其中，保存下来的上下文会存储在系统内核中，待任务重新调度执行时再加载，保证原来的任务状态不受影响。</p>
<p>按照任务类型，CPU上下文切换分为：</p>
<ul>
<li>进程上下文切换</li>
<li>线程上下文切换</li>
<li>中断上下文切换</li>
</ul>
<h3 id="进程上下文切换" class="heading-element">
  <a href="#%e8%bf%9b%e7%a8%8b%e4%b8%8a%e4%b8%8b%e6%96%87%e5%88%87%e6%8d%a2" class="heading-mark"></a>进程上下文切换</h3><p>Linux进程按照等级权限将进程的运行空间分为内核空间和用户空间。从用户态向内核态转变时需要通过系统调用来完成。</p>
<p>一次系统调用过程其实进行了两次CPU上下文切换：</p>
<ul>
<li>CPU寄存器中用户态的指令位置先保存起来，CPU寄存器更新为内核态指令的位置，跳转到内核态运行内核任务；</li>
<li>系统调用结束后，CPU寄存器恢复原来保存的用户态数据，再切换到用户空间继续运行。</li>
</ul>
<p>系统调用过程中并不会涉及虚拟内存等进程用户态资源，也不会切换进程。和传统意义上的进程上下文切换不同。因此系统调用通常称为特权模式切换</p>
<p>进程是由内核管理和调度的，进程上下文切换只能发生在内核态。 因此相比系统调用来说，在保存当前进程的内核状态和CPU寄存器之前，需要先把该进程的虚拟内存，栈保存下来。再加载新进程的内核态后，还要刷新进程的虚拟内存和用户栈</p>
<p>进程只有在调度到CPU上运行时才需要切换上下文，有以下几种场景：</p>
<ul>
<li>CPU时间片轮流分配</li>
<li>系统资源不足导致进程挂起</li>
<li>进程通过sleep函数主动挂起</li>
<li>高优先级进程抢占时间片</li>
<li>硬件中断时CPU上的进程被挂起转而执行内核中的中断服务</li>
</ul>
<p>要查看每个进程的详细情况，需要使用pidstat来查看每个进程上下文切换情况</p>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pidstat -w <span class="m">5</span>
</span></span><span class="line"><span class="cl">14时51分16秒   UID       PID   cswch/s nvcswch/s  Command
</span></span><span class="line"><span class="cl">14时51分21秒     <span class="m">0</span>         <span class="m">1</span>      0.80      0.00  systemd
</span></span><span class="line"><span class="cl">14时51分21秒     <span class="m">0</span>         <span class="m">6</span>      1.40      0.00  ksoftirqd/0
</span></span><span class="line"><span class="cl">14时51分21秒     <span class="m">0</span>         <span class="m">9</span>     32.67      0.00  rcu_sched
</span></span><span class="line"><span class="cl">14时51分21秒     <span class="m">0</span>        <span class="m">11</span>      0.40      0.00  watchdog/0
</span></span><span class="line"><span class="cl">14时51分21秒     <span class="m">0</span>        <span class="m">32</span>      0.20      0.00  khugepaged
</span></span><span class="line"><span class="cl">14时51分21秒     <span class="m">0</span>       <span class="m">271</span>      0.20      0.00  jbd2/vda1-8
</span></span><span class="line"><span class="cl">14时51分21秒     <span class="m">0</span>      <span class="m">1332</span>      0.20      0.00  argusagent
</span></span><span class="line"><span class="cl">14时51分21秒     <span class="m">0</span>      <span class="m">5265</span>     10.02      0.00  AliSecGuard
</span></span><span class="line"><span class="cl">14时51分21秒     <span class="m">0</span>      <span class="m">7439</span>      7.82      0.00  kworker/0:2
</span></span><span class="line"><span class="cl">14时51分21秒     <span class="m">0</span>      <span class="m">7906</span>      0.20      0.00  pidstat
</span></span><span class="line"><span class="cl">14时51分21秒     <span class="m">0</span>      <span class="m">8346</span>      0.20      0.00  sshd
</span></span><span class="line"><span class="cl">14时51分21秒     <span class="m">0</span>     <span class="m">20654</span>      9.82      0.00  AliYunDun
</span></span><span class="line"><span class="cl">14时51分21秒     <span class="m">0</span>     <span class="m">25766</span>      0.20      0.00  kworker/u2:1
</span></span><span class="line"><span class="cl">14时51分21秒     <span class="m">0</span>     <span class="m">28603</span>      1.00      0.00  python3
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># cswch 每秒自愿上下文切换次数 （进程无法获取所需资源导致的上下文切换）</span>
</span></span><span class="line"><span class="cl"><span class="c1"># nvcswch 每秒非自愿上下文切换次数 （时间片轮流等系统强制调度）</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="线程上下文切换" class="heading-element">
  <a href="#%e7%ba%bf%e7%a8%8b%e4%b8%8a%e4%b8%8b%e6%96%87%e5%88%87%e6%8d%a2" class="heading-mark"></a>线程上下文切换</h3><p>线程上下文切换分为两种：</p>
<ul>
<li>前后线程同属于一个进程，切换时虚拟内存资源不变，只需要切换线程的私有数据，寄存器等；</li>
<li>前后线程属于不同进程，与进程上下文切换相同。</li>
</ul>
<p>同进程的线程切换消耗资源较少，这也是多线程的优势。</p>
<ul>
<li>示例</li>
</ul>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 首先获取空闲系统的上下文切换次数</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># vmstat 1 1</span>
</span></span><span class="line"><span class="cl">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
</span></span><span class="line"><span class="cl"> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
</span></span><span class="line"><span class="cl"> <span class="m">1</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">3029568</span>   <span class="m">3164</span> <span class="m">465476</span>    <span class="m">0</span>    <span class="m">0</span>    <span class="m">30</span>    <span class="m">11</span>  <span class="m">165</span> <span class="m">2732</span>  <span class="m">0</span>  <span class="m">1</span> <span class="m">98</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 模拟多线程切换问题</span>
</span></span><span class="line"><span class="cl">sysbench --threads<span class="o">=</span><span class="m">10</span> --max-time<span class="o">=</span><span class="m">300</span> threads run 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 新终端观察上下文切换情况</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># vmstat 1 10</span>
</span></span><span class="line"><span class="cl">procs -----------memory---------- ---swap-- -----io---- -system--     ------cpu-----
</span></span><span class="line"><span class="cl"> r  b   swpd   free   buff  cache   si     so    bi    bo   in   cs    us sy id wa st
</span></span><span class="line"><span class="cl"> <span class="m">8</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">3027612</span>   <span class="m">3164</span> <span class="m">465612</span>    <span class="m">0</span>    <span class="m">0</span>    <span class="m">25</span>     <span class="m">9</span> <span class="m">1107</span>   <span class="m">2069</span>   <span class="m">2</span>   <span class="m">4</span> <span class="m">93</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">5</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">3027352</span>   <span class="m">3164</span> <span class="m">465612</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>     <span class="m">0</span> <span class="m">58426</span> <span class="m">1125114</span> <span class="m">25</span> <span class="m">59</span> <span class="m">16</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">6</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">3027352</span>   <span class="m">3164</span> <span class="m">465612</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>     <span class="m">0</span> <span class="m">58767</span> <span class="m">1208424</span> <span class="m">24</span> <span class="m">60</span> <span class="m">17</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">8</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">3027320</span>   <span class="m">3164</span> <span class="m">465612</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>     <span class="m">0</span> <span class="m">58383</span> <span class="m">1186721</span> <span class="m">25</span> <span class="m">60</span> <span class="m">15</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">6</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">3027352</span>   <span class="m">3164</span> <span class="m">465612</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>     <span class="m">0</span> <span class="m">58615</span> <span class="m">1117853</span> <span class="m">26</span> <span class="m">58</span> <span class="m">16</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">5</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">3027352</span>   <span class="m">3164</span> <span class="m">465612</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>     <span class="m">0</span> <span class="m">55141</span> <span class="m">1290941</span> <span class="m">25</span> <span class="m">60</span> <span class="m">15</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">7</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">3027352</span>   <span class="m">3164</span> <span class="m">465612</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>     <span class="m">0</span> <span class="m">59211</span> <span class="m">1139840</span> <span class="m">25</span> <span class="m">58</span> <span class="m">17</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">7</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">3027352</span>   <span class="m">3164</span> <span class="m">465612</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>     <span class="m">0</span> <span class="m">56423</span> <span class="m">1193208</span> <span class="m">26</span> <span class="m">59</span> <span class="m">16</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">3</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">3027352</span>   <span class="m">3164</span> <span class="m">465612</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>     <span class="m">0</span> <span class="m">57889</span> <span class="m">1205147</span> <span class="m">26</span> <span class="m">59</span> <span class="m">15</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">6</span>  <span class="m">0</span>      <span class="m">0</span> <span class="m">3027352</span>   <span class="m">3164</span> <span class="m">465612</span>    <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>     <span class="m">0</span> <span class="m">58687</span> <span class="m">1162314</span> <span class="m">25</span> <span class="m">59</span> <span class="m">16</span>  <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 此时发现cs数据明显升高，同时观察其他指标：</span>
</span></span><span class="line"><span class="cl"><span class="c1"># r列： 远超系统CPU个数，说明存在大量CPU竞争</span>
</span></span><span class="line"><span class="cl"><span class="c1"># us和sy列： sy列占比60%，说明CPU主要被内核占用</span>
</span></span><span class="line"><span class="cl"><span class="c1"># in列： 中断次数明显上升，说明中断处理也是潜在问题</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 说明运行/等待CPU的进程过多，导致大量的上下文切换，上下文切换导致系统的CPU占用率高</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看到底哪个进程导致的问题</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># pidstat -w -u 1 -t</span>
</span></span><span class="line"><span class="cl">Linux 4.18.0-348.12.2.el8_5.x86_64 <span class="o">(</span>localhost.localdomain<span class="o">)</span>      02/04/2022      _x86_64_        <span class="o">(</span><span class="m">4</span> CPU<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">04:58:42 AM   UID      TGID       TID    %usr %system  %guest   %wait    %CPU   CPU  Command
</span></span><span class="line"><span class="cl">04:58:43 AM     <span class="m">0</span>      <span class="m">3640</span>         -  104.90  228.43    0.00    0.00  333.33     <span class="m">2</span>  sysbench
</span></span><span class="line"><span class="cl">04:58:43 AM     <span class="m">0</span>         -      <span class="m">3641</span>   10.78   21.57    0.00   20.59   32.35     <span class="m">0</span>  <span class="p">|</span>__sysbench
</span></span><span class="line"><span class="cl">04:58:43 AM     <span class="m">0</span>         -      <span class="m">3642</span>   10.78   25.49    0.00   19.61   36.27     <span class="m">2</span>  <span class="p">|</span>__sysbench
</span></span><span class="line"><span class="cl">04:58:43 AM     <span class="m">0</span>         -      <span class="m">3643</span>   13.73   22.55    0.00   21.57   36.27     <span class="m">1</span>  <span class="p">|</span>__sysbench
</span></span><span class="line"><span class="cl">04:58:43 AM     <span class="m">0</span>         -      <span class="m">3644</span>    9.80   22.55    0.00   19.61   32.35     <span class="m">1</span>  <span class="p">|</span>__sysbench
</span></span><span class="line"><span class="cl">04:58:43 AM     <span class="m">0</span>         -      <span class="m">3645</span>    9.80   23.53    0.00   19.61   33.33     <span class="m">2</span>  <span class="p">|</span>__sysbench
</span></span><span class="line"><span class="cl">04:58:43 AM     <span class="m">0</span>         -      <span class="m">3646</span>    9.80   23.53    0.00   19.61   33.33     <span class="m">3</span>  <span class="p">|</span>__sysbench
</span></span><span class="line"><span class="cl">04:58:43 AM     <span class="m">0</span>         -      <span class="m">3647</span>    9.80   21.57    0.00   21.57   31.37     <span class="m">3</span>  <span class="p">|</span>__sysbench
</span></span><span class="line"><span class="cl">04:58:43 AM     <span class="m">0</span>         -      <span class="m">3648</span>   12.75   21.57    0.00   23.53   34.31     <span class="m">1</span>  <span class="p">|</span>__sysbench
</span></span><span class="line"><span class="cl">04:58:43 AM     <span class="m">0</span>         -      <span class="m">3649</span>    8.82   23.53    0.00   15.69   32.35     <span class="m">3</span>  <span class="p">|</span>__sysbench
</span></span><span class="line"><span class="cl">04:58:43 AM     <span class="m">0</span>         -      <span class="m">3650</span>    8.82   22.55    0.00   20.59   31.37     <span class="m">0</span>  <span class="p">|</span>__sysbench
</span></span><span class="line"><span class="cl">04:58:43 AM     <span class="m">0</span>      <span class="m">3651</span>         -    0.00    0.98    0.00    0.00    0.98     <span class="m">0</span>  pidstat
</span></span><span class="line"><span class="cl">04:58:43 AM     <span class="m">0</span>         -      <span class="m">3651</span>    0.00    0.98    0.00    0.00    0.98     <span class="m">0</span>  <span class="p">|</span>__pidstat
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 从结果中看出是sysbench导致CPU使用率过高，</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 但是pidstat输出的上下文次数加起来也并不多。分析sysbench模拟的是线程的切换，</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 因此需要在pidstat后加-t参数查看线程指标。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 另外对于中断次数过多，我们可以通过/proc/interrupts文件读取</span>
</span></span><span class="line"><span class="cl">watch -d cat /proc/interrupts
</span></span><span class="line"><span class="cl"><span class="c1"># 发现次数变化速度最快的是重调度中断（RES），该中断用来唤醒空闲状态的CPU来调度新的任务运行。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 分析还是因为过多任务的调度问题，和上下文切换分析一致。</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="中断上下文切换" class="heading-element">
  <a href="#%e4%b8%ad%e6%96%ad%e4%b8%8a%e4%b8%8b%e6%96%87%e5%88%87%e6%8d%a2" class="heading-mark"></a>中断上下文切换</h3><p>中断上下文切换并不涉及到进程的用户态，因此中断上下文只包括内核态中断服务程序执行所必须的状态（CPU寄存器，内核堆栈，硬件中断参数等）。</p>
<p>中断处理优先级比进程高，所以中断上下文切换和进程上下文切换不会同时发生</p>
<h2 id="性能分析工具perf" class="heading-element">
  <a href="#%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e5%b7%a5%e5%85%b7perf" class="heading-mark"></a>性能分析工具perf</h2><p>Linux作为多任务操作系统，将CPU时间划分为很短的时间片，通过调度器轮流分配给各个任务使用。为了维护CPU时间，Linux通过事先定义的节拍率，触发时间中断，并使用全局变了jiffies记录开机以来的节拍数。时间中断发生一次该值+1.</p>
<p>CPU使用率，除了空闲时间以外的其他时间占总CPU时间的百分比。可以通过/proc/stat中的数据来计算出CPU使用率。因为/proc/stat时开机以来的节拍数累加值，计算出来的是开机以来的平均CPU使用率，一般意义不大。可以间隔取一段时间的两次值作差来计算该段时间内的平均CPU使用率。 性能分析工具给出的都是间隔一段时间的平均CPU使用率，要注意间隔时间的设置。</p>
<p>分析进程的CPU问题可以通过perf，它以性能事件采样为基础，不仅可以分析系统的各种事件和内核性能，还可以用来分析指定应用程序的性能问题</p>
<div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># perf top -g -p 6170</span>
</span></span><span class="line"><span class="cl">Samples: 38K of event <span class="s1">&#39;cpu-clock:pppH&#39;</span>, <span class="m">4000</span> Hz, Event count <span class="o">(</span>approx.<span class="o">)</span>: <span class="m">8550820289</span> lost: 0/0 drop: 0/0              
</span></span><span class="line"><span class="cl">  Children      Self  Shared Object       Symbol                                                                    
</span></span><span class="line"><span class="cl">+   77.88%     7.25%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> do_syscall_64
</span></span><span class="line"><span class="cl">+   54.46%     0.16%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> __x64_sys_futex
</span></span><span class="line"><span class="cl">+   54.29%     0.08%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> do_futex
</span></span><span class="line"><span class="cl">+   50.09%     0.55%  libpthread-2.28.so  <span class="o">[</span>.<span class="o">]</span> __lll_unlock_wake
</span></span><span class="line"><span class="cl">+   49.14%     0.11%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> futex_wake
</span></span><span class="line"><span class="cl">+   48.78%     0.03%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> wake_up_q
</span></span><span class="line"><span class="cl">+   48.75%    48.74%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> _raw_spin_unlock_irqrestore
</span></span><span class="line"><span class="cl">+   48.75%     0.01%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> try_to_wake_up
</span></span><span class="line"><span class="cl">+   39.24%    16.84%  libc-2.28.so        <span class="o">[</span>.<span class="o">]</span> __sched_yield
</span></span><span class="line"><span class="cl">+   37.96%     0.00%  <span class="o">[</span>unknown<span class="o">]</span>           <span class="o">[</span>k<span class="o">]</span> <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">+   28.77%     0.00%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> entry_SYSCALL_64_after_hwframe
</span></span><span class="line"><span class="cl">+   15.50%     0.24%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> schedule
</span></span><span class="line"><span class="cl">+   15.26%     0.69%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> __sched_text_start
</span></span><span class="line"><span class="cl">+   14.46%    14.44%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> __raw_spin_unlock_irq
</span></span><span class="line"><span class="cl">+   13.76%     0.24%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> __x64_sys_sched_yield
</span></span><span class="line"><span class="cl">+   11.02%     0.11%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> finish_task_switch
</span></span><span class="line"><span class="cl">+    7.54%     1.57%  libpthread-2.28.so  <span class="o">[</span>.<span class="o">]</span> __lll_lock_wait
</span></span><span class="line"><span class="cl">+    5.07%     0.23%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> futex_wait
</span></span><span class="line"><span class="cl">+    4.54%     0.14%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> futex_wait_queue_me
</span></span><span class="line"><span class="cl">+    2.36%     2.36%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> do_sched_yield
</span></span><span class="line"><span class="cl">+    1.64%     1.64%  libpthread-2.28.so  <span class="o">[</span>.<span class="o">]</span> __pthread_mutex_unlock_usercnt
</span></span><span class="line"><span class="cl">+    1.48%     0.25%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> syscall_slow_exit_work
</span></span><span class="line"><span class="cl">+    1.23%     0.69%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> __audit_syscall_exit
</span></span><span class="line"><span class="cl">     0.89%     0.48%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> syscall_trace_enter
</span></span><span class="line"><span class="cl">+    0.71%     0.71%  libpthread-2.28.so  <span class="o">[</span>.<span class="o">]</span> __pthread_mutex_lock
</span></span><span class="line"><span class="cl">     0.30%     0.15%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> futex_wait_setup
</span></span><span class="line"><span class="cl">     0.27%     0.27%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> __audit_syscall_entry
</span></span><span class="line"><span class="cl">     0.24%     0.24%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> kfree
</span></span><span class="line"><span class="cl">     0.19%     0.19%  sysbench            <span class="o">[</span>.<span class="o">]</span> 0x000000000001ed7f
</span></span><span class="line"><span class="cl">     0.16%     0.16%  sysbench            <span class="o">[</span>.<span class="o">]</span> 0x000000000001ed89
</span></span><span class="line"><span class="cl">     0.14%     0.14%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> ktime_get_coarse_real_ts64
</span></span><span class="line"><span class="cl">     0.13%     0.09%  <span class="o">[</span>kernel<span class="o">]</span>            <span class="o">[</span>k<span class="o">]</span> _raw_spin_lock</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="进程状态" class="heading-element">
  <a href="#%e8%bf%9b%e7%a8%8b%e7%8a%b6%e6%80%81" class="heading-mark"></a>进程状态</h2><ul>
<li>R Running/Runnable，表示进程在CPU的就绪队列中，正在运行或者等待运行；</li>
<li>D Disk Sleep，不可中断状态睡眠，一般表示进程正在跟硬件交互，并且交互过程中不允许被其他进程中断；</li>
<li>Z Zombie，僵尸进程，表示进程实际上已经结束，但是父进程还没有回收它的资源；</li>
<li>S Interruptible Sleep，可中断睡眠状态，表示进程因为等待某个事件而被系统挂起，当等待事件发生则会被唤醒并进入R状态；</li>
<li>I Idle，空闲状态，用在不可中断睡眠的内核线程上。 该状态不会导致平均负载升高；</li>
<li>T Stop/Traced，表示进程处于暂停或跟踪状态（SIGSTOP/SIGCONT， GDB调试）；</li>
<li>X Dead，进程已经消亡，不会在top/ps中看到。</li>
</ul>
<p>对于不可中断状态，一般都是在很短时间内结束，可忽略。但是如果系统或硬件发生故障，进程可能会保持不可中断状态很久，甚至系统中出现大量不可中断状态，此时需注意是否出现了I/O性能问题。</p>
<p>僵尸进程一般多进程应用容易遇到，父进程来不及处理子进程状态时子进程就提前退出，此时子进程就变成了僵尸进程。大量的僵尸进程会用尽PID进程号，导致新进程无法建立。</p>
<h2 id="性能工具" class="heading-element">
  <a href="#%e6%80%a7%e8%83%bd%e5%b7%a5%e5%85%b7" class="heading-mark"></a>性能工具</h2><p>平均负载案例</p>
<ul>
<li>先用uptime查看系统平均负载</li>
<li>判断负载在升高后再用mpstat和pidstat分别查看每个CPU和每个进程CPU使用情况.找出导致平均负载较高的进程</li>
</ul>
<p>上下文切换案例</p>
<ul>
<li>先用vmstat查看系统上下文切换和中断次数</li>
<li>再用pidstat观察进程的自愿和非自愿上下文切换情况</li>
<li>最后通过pidstat观察线程的上下文切换情况</li>
</ul>
<p>进程CPU使用率高案例</p>
<ul>
<li>先用top查看系统和进程的CPU使用情况,定位到进程</li>
<li>再用perf top观察进程调用链,定位到具体函数</li>
</ul>
<p>系统CPU使用率高案例</p>
<ul>
<li>先用top查看系统和进程的CPU使用情况,top/pidstat都无法找到CPU使用率高的进程</li>
<li>重新审视top输出</li>
<li>从CPU使用率不高,但是处于Running状态的进程入手</li>
<li>perf record/report发现短时进程导致 (execsnoop工具)</li>
</ul>
<p>不可中断和僵尸进程案例</p>
<ul>
<li>先用top观察iowait升高,发现大量不可中断和僵尸进程</li>
<li>strace无法跟踪进程系统调用</li>
<li>perf分析调用链发现根源来自磁盘直接I/O</li>
</ul>
<p>软中断案例</p>
<ul>
<li>top观察系统软中断CPU使用率高</li>
<li>查看<code>watch -d -n 1 'cat /proc/softirqs'</code>找到变化速率较快的几种软中断</li>
<li>sar命令发现是网络小包问题</li>
<li>tcpdump找出网络帧的类型和来源, 确定SYN FLOOD攻击导致</li>
</ul>
<h1 id="内存" class="heading-element">
  <a href="#%e5%86%85%e5%ad%98" class="heading-mark"></a>内存</h1><h2 id="内存映射" class="heading-element">
  <a href="#%e5%86%85%e5%ad%98%e6%98%a0%e5%b0%84" class="heading-mark"></a>内存映射</h2><p>大多数计算机用的主存都是动态随机访问内存(DRAM)，只有内核才可以直接访问物理内存。Linux内核给每个进程提供了一个独立的虚拟地址空间，并且这个地址空间是连续的。这样进程就可以很方便的访问内存(虚拟内存)。</p>
<p>虚拟地址空间的内部分为内核空间和用户空间两部分，不同字长的处理器地址空间的范围不同。32位系统内核空间占用1G，用户空间占3G。 64位系统内核空间和用户空间都是128T，分别占内存空间的最高和最低处，中间部分为未定义。</p>
<p>并不是所有的虚拟内存都会分配物理内存，只有实际使用的才会。分配后的物理内存通过内存映射管理。为了完成内存映射，内核为每个进程都维护了一个页表，记录虚拟地址和物理地址的映射关系。页表实际存储在CPU的内存管理单元MMU中，处理器可以直接通过硬件找出要访问的内存。</p>
<p>当进程访问的虚拟地址在页表中查不到时，系统会产生一个缺页异常，进入内核空间分配物理内存，更新进程页表，再返回用户空间恢复进程的运行。</p>
<p>MMU以页为单位管理内存，页大小4KB。为了解决页表项过多问题Linux提供了多级页表和HugePage的机制。</p>
<h2 id="虚拟内存空间分布" class="heading-element">
  <a href="#%e8%99%9a%e6%8b%9f%e5%86%85%e5%ad%98%e7%a9%ba%e9%97%b4%e5%88%86%e5%b8%83" class="heading-mark"></a>虚拟内存空间分布</h2><p>用户空间内存从低到高是五种不同的内存段：</p>
<ul>
<li>只读段 代码和常量等</li>
<li>数据段 全局变量等</li>
<li>堆 动态分配的内存，从低地址开始向上增长</li>
<li>文件映射 动态库、共享内存等，从高地址开始向下增长</li>
<li>栈 包括局部变量和函数调用的上下文等，栈的大小是固定的。一般8MB</li>
</ul>
<h2 id="内存分配" class="heading-element">
  <a href="#%e5%86%85%e5%ad%98%e5%88%86%e9%85%8d" class="heading-mark"></a>内存分配</h2><p>malloc对应到系统调用上有两种实现方式：</p>
<ul>
<li>brk() 针对小块内存(&lt;128K)，通过移动堆顶位置来分配。内存释放后不立即归还内存，而是被缓存起来。</li>
<li>**mmap()**针对大块内存(&gt;128K)，直接用内存映射来分配，即在文件映射段找一块空闲内存分配。</li>
</ul>
<p>前者的缓存可以减少缺页异常的发生，提高内存访问效率。但是由于内存没有归还系统，在内存工作繁忙时，频繁的内存分配/释放会造成内存碎片。
，后者在释放时直接归还系统，所以每次mmap都会发生缺页异常。在内存工作繁忙时，频繁内存分配会导致大量缺页异常，使内核管理负担增加。</p>
<p>上述两种调用并没有真正分配内存，这些内存只有在首次访问时，才通过缺页异常进入内核中，由内核来分配</p>
<h2 id="内存回收" class="heading-element">
  <a href="#%e5%86%85%e5%ad%98%e5%9b%9e%e6%94%b6" class="heading-mark"></a>内存回收</h2><p>内存紧张时，系统通过以下方式来回收内存：</p>
<ul>
<li>回收缓存： LRU算法回收最近最少使用的内存页面；</li>
<li>回收不常访问内存： 把不常用的内存通过交换分区写入磁盘</li>
</ul>
<p>杀死进程： OOM内核保护机制 （进程消耗内存越大oom_score越大，占用CPU越多oom_score越小，可以通过/proc手动调整oom_adj）</p>
<div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> -16 &gt; /proc/<span class="k">$(</span>pidof XXX<span class="k">)</span>/oom_adj</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="如何查看内存使用情况" class="heading-element">
  <a href="#%e5%a6%82%e4%bd%95%e6%9f%a5%e7%9c%8b%e5%86%85%e5%ad%98%e4%bd%bf%e7%94%a8%e6%83%85%e5%86%b5" class="heading-mark"></a>如何查看内存使用情况</h2><p>free来查看整个系统的内存使用情况</p>
<p>top/ps来查看某个进程的内存使用情况</p>
<ul>
<li>VIRT 进程的虚拟内存大小</li>
<li>RES 常驻内存的大小，即进程实际使用的物理内存大小，不包括swap和共享内存</li>
<li>SHR 共享内存大小，与其他进程共享的内存，加载的动态链接库以及程序代码段</li>
<li>%MEM 进程使用物理内存占系统总内存的百分比</li>
</ul>
<h2 id="内存中的buffer和cache" class="heading-element">
  <a href="#%e5%86%85%e5%ad%98%e4%b8%ad%e7%9a%84buffer%e5%92%8ccache" class="heading-mark"></a>内存中的Buffer和Cache</h2><p>buffer是对磁盘数据的缓存，cache是对文件数据的缓存，它们既会用在读请求也会用在写请求中</p>
<h2 id="缓存命中率" class="heading-element">
  <a href="#%e7%bc%93%e5%ad%98%e5%91%bd%e4%b8%ad%e7%8e%87" class="heading-mark"></a>缓存命中率</h2><p>缓存命中率是指直接通过缓存获取数据的请求次数，占所有请求次数的百分比。命中率越高说明缓存带来的收益越高，应用程序的性能也就越好。</p>
<p>安装bcc包后可以通过cachestat和cachetop来监测缓存的读写命中情况。
；安装pcstat后可以查看文件在内存中的缓存大小以及缓存比例</p>
<ul>
<li>dd缓存加速</li>
</ul>
<div class="highlight" id="id-6"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">dd <span class="k">if</span><span class="o">=</span>/dev/sda1 <span class="nv">of</span><span class="o">=</span>file <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span><span class="m">512</span> <span class="c1">#生产一个512MB的临时文件</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">3</span> &gt; /proc/sys/vm/drop_caches <span class="c1">#清理缓存</span>
</span></span><span class="line"><span class="cl">pcstat file <span class="c1">#确定刚才生成文件不在系统缓存中，此时cached和percent都是0</span>
</span></span><span class="line"><span class="cl">cachetop <span class="m">5</span>
</span></span><span class="line"><span class="cl">dd <span class="k">if</span><span class="o">=</span>file <span class="nv">of</span><span class="o">=</span>/dev/null <span class="nv">bs</span><span class="o">=</span>1M <span class="c1">#测试文件读取速度</span>
</span></span><span class="line"><span class="cl"><span class="c1">#此时文件读取性能为30+MB/s，查看cachetop结果发现并不是所有的读都落在磁盘上，读缓存命中率只有50%。</span>
</span></span><span class="line"><span class="cl">dd <span class="k">if</span><span class="o">=</span>file <span class="nv">of</span><span class="o">=</span>/dev/null <span class="nv">bs</span><span class="o">=</span>1M <span class="c1">#重复上述读文件测试</span>
</span></span><span class="line"><span class="cl"><span class="c1">#此时文件读取性能为4+GB/s，读缓存命中率为100%</span>
</span></span><span class="line"><span class="cl">pcstat file <span class="c1">#查看文件file的缓存情况，100%全部缓存</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>O_DIRECT选项绕过系统缓存</li>
</ul>
<div class="highlight" id="id-7"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cachetop <span class="m">5</span>
</span></span><span class="line"><span class="cl">sudo docker run --privileged --name<span class="o">=</span>app -itd feisky/app:io-direct
</span></span><span class="line"><span class="cl">sudo docker logs app <span class="c1">#确认案例启动成功</span>
</span></span><span class="line"><span class="cl"><span class="c1">#实验结果表明每读32MB数据都要花0.9s，且cachetop输出中显示1024次缓存全部命中</span></span></span></code></pre></td></tr></table>
</div>
</div><p>但是凭感觉可知如果缓存命中读速度不应如此慢，读次数时1024，页大小为4K，五秒的时间内读取了1024*4KB数据，即每秒0.8MB，和结果中32MB相差较大。说明该案例没有充分利用缓存，怀疑系统调用设置了直接I/O标志绕过系统缓存。因此接下来观察系统调用.</p>
<div class="highlight" id="id-8"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">strace -p <span class="k">$(</span>pgrep app<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#strace 结果可以看到openat打开磁盘分区/dev/sdb1，传入参数为O_RDONLY|O_DIRECT</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这就解释了为什么读32MB数据那么慢，直接从磁盘读写肯定远远慢于缓存。找出问题后我们再看案例的源代码发现flags中指定了直接IO标志。删除该选项后重跑，验证性能变化。</p>
<h2 id="内存泄漏" class="heading-element">
  <a href="#%e5%86%85%e5%ad%98%e6%b3%84%e6%bc%8f" class="heading-mark"></a>内存泄漏</h2><p>对应用程序来说，动态内存的分配和回收是核心又复杂的一个逻辑功能模块。管理内存的过程中会发生各种各样的“事故”：</p>
<ul>
<li>没正确回收分配的内存，导致了泄漏</li>
<li>访问的是已分配内存边界外的地址，导致程序异常退出</li>
</ul>
<p>虚拟内存分布从低到高分别是只读段，数据段，堆，内存映射段，栈五部分。其中会导致内存泄漏的是：</p>
<ul>
<li>堆： 由应用程序自己来分配和管理，除非程序退出这些堆内存不会被系统自动释放。</li>
<li>内存映射段：包括动态链接库和共享内存，其中共享内存由程序自动分配和管理</li>
</ul>
<p>内存泄漏的危害比较大，这些忘记释放的内存，不仅应用程序自己不能访问，系统也不能把它们再次分配给其他应用。 内存泄漏不断累积甚至会耗尽系统内存.</p>
<p><code>memleak</code>检测内存泄漏</p>
<div class="highlight" id="id-9"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo docker run --name<span class="o">=</span>app -itd feisky/app:mem-leak
</span></span><span class="line"><span class="cl">sudo docker logs app
</span></span><span class="line"><span class="cl">vmstat <span class="m">3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 可以看到free在不断下降，buffer和cache基本保持不变。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 说明系统的内存一致在升高。但并不能说明存在内存泄漏。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 此时可以通过memleak工具来跟踪系统或进程的内存分配/释放请求</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/usr/share/bcc/tools/memleak -a -p <span class="k">$(</span>pidof app<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 从memleak输出可以看到，应用在不停地分配内存，</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 并且这些分配的地址并没有被回收。通过调用栈看到是</span>
</span></span><span class="line"><span class="cl"><span class="c1"># fibonacci函数分配的内存没有释放。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 定位到源码后查看源码来修复增加内存释放函数即可.</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="swap原理" class="heading-element">
  <a href="#swap%e5%8e%9f%e7%90%86" class="heading-mark"></a>Swap原理</h2><p>Swap本质就是把一块磁盘空间或者一个本地文件当作内存来使用，包括换入和换出两个过程：</p>
<ul>
<li>换出： 将进程暂时不用的内存数据存储到磁盘中，并释放这些内存</li>
<li>换入： 进程再次访问内存时，将它们从磁盘读到内存中</li>
</ul>
<p>Linux如何衡量内存资源是否紧张？</p>
<ul>
<li>直接内存回收 新的大块内存分配请求，但剩余内存不足。此时系统会回收一部分内存；</li>
<li>kswapd0 内核线程定期回收内存。为了衡量内存使用情况，定义了pages_min,pages_low,pages_high三个阈值，并根据其来进行内存的回收操作。
<ul>
<li>剩余内存 &lt; pages_min，进程可用内存耗尽了，只有内核才可以分配内存</li>
<li>pages_min &lt; 剩余内存 &lt; pages_low,内存压力较大，kswapd0执行内存回收，直到剩余内存 &gt; pages_high</li>
<li>pages_low &lt; 剩余内存 &lt; pages_high，内存有一定压力，但可以满足新内存请求</li>
<li>剩余内存 &gt; pages_high，说明剩余内存较多，无内存压力</li>
<li>pages_low = pages_min 5 / 4 pages_high = pages_min 3 / 2</li>
</ul>
</li>
</ul>
<p>系统内存资源紧张时通过内存回收和OOM杀死进程来解决。其中可回收内存包括：</p>
<ul>
<li>缓存/缓冲区，属于可回收资源，在文件管理中通常叫做文件页</li>
<li>被应用程序修改过暂时没写入磁盘的数据(脏页)，要先写入磁盘然后才能内存释放</li>
<li>在应用程序中通过fsync将脏页同步到磁盘</li>
<li>交给系统，内核线程pdflush负责这些脏页的刷新</li>
<li>内存映射获取的文件映射页，也可以被释放掉，下次访问时从文件重新读取</li>
</ul>
<p>对于程序自动分配的堆内存，也就是我们在内存管理中的匿名页，虽然这些内存不能直接释放，
但是Linux提供了Swap机制将不常访问的内存写入到磁盘来释放内存，再次访问时从磁盘读取到内存即可。</p>
<h2 id="numa-与-swap" class="heading-element">
  <a href="#numa-%e4%b8%8e-swap" class="heading-mark"></a>NUMA 与 SWAP</h2><p>很多情况下系统剩余内存较多，但SWAP依旧升高，这是由于处理器的NUMA架构。
在NUMA架构下多个处理器划分到不同的Node，每个Node都拥有自己的本地内存空间。
在分析内存的使用时应该针对每个Node单独分析</p>
<div class="highlight" id="id-10"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">numactl --hardware <span class="c1">#查看处理器在Node的分布情况，以及每个Node的内存使用情况</span></span></span></code></pre></td></tr></table>
</div>
</div><p>内存三个阈值可以通过/proc/zoneinfo来查看，该文件中还包括活跃和非活跃的匿名页/文件页数。</p>
<p>当某个Node内存不足时，系统可以从其他Node寻找空闲资源，也可以从本地内存中回收内存。 通过/proc/sys/vm/zone_raclaim_mode来调整。</p>
<ul>
<li>0表示既可以从其他Node寻找空闲资源，也可以从本地回收内存</li>
<li>1表示只回收本地内存，</li>
<li>2表示可以会回脏数据回收内存，</li>
<li>4表示可以用Swap方式回收内存。</li>
</ul>
<h2 id="swappiness" class="heading-element">
  <a href="#swappiness" class="heading-mark"></a>swappiness</h2><p>在实际回收过程中Linux根据/proc/sys/vm/swapiness选项来调整使用Swap的积极程度，
从0-100，数值越大越积极使用Swap，即更倾向于回收匿名页；数值越小越消极使用Swap，即更倾向于回收文件页。</p>
<p>注意：这只是调整Swap积极程度的权重，即使设置为0，当剩余内存+文件页小于页高阈值时，还是会发生Swap。</p>
<ul>
<li>Swap升高时定位分析示例</li>
</ul>
<div class="highlight" id="id-11"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">free <span class="c1">#首先通过free查看swap使用情况，若swap=0表示未配置Swap</span>
</span></span><span class="line"><span class="cl"><span class="c1">#先创建并开启swap</span>
</span></span><span class="line"><span class="cl">fallocate -l 8G /mnt/swapfile
</span></span><span class="line"><span class="cl">chmod <span class="m">600</span> /mnt/swapfile
</span></span><span class="line"><span class="cl">mkswap /mnt/swapfile
</span></span><span class="line"><span class="cl">swapon /mnt/swapfile
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">free <span class="c1">#再次执行free确保Swap配置成功</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">dd <span class="k">if</span><span class="o">=</span>/dev/sda1 <span class="nv">of</span><span class="o">=</span>/dev/null <span class="nv">bs</span><span class="o">=</span>1G <span class="nv">count</span><span class="o">=</span><span class="m">2048</span> <span class="c1">#模拟大文件读取</span>
</span></span><span class="line"><span class="cl">sar -r -S <span class="m">1</span>  <span class="c1">#查看内存各个指标变化 -r内存 -S swap</span>
</span></span><span class="line"><span class="cl"><span class="c1">#根据结果可以看出，%memused在不断增长，剩余内存kbmemfress不断减少，缓冲区kbbuffers不断增大，由此可知剩余内存不断分配给了缓冲区</span>
</span></span><span class="line"><span class="cl"><span class="c1">#一段时间之后，剩余内存很小，而缓冲区占用了大部分内存。此时Swap使用之间增大，缓冲区和剩余内存只在小范围波动</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 停下sar命令</span>
</span></span><span class="line"><span class="cl">cachetop5 <span class="c1">#观察缓存</span>
</span></span><span class="line"><span class="cl"><span class="c1">#可以看到dd进程读写只有50%的命中率，未命中数为4w+页，说明正式dd进程导致缓冲区使用升高</span>
</span></span><span class="line"><span class="cl">watch -d grep -A <span class="m">15</span> ‘Normal’ /proc/zoneinfo <span class="c1">#观察内存指标变化</span>
</span></span><span class="line"><span class="cl"><span class="c1">#发现升级内存在一个小范围不停的波动，低于页低阈值时会突然增大到一个大于页高阈值的值</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 说明剩余内存和缓冲区的波动变化正是由于内存回收和缓存再次分配的循环往复。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 有时候Swap用的多，有时候缓冲区波动更多。此时查看swappiness值为60，</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 是一个相对中和的配置，系统会根据实际运行情况来选去合适的回收类型.</span></span></span></code></pre></td></tr></table>
</div>
</div><h1 id="相关命令说明" class="heading-element">
  <a href="#%e7%9b%b8%e5%85%b3%e5%91%bd%e4%bb%a4%e8%af%b4%e6%98%8e" class="heading-mark"></a>相关命令说明</h1><h2 id="top" class="heading-element">
  <a href="#top" class="heading-mark"></a>top</h2><p><code>top</code>命令是<code>Linux</code>下常用的性能分析工具，能够实时显示系统中各个进程的资源占用状况
，类似于<code>Windows</code>的任务管理器</p>
<div class="highlight" id="id-12"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@xiaosi bash<span class="o">]</span><span class="c1"># top -h</span>
</span></span><span class="line"><span class="cl">  procps-ng 3.3.15
</span></span><span class="line"><span class="cl">Usage:
</span></span><span class="line"><span class="cl">  top -hv <span class="p">|</span> -bcEHiOSs1 -d secs -n max -u<span class="p">|</span>U user -p pid<span class="o">(</span>s<span class="o">)</span> -o field -w <span class="o">[</span>cols<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 选项说明</span>
</span></span><span class="line"><span class="cl">-b 批处理
</span></span><span class="line"><span class="cl">-c 显示完整的治命令
</span></span><span class="line"><span class="cl">-I 忽略失效过程
</span></span><span class="line"><span class="cl">-s 保密模式
</span></span><span class="line"><span class="cl">-S 累积模式
</span></span><span class="line"><span class="cl">-i&lt;时间&gt; 设置间隔时间
</span></span><span class="line"><span class="cl">-u&lt;用户名&gt; 指定用户名
</span></span><span class="line"><span class="cl">-p&lt;进程号&gt; 指定进程
</span></span><span class="line"><span class="cl">-n&lt;次数&gt; 循环显示的次数
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 交互界面中使用h键可获得以下交互按键信息</span>
</span></span><span class="line"><span class="cl">Help <span class="k">for</span> Interactive Commands - procps-ng 3.3.15
</span></span><span class="line"><span class="cl">Window 1:Def: Cumulative mode Off.  System: Delay 3.0 secs<span class="p">;</span> Secure mode Off.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Z,B,E,e   Global: <span class="s1">&#39;Z&#39;</span> colors<span class="p">;</span> <span class="s1">&#39;B&#39;</span> bold<span class="p">;</span> <span class="s1">&#39;E&#39;</span>/<span class="s1">&#39;e&#39;</span> summary/task memory scale
</span></span><span class="line"><span class="cl">  l,t,m     Toggle Summary: <span class="s1">&#39;l&#39;</span> load avg<span class="p">;</span> <span class="s1">&#39;t&#39;</span> task/cpu stats<span class="p">;</span> <span class="s1">&#39;m&#39;</span> memory info
</span></span><span class="line"><span class="cl">  0,1,2,3,I Toggle: <span class="s1">&#39;0&#39;</span> zeros<span class="p">;</span> <span class="s1">&#39;1/2/3&#39;</span> cpus or numa node views<span class="p">;</span> <span class="s1">&#39;I&#39;</span> Irix mode
</span></span><span class="line"><span class="cl">  f,F,X     Fields: <span class="s1">&#39;f&#39;</span>/<span class="s1">&#39;F&#39;</span> add/remove/order/sort<span class="p">;</span> <span class="s1">&#39;X&#39;</span> increase fixed-width
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  L,<span class="p">&amp;</span>,&lt;,&gt; . Locate: <span class="s1">&#39;L&#39;</span>/<span class="s1">&#39;&amp;&#39;</span> find/again<span class="p">;</span> Move sort column: <span class="s1">&#39;&lt;&#39;</span>/<span class="s1">&#39;&gt;&#39;</span> left/right
</span></span><span class="line"><span class="cl">  R,H,V,J . Toggle: <span class="s1">&#39;R&#39;</span> Sort<span class="p">;</span> <span class="s1">&#39;H&#39;</span> Threads<span class="p">;</span> <span class="s1">&#39;V&#39;</span> Forest view<span class="p">;</span> <span class="s1">&#39;J&#39;</span> Num justify
</span></span><span class="line"><span class="cl">  c,i,S,j . Toggle: <span class="s1">&#39;c&#39;</span> Cmd name/line<span class="p">;</span> <span class="s1">&#39;i&#39;</span> Idle<span class="p">;</span> <span class="s1">&#39;S&#39;</span> Time<span class="p">;</span> <span class="s1">&#39;j&#39;</span> Str justify
</span></span><span class="line"><span class="cl">  x,y     . Toggle highlights: <span class="s1">&#39;x&#39;</span> sort field<span class="p">;</span> <span class="s1">&#39;y&#39;</span> running tasks
</span></span><span class="line"><span class="cl">  z,b     . Toggle: <span class="s1">&#39;z&#39;</span> color/mono<span class="p">;</span> <span class="s1">&#39;b&#39;</span> bold/reverse <span class="o">(</span>only <span class="k">if</span> <span class="s1">&#39;x&#39;</span> or <span class="s1">&#39;y&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  u,U,o,O . Filter by: <span class="s1">&#39;u&#39;</span>/<span class="s1">&#39;U&#39;</span> effective/any user<span class="p">;</span> <span class="s1">&#39;o&#39;</span>/<span class="s1">&#39;O&#39;</span> other criteria
</span></span><span class="line"><span class="cl">  n,#,^O  . Set: <span class="s1">&#39;n&#39;</span>/<span class="s1">&#39;#&#39;</span> max tasks displayed<span class="p">;</span> Show: Ctrl+<span class="s1">&#39;O&#39;</span> other filter<span class="o">(</span>s<span class="o">)</span>
</span></span><span class="line"><span class="cl">  C,...   . Toggle scroll coordinates msg <span class="k">for</span>: up,down,left,right,home,end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  k,r       Manipulate tasks: <span class="s1">&#39;k&#39;</span> kill<span class="p">;</span> <span class="s1">&#39;r&#39;</span> renice
</span></span><span class="line"><span class="cl">  d or s    Set update interval
</span></span><span class="line"><span class="cl">  W,Y       Write configuration file <span class="s1">&#39;W&#39;</span><span class="p">;</span> Inspect other output <span class="s1">&#39;Y&#39;</span>
</span></span><span class="line"><span class="cl">  q         Quit
</span></span><span class="line"><span class="cl">          <span class="o">(</span> commands shown with <span class="s1">&#39;.&#39;</span> require a visible task display window <span class="o">)</span> 
</span></span><span class="line"><span class="cl">Press <span class="s1">&#39;h&#39;</span> or <span class="s1">&#39;?&#39;</span> <span class="k">for</span> <span class="nb">help</span> with Windows,
</span></span><span class="line"><span class="cl">Type <span class="s1">&#39;q&#39;</span> or &lt;Esc&gt; to <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">1：可监控每个逻辑CPU的状况
</span></span><span class="line"><span class="cl">b：高亮显示当前运行进程
</span></span><span class="line"><span class="cl">当前CPU百分比排序：P
</span></span><span class="line"><span class="cl">查看CPU核心使用：1
</span></span><span class="line"><span class="cl">查看cou信息：t
</span></span><span class="line"><span class="cl">按内存使用率排序：M
</span></span><span class="line"><span class="cl">关闭或开启第一行：l
</span></span><span class="line"><span class="cl">按进程执行时间排序：T
</span></span><span class="line"><span class="cl">修改刷新时间间隔：s（秒）
</span></span><span class="line"><span class="cl">终止指定进程：k</span></span></code></pre></td></tr></table>
</div>
</div><p><code>top</code>输出</p>
<div class="highlight" id="id-13"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#解释</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xiaosi ~<span class="o">]</span><span class="c1"># top</span>
</span></span><span class="line"><span class="cl"><span class="c1"># top -系统当前时间 up 运行时长，当前在线用户，CPU负载均衡：平均1分钟，平均5分钟，平均15分钟</span>
</span></span><span class="line"><span class="cl">top - 11:23:50 up  2:47,  <span class="m">1</span> user,  load average: 0.00, 0.00, 0.00
</span></span><span class="line"><span class="cl"><span class="c1"># 任务进程：总进程，运行进程，进程睡眠，停止进程，僵死进程</span>
</span></span><span class="line"><span class="cl">Tasks:     <span class="m">165</span> total,   <span class="m">1</span> running, <span class="m">164</span> sleeping,   <span class="m">0</span> stopped,   <span class="m">0</span> zombie
</span></span><span class="line"><span class="cl"><span class="c1"># CPU平均使用率：用户进程，系统进程，调整优先级的进程，当前空闲率，等待磁盘IO完成进程时间，硬见中断，软中断，CPU处理时间</span>
</span></span><span class="line"><span class="cl">%Cpu<span class="o">(</span>s<span class="o">)</span>:        0.0 us,  0.1 sy,  0.0 ni,         99.8 id,  0.0 wa,              0.1 hi,  0.1 si,  0.0 st
</span></span><span class="line"><span class="cl"><span class="c1"># (单位)物理内存：总大小，空闲大小，使用大小，缓冲大小</span>
</span></span><span class="line"><span class="cl">MiB Mem :   3710.0 total,   3220.0 free,    246.5 used,    243.5 buff/cache
</span></span><span class="line"><span class="cl"><span class="c1">#(单位)交换分区：总大小，空闲大小，使用情况，缓冲大小</span>
</span></span><span class="line"><span class="cl">MiB Mem :   3710.0 total,   3220.0 free,    246.5 used,    243.5 buff/cache
</span></span><span class="line"><span class="cl">PID：进程id
</span></span><span class="line"><span class="cl">USER：进程所有者
</span></span><span class="line"><span class="cl">PR：进程优先级
</span></span><span class="line"><span class="cl">NI：nice值。负值表示高优先级，正值表示低优先级
</span></span><span class="line"><span class="cl">VIRT：进程使用的虚拟内存总量，单位kb。VIRT<span class="o">=</span>SWAP+RES
</span></span><span class="line"><span class="cl">RES：进程使用的、未被换出的物理内存大小，单位kb。RES<span class="o">=</span>CODE+DATA
</span></span><span class="line"><span class="cl">SHR：共享内存大小，单位kb
</span></span><span class="line"><span class="cl">S：进程状态。D<span class="o">=</span>不可中断的睡眠状态 <span class="nv">R</span><span class="o">=</span>运行 <span class="nv">S</span><span class="o">=</span>睡眠 <span class="nv">T</span><span class="o">=</span>跟踪/停止 <span class="nv">Z</span><span class="o">=</span>僵尸进程
</span></span><span class="line"><span class="cl">%CPU：上次更新到现在的CPU时间占用百分比
</span></span><span class="line"><span class="cl">%MEM：进程使用的物理内存百分比
</span></span><span class="line"><span class="cl">TIME+：进程使用的CPU时间总计，单位1/100秒
</span></span><span class="line"><span class="cl">COMMAND：进程名称（命令名/命令行）
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                                                            
</span></span><span class="line"><span class="cl">   <span class="m">5126</span> root      <span class="m">20</span>   <span class="m">0</span>   <span class="m">65436</span>   <span class="m">4340</span>   <span class="m">3664</span> R   0.7   0.1   0:00.04 top                                                                
</span></span><span class="line"><span class="cl">     <span class="m">11</span> root      <span class="m">20</span>   <span class="m">0</span>       <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> I   0.3   0.0   0:08.33 rcu_sched                                                          
</span></span><span class="line"><span class="cl">    <span class="m">914</span> root      <span class="m">20</span>   <span class="m">0</span>  <span class="m">124992</span>   <span class="m">5404</span>   <span class="m">4772</span> S   0.3   0.1   0:00.81 irqbalance                                                         
</span></span><span class="line"><span class="cl">    <span class="m">922</span> root      <span class="m">20</span>   <span class="m">0</span>  <span class="m">278356</span>  <span class="m">10584</span>   <span class="m">8960</span> S   0.3   0.3   0:13.78 vmtoolsd                                                           
</span></span><span class="line"><span class="cl">      <span class="m">1</span> root      <span class="m">20</span>   <span class="m">0</span>  <span class="m">186352</span>  <span class="m">14408</span>   <span class="m">9716</span> S   0.0   0.4   0:03.12 systemd                                                            
</span></span><span class="line"><span class="cl">      <span class="m">2</span> root      <span class="m">20</span>   <span class="m">0</span>       <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> S   0.0   0.0   0:00.03 kthreadd                                                           
</span></span><span class="line"><span class="cl">      <span class="m">3</span> root       <span class="m">0</span> -20       <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> I   0.0   0.0   0:00.00 rcu_gp                                                             
</span></span><span class="line"><span class="cl">      <span class="m">4</span> root       <span class="m">0</span> -20       <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> I   0.0   0.0   0:00.00 rcu_par_gp                                                         
</span></span><span class="line"><span class="cl">      <span class="m">6</span> root       <span class="m">0</span> -20       <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> I   0.0   0.0   0:00.00 kworker/0:0H-events_highpri                                        
</span></span><span class="line"><span class="cl">      <span class="m">9</span> root       <span class="m">0</span> -20       <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> I   0.0   0.0   0:00.00 mm_percpu_wq                                                       
</span></span><span class="line"><span class="cl">     <span class="m">10</span> root      <span class="m">20</span>   <span class="m">0</span>       <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> S   0.0   0.0   0:00.02 ksoftirqd/0                                                        
</span></span><span class="line"><span class="cl">     <span class="m">12</span> root      rt   <span class="m">0</span>       <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> S   0.0   0.0   0:00.05 migration/0                                                        
</span></span><span class="line"><span class="cl">     <span class="m">13</span> root      rt   <span class="m">0</span>       <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> S   0.0   0.0   0:00.03 watchdog/0                                                         
</span></span><span class="line"><span class="cl">     <span class="m">14</span> root      <span class="m">20</span>   <span class="m">0</span>       <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> S   0.0   0.0   0:00.00 cpuhp/0                                                            
</span></span><span class="line"><span class="cl">     <span class="m">15</span> root      <span class="m">20</span>   <span class="m">0</span>       <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> S   0.0   0.0   0:00.00 cpuhp/1                                                            
</span></span><span class="line"><span class="cl">...</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>第一行后面的三个值是系统在之前 1、5、15 的平均负载，也可以看出系统负载是上升、平稳、下降的趋势，当这个值超过 CPU 可执行单元的数目，则表示 CPU 的性能已经饱和成为瓶颈了。</li>
<li>第二行统计了系统的任务状态信息。running 很自然不必多说，包括正在 CPU 上运行的和将要被调度运行的；sleeping 通常是等待事件(比如 IO 操作)完成的任务，细分可以包括 interruptible 和 uninterruptible 的类型；stopped 是一些被暂停的任务，通常发送 SIGSTOP 或者对一个前台任务操作 Ctrl-Z 可以将其暂停；zombie 僵尸任务，虽然进程终止资源会被自动回收，但是含有退出任务的 task descriptor 需要父进程访问后才能释放，这种进程显示为 defunct 状态，无论是因为父进程提前退出还是未 wait 调用，出现这种进程都应该格外注意程序是否设计有误。</li>
<li>(us) user：CPU 在低 nice 值(高优先级)用户态所占用的时间(nice&lt;=0)。正常情况下只要服务器不是很闲，那么大部分的 CPU 时间应该都在此执行这类程序</li>
<li>(sy) system：CPU 处于内核态所占用的时间，操作系统通过系统调用(system call)从用户态陷入内核态，以执行特定的服务；通常情况下该值会比较小，但是当服务器执行的 IO 比较密集的时候，该值会比较大</li>
<li>(ni) nice：CPU 在高 nice 值(低优先级)用户态以低优先级运行占用的时间(nice&gt;0)。默认新启动的进程 nice=0，是不会计入这里的，除非手动通过 renice 或者 setpriority() 的方式修改程序的nice值</li>
<li>(id) idle：CPU 在空闲状态(执行 kernel idle handler )所占用的时间</li>
<li>(wa) iowait：等待 IO 完成做占用的时间</li>
<li>(hi) irq：系统处理硬件中断所消耗的时间</li>
<li>(si) softirq：系统处理软中断所消耗的时间，记住软中断分为 softirqs、tasklets (其实是前者的特例)、work queues，不知道这里是统计的是哪些的时间，毕竟 work queues 的执行已经不是中断上下文了</li>
<li>(st) steal：在虚拟机情况下才有意义，因为虚拟机下 CPU 也是共享物理 CPU 的，所以这段时间表明虚拟机等待 hypervisor 调度 CPU 的时间，也意味着这段时间 hypervisor 将 CPU 调度给别的 CPU 执行，这个时段的 CPU 资源被“stolen”了。这个值在我 KVM 的 VPS 机器上是不为 0 的，但也只有 0.1 这个数量级，是不是可以用来判断 VPS 超售的情况？</li>
<li>total = free + used + buff/cache，这两个值就是 /proc/meminfo 中的 Buffers 和 Cached 字段：Buffers 是针对 raw disk 的块缓存，主要是以 raw block 的方式缓存文件系统的元数据(比如超级块信息等)，这个值一般比较小(20M左右)；而 Cached 是针对于某些具体的文件进行读缓存，以增加文件的访问效率而使用的，可以说是用于文件系统中文件缓存使用。</li>
<li>avail Mem 是一个新的参数值，用于指示在不进行交换的情况下，可以给新开启的程序多少内存空间，大致和 free + buff/cached 相当，而这也印证了上面的说法，free + buffers + cached Mem才是真正可用的物理内存。并且，使用交换分区不见得是坏事情，所以交换分区使用率不是什么严重的参数，但是频繁的 swap in/out 就不是好事情了，这种情况需要注意，通常表示物理内存紧缺的情况</li>
</ul>
<p>CPU 占用率高很多情况下意味着一些东西，这也给服务器 CPU 使用率过高情况下指明了相应地排查思路：</p>
<ul>
<li>当 user 占用率过高的时候，通常是某些个别的进程占用了大量的 CPU，这时候很容易通过 top 找到该程序；此时如果怀疑程序异常，可以通过 perf 等思路找出热点调用函数来进一步排查；</li>
<li>当 system 占用率过高的时候，如果 IO 操作(包括终端 IO)比较多，可能会造成这部分的 CPU 占用率高，比如在 file server、database server 等类型的服务器上，否则(比如&gt;20%)很可能有些部分的内核、驱动模块有问题；</li>
<li>当 nice 占用率过高的时候，通常是有意行为，当进程的发起者知道某些进程占用较高的 CPU，会设置其 nice 值确保不会淹没其他进程对 CPU 的使用请求；</li>
<li>当 iowait 占用率过高的时候，通常意味着某些程序的 IO 操作效率很低，或者 IO 对应设备的性能很低以至于读写操作需要很长的时间来完成；</li>
<li>当 irq/softirq 占用率过高的时候，很可能某些外设出现问题，导致产生大量的irq请求，这时候通过检查 /proc/interrupts 文件来深究问题所在；</li>
<li>当 steal 占用率过高的时候，黑心厂商虚拟机超售了吧！</li>
</ul>
<h2 id="swap相关命令" class="heading-element">
  <a href="#swap%e7%9b%b8%e5%85%b3%e5%91%bd%e4%bb%a4" class="heading-mark"></a>swap相关命令</h2><ul>
<li><code>swaplabel</code> ：查看或更改 swap 的标签或 UID</li>
<li><code>swapon</code> ：开启交换分区（临时）</li>
<li><code>swapoff</code> ：关闭交换分区（临时）</li>
</ul>
<p>要永久开启或关闭交换分区需要在 <code>/etc/fstab</code> 中的 swap 注释或添加挂载</p>
<h2 id="procmeminfo" class="heading-element">
  <a href="#procmeminfo" class="heading-mark"></a>/proc/meminfo</h2><p><code>/proc/meminfo</code> 文件是了解Linux系统内存使用状况的主要接口，常用的 <code>free</code>、<code>vmstat</code> 等命令就是通过它获取数据的</p>
<div class="highlight" id="id-14"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@centos7 ~<span class="o">]</span><span class="c1"># cat /proc/meminfo </span>
</span></span><span class="line"><span class="cl">MemTotal:        <span class="m">3861300</span> kB
</span></span><span class="line"><span class="cl">	总物理内存。该值是系统初始化之后剩下可提供给内核支配的内存（初始化时firmware/BIOS要保留一些内存，kernel本身要占用一些内存，这些内存是没有释放的）
</span></span><span class="line"><span class="cl">	内核所用内存的静态部分，比如内核代码、页描述符等数据在引导阶段就分配掉了，并不计入MemTotal里
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MemFree:         <span class="m">3188028</span> kB
</span></span><span class="line"><span class="cl">	剩余物理内存。该值是 MemTotal（总物理内存）-MemFree（已经使用物理内存）；
</span></span><span class="line"><span class="cl">	不能代表全部可用的内存，系统中有些内存虽然已被使用但是可以回收的，比如cache/buffer、slab都有一部分可以回收
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">MemAvailable:    <span class="m">3353960</span> kB
</span></span><span class="line"><span class="cl">	当前可用物理内存（估值，不准确）有些应用程序会根据系统的可用内存大小自动调整内存申请的多少，所以需要一个记录当前可用内存数量的统计值
</span></span><span class="line"><span class="cl">	/proc/meminfo中的MemAvailable是内核使用特定的算法估算出来的，要注意这是一个估计值，并不精确
</span></span><span class="line"><span class="cl">	<span class="nv">MemAvailable</span><span class="o">=</span>MemFree+可回收内存
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Buffers:            <span class="m">2108</span> kB
</span></span><span class="line"><span class="cl">	块设备占用的缓存页，包含直接读写块设备、以及文件系统元数据<span class="o">(</span>metadata<span class="o">)</span>比如SuperBlock所使用的缓存页
</span></span><span class="line"><span class="cl">Cached:           <span class="m">364184</span> kB
</span></span><span class="line"><span class="cl">	普通文件占用的缓存页
</span></span><span class="line"><span class="cl">SwapCached:            <span class="m">0</span> kB
</span></span><span class="line"><span class="cl">Active:           <span class="m">193580</span> kB
</span></span><span class="line"><span class="cl">Inactive:         <span class="m">294048</span> kB
</span></span><span class="line"><span class="cl">Active<span class="o">(</span>anon<span class="o">)</span>:     <span class="m">121064</span> kB
</span></span><span class="line"><span class="cl">Inactive<span class="o">(</span>anon<span class="o">)</span>:    <span class="m">12108</span> kB
</span></span><span class="line"><span class="cl">Active<span class="o">(</span>file<span class="o">)</span>:      <span class="m">72516</span> kB
</span></span><span class="line"><span class="cl">Inactive<span class="o">(</span>file<span class="o">)</span>:   <span class="m">281940</span> kB
</span></span><span class="line"><span class="cl">Unevictable:           <span class="m">0</span> kB
</span></span><span class="line"><span class="cl">Mlocked:               <span class="m">0</span> kB
</span></span><span class="line"><span class="cl">SwapTotal:       <span class="m">2097148</span> kB
</span></span><span class="line"><span class="cl">SwapFree:        <span class="m">2097148</span> kB
</span></span><span class="line"><span class="cl">Dirty:                <span class="m">12</span> kB
</span></span><span class="line"><span class="cl">Writeback:             <span class="m">0</span> kB
</span></span><span class="line"><span class="cl">AnonPages:        <span class="m">121340</span> kB
</span></span><span class="line"><span class="cl">Mapped:            <span class="m">62988</span> kB
</span></span><span class="line"><span class="cl">Shmem:             <span class="m">11832</span> kB
</span></span><span class="line"><span class="cl">Slab:             <span class="m">101236</span> kB
</span></span><span class="line"><span class="cl">SReclaimable:      <span class="m">32132</span> kB
</span></span><span class="line"><span class="cl">SUnreclaim:        <span class="m">69104</span> kB
</span></span><span class="line"><span class="cl">KernelStack:        <span class="m">4640</span> kB
</span></span><span class="line"><span class="cl">PageTables:         <span class="m">4384</span> kB
</span></span><span class="line"><span class="cl">NFS_Unstable:          <span class="m">0</span> kB
</span></span><span class="line"><span class="cl">Bounce:                <span class="m">0</span> kB
</span></span><span class="line"><span class="cl">WritebackTmp:          <span class="m">0</span> kB
</span></span><span class="line"><span class="cl">CommitLimit:     <span class="m">4027796</span> kB
</span></span><span class="line"><span class="cl">Committed_AS:     <span class="m">713200</span> kB
</span></span><span class="line"><span class="cl">VmallocTotal:   <span class="m">34359738367</span> kB
</span></span><span class="line"><span class="cl">VmallocUsed:      <span class="m">183896</span> kB
</span></span><span class="line"><span class="cl">VmallocChunk:   <span class="m">34359310332</span> kB
</span></span><span class="line"><span class="cl">Percpu:            <span class="m">25600</span> kB
</span></span><span class="line"><span class="cl">HardwareCorrupted:     <span class="m">0</span> kB
</span></span><span class="line"><span class="cl">AnonHugePages:     <span class="m">38912</span> kB
</span></span><span class="line"><span class="cl">CmaTotal:              <span class="m">0</span> kB
</span></span><span class="line"><span class="cl">CmaFree:               <span class="m">0</span> kB
</span></span><span class="line"><span class="cl">HugePages_Total:       <span class="m">0</span>
</span></span><span class="line"><span class="cl">HugePages_Free:        <span class="m">0</span>
</span></span><span class="line"><span class="cl">HugePages_Rsvd:        <span class="m">0</span>
</span></span><span class="line"><span class="cl">HugePages_Surp:        <span class="m">0</span>
</span></span><span class="line"><span class="cl">Hugepagesize:       <span class="m">2048</span> kB
</span></span><span class="line"><span class="cl">DirectMap4k:      <span class="m">124736</span> kB
</span></span><span class="line"><span class="cl">DirectMap2M:     <span class="m">3020800</span> kB
</span></span><span class="line"><span class="cl">DirectMap1G:     <span class="m">3145728</span> kB</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="iotop" class="heading-element">
  <a href="#iotop" class="heading-mark"></a>iotop</h2><h2 id="lsof" class="heading-element">
  <a href="#lsof" class="heading-mark"></a>lsof</h2><h2 id="sar" class="heading-element">
  <a href="#sar" class="heading-mark"></a>sar</h2><p>sar 这个工具太强大了，什么 CPU、磁盘、页面交换啥都管</p>
<div class="highlight" id="id-15"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># -n 网络 TCP 协议，1是刷新时间</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># sar -n TCP 1</span>
</span></span><span class="line"><span class="cl">Linux 4.18.0-348.7.1.el8_5.x86_64 <span class="o">(</span>localhost.localdomain<span class="o">)</span>       01/23/2022      _x86_64_        <span class="o">(</span><span class="m">4</span> CPU<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">01:06:37 AM  active/s passive/s    iseg/s    oseg/s
</span></span><span class="line"><span class="cl">01:06:38 AM      0.00      0.00      0.99      0.99
</span></span><span class="line"><span class="cl">01:06:39 AM      0.00      0.00      1.00      1.00
</span></span><span class="line"><span class="cl">01:06:40 AM      0.00      0.00      0.99      0.99
</span></span><span class="line"><span class="cl">01:06:41 AM      0.00      0.00      1.00      1.00
</span></span><span class="line"><span class="cl">01:06:42 AM      0.00      0.00      1.00      1.00
</span></span><span class="line"><span class="cl">01:06:43 AM      0.00      0.00      2.00      2.00
</span></span><span class="line"><span class="cl">01:06:44 AM      0.00      0.00      1.00      1.00
</span></span><span class="line"><span class="cl">^C
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Average:         0.00      0.00      1.14      1.14</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>active/s：本地发起的 TCP 连接，比如通过 connect()，TCP 的状态从CLOSED -&gt; SYN-SENT</li>
<li>passive/s：由远程发起的 TCP 连接，比如通过 accept()，TCP 的状态从LISTEN -&gt; SYN-RCVD</li>
<li>retrans/s(tcpRetransSegs)：每秒钟 TCP 重传数目，通常在网络质量差，或者服务器过载后丢包的情况下，根据 TCP 的确认重传机制会发生重传操作</li>
<li>isegerr/s(tcpInErrs)：每秒钟接收到出错的数据包(比如 checksum 失败)</li>
</ul>
<h2 id="sysbench" class="heading-element">
  <a href="#sysbench" class="heading-mark"></a>sysbench</h2><p>sysbench是一个开源的、模块化的、跨平台的多线程性能测试工具</p>
<div class="highlight" id="id-16"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">https://github.com/akopytov/sysbench#linux</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>安装</li>
</ul>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2023-07-22 13:49:16">更新于 2023-07-22&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/linux/" class="post-tag" title="标签 - linux">linux</a><a href="/tags/%E6%80%A7%E8%83%BD/" class="post-tag" title="标签 - 性能">性能</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/vim-nginx/" class="post-nav-item" rel="prev" title="vim中nginx配置文件高亮"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>vim中nginx配置文件高亮</a>
      <a href="/awk/" class="post-nav-item" rel="next" title="gawk">gawk<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.115.3"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.1"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2022 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/pangu/pangu.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"lightgallery":true,"pangu":{"enable":true,"selector":"article"},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":true,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.3,"type":"fuse","useExtendedSearch":false}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
