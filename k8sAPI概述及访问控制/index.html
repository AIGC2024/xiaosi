<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>k8s API 概述及访问控制 - 小厮</title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="运行环境： k8s:1.14 Rocky Linux: 8.6 内容来自以下文档： k8s 官方文档: API 概述 k8s 官方文档: 使用 Kubernetes API 访问集群 k8s 官方文档: Kubernetes API 概念 k8s 官方文档: API 访问控制 k8s 官方文档: 访问" /><meta name="keywords" content='k8s API' /><meta itemprop="name" content="k8s API 概述及访问控制">
<meta itemprop="description" content="运行环境： k8s:1.14 Rocky Linux: 8.6 内容来自以下文档： k8s 官方文档: API 概述 k8s 官方文档: 使用 Kubernetes API 访问集群 k8s 官方文档: Kubernetes API 概念 k8s 官方文档: API 访问控制 k8s 官方文档: 访问"><meta itemprop="datePublished" content="2022-09-11T04:37:37+08:00" />
<meta itemprop="dateModified" content="2022-10-04T11:56:54+08:00" />
<meta itemprop="wordCount" content="9524">
<meta itemprop="keywords" content="k8s API," /><meta property="og:title" content="k8s API 概述及访问控制" />
<meta property="og:description" content="运行环境： k8s:1.14 Rocky Linux: 8.6 内容来自以下文档： k8s 官方文档: API 概述 k8s 官方文档: 使用 Kubernetes API 访问集群 k8s 官方文档: Kubernetes API 概念 k8s 官方文档: API 访问控制 k8s 官方文档: 访问" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/k8sAPI%E6%A6%82%E8%BF%B0%E5%8F%8A%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-11T04:37:37+08:00" />
<meta property="article:modified_time" content="2022-10-04T11:56:54+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="k8s API 概述及访问控制"/>
<meta name="twitter:description" content="运行环境： k8s:1.14 Rocky Linux: 8.6 内容来自以下文档： k8s 官方文档: API 概述 k8s 官方文档: 使用 Kubernetes API 访问集群 k8s 官方文档: Kubernetes API 概念 k8s 官方文档: API 访问控制 k8s 官方文档: 访问"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#ffffff" data-dark="#252627" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="/k8sAPI%E6%A6%82%E8%BF%B0%E5%8F%8A%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/" /><link rel="prev" href="/CMDjq/" /><link rel="next" href="/linuxBash/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "k8s API 概述及访问控制",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "\/k8sAPI%E6%A6%82%E8%BF%B0%E5%8F%8A%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6\/"
    },"genre": "posts","keywords": "k8s API","wordcount":  9524 ,
    "url": "\/k8sAPI%E6%A6%82%E8%BF%B0%E5%8F%8A%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6\/","datePublished": "2022-09-11T04:37:37+08:00","dateModified": "2022-10-04T11:56:54+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "小厮"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="wide"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="小厮"><span class="header-title-text">首页</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class='fa-solid fa-archive fa-fw fa-sm'></i> 所有文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="小厮"><span class="header-title-text">首页</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class='fa-solid fa-archive fa-fw fa-sm'></i> 所有文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container container-reverse"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>k8s API 概述及访问控制</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      小厮</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/k8s/" class="post-category" title="分类 - k8s"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> k8s</a></span></div><div class="post-meta-line"><span title="发布于 2022-09-11 04:37:37"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2022-09-11">2022-09-11</time></span>&nbsp;<span title="更新于 2022-10-04 11:56:54"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden="true"></i><time datetime="2022-10-04">2022-10-04</time></span>&nbsp;<span title="9524 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 9600 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 20 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#api-概念">API 概念</a>
      <ul>
        <li><a href="#api-版本">API 版本</a></li>
        <li><a href="#api-组">API 组</a></li>
        <li><a href="#api-持久化">API 持久化</a></li>
      </ul>
    </li>
    <li><a href="#资源-uri">资源 URI</a></li>
    <li><a href="#api-服务访问控制"><code>API</code> 服务访问控制</a>
      <ul>
        <li><a href="#用户认证">用户认证</a></li>
        <li><a href="#服务账户">服务账户</a></li>
        <li><a href="#身份认证策略">身份认证策略</a>
          <ul>
            <li><a href="#http-x509-客户证书认证">HTTP x509 客户证书认证</a></li>
            <li><a href="#使用启动引导令牌认证">使用启动引导令牌认证</a></li>
            <li><a href="#匿名请求">匿名请求</a></li>
          </ul>
        </li>
        <li><a href="#鉴权概述">鉴权概述</a>
          <ul>
            <li><a href="#rbac-鉴权">RBAC 鉴权</a>
              <ul>
                <li><a href="#role-与-clusterrole"><code>Role</code> 与 <code>ClusterRole</code></a></li>
                <li><a href="#聚合的-clusterrole">聚合的 ClusterRole</a></li>
                <li><a href="#rolebinding-和-clusterrolebinding"><code>RoleBinding</code> 和 <code>ClusterRoleBinding</code></a></li>
                <li><a href="#默认的-roles-和-rolebindings">默认的 <code>Roles</code> 和 <code>RoleBindings</code></a></li>
                <li><a href="#初始化与预防权限提升">初始化与预防权限提升</a></li>
                <li><a href="#服务账户权限">服务账户权限</a></li>
                <li><a href="#endpoints-写入权限"><code>Endpoints</code> 写入权限</a></li>
                <li><a href="#从-abac-鉴权转换到-rbac-鉴权">从 <code>ABAC</code> 鉴权转换到 <code>RBAC</code> 鉴权</a></li>
              </ul>
            </li>
            <li><a href="#node-鉴权"><code>node</code> 鉴权</a>
              <ul>
                <li><a href="#版本变动">版本变动</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#准入控制器">准入控制器</a>
          <ul>
            <li><a href="#noderestriction"><code>NodeRestriction</code></a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#kubelet-api-访问控制"><code>kubelet API</code> 访问控制</a>
      <ul>
        <li><a href="#kubelet-api-身份认证"><code>kubelet API</code> 身份认证</a>
          <ul>
            <li><a href="#匿名请求-1">匿名请求</a></li>
            <li><a href="#x509-认证"><code>x509</code> 认证</a></li>
            <li><a href="#token"><code>token</code></a></li>
          </ul>
        </li>
        <li><a href="#鉴权">鉴权</a></li>
      </ul>
    </li>
    <li><a href="#api">API</a>
      <ul>
        <li><a href="#subjectaccessreview">SubjectAccessReview</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><div class="details admonition note open">
      <div class="details-summary admonition-title">
        <i class="icon fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i>注意<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
      </div>
      <div class="details-content">
        <div class="admonition-content">本文最后更新于 2022-10-04，文中内容可能已过时。</div>
      </div>
    </div><!-- FileID: FID -->
<blockquote>
<p>运行环境：
k8s:1.14
Rocky Linux: 8.6</p>
<p>内容来自以下文档：</p>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/reference/using-api/"target="_blank" rel="external nofollow noopener noreferrer"><code>k8s 官方文档</code>: API 概述</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/access-cluster-api/"target="_blank" rel="external nofollow noopener noreferrer"><code>k8s 官方文档</code>: 使用 Kubernetes API 访问集群</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/reference/using-api/api-concepts/"target="_blank" rel="external nofollow noopener noreferrer"><code>k8s 官方文档</code>: Kubernetes API 概念</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/"target="_blank" rel="external nofollow noopener noreferrer"><code>k8s 官方文档</code>: API 访问控制</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/access-cluster/"target="_blank" rel="external nofollow noopener noreferrer"><code>k8s 官方文档</code>: 访问集群</a></li>
<li><a href="https://www.jianshu.com/p/73f3b22cded5"target="_blank" rel="external nofollow noopener noreferrer"><code>A_Zeee</code>: 调用k8s API</a></li>
</ul>
</blockquote>
<!-- 网址链接 -->
<!-- 图片链接 -->
<!-- 其它链接 -->
<h1 id="api-概念" class="heading-element">
  <a href="#api-%e6%a6%82%e5%bf%b5" class="heading-mark"></a>API 概念</h1><p><code>k8s API</code> 是通过 <code>HTTP</code> 协议提供基于资源(<code>RESTful</code>) 的编程接口，可以通过 <code>HTTP</code> 请示方法（<code>POST</code>、<code>PUT</code>、<code>PATCH</code>、<code>DELETE</code>、<code>GET</code>）检索、创建、更新和删除主要资源。</p>
<p><code>k8s</code> 通过使用常见的资源术语来描述 <code>API</code> 概念：</p>
<ul>
<li>资源类型（<code>Resource Type</code>）：是 <code>URL</code> 中使用的名称，如 <code>pod</code>、<code>services</code> 等</li>
<li>类别（<code>Kind</code>）：是所有资源类型都有一个具体的表示</li>
<li>集合（<code>Collection</code>）：是资源实例的列表</li>
<li>资源（<code>Resource</code>）或对象（<code>Object</code>）：资源类型的单个实例</li>
<li>子资源（<code>sub-resources</code>）：某些资源类型包含一个或多个资源，些资源表示为资源下的 <code>URI</code> 路径</li>
</ul>
<h2 id="api-版本" class="heading-element">
  <a href="#api-%e7%89%88%e6%9c%ac" class="heading-mark"></a>API 版本</h2><p><code>API</code> 有以下版本</p>
<ul>
<li><code>Alpha</code>: 版本名称包含 <code>alpha</code>（例如：<code>v1alpha1</code>）:
<ul>
<li>软件可能会有 <code>BUG</code>。某些特性可能默认禁用。</li>
<li>对某个特性的支持可能会随时被删除</li>
<li>可能在以后的软件版本中以不兼容的方式更改</li>
<li>由于缺陷风险增加和缺乏长期支持，建议该软件仅用于短期测试集群。</li>
</ul>
</li>
<li><code>Beta</code>： 版本名称包含 <code>beta</code>（例如：<code>v2beta3</code>）
<ul>
<li>软件被很好的测试过。启用某个特性被认为是安全的。 特性默认开启。</li>
<li>尽管一些特性会发生细节上的变化，但它们将会被长期支持。</li>
<li>该版本的软件不建议生产使用。 后续发布版本可能会有不兼容的变动。</li>
<li>后续版本发生不兼容的方式改变时，将提供迁移说明。</li>
</ul>
</li>
<li><code>Stable</code>: 版本名称如 <code>vX</code>，其中 <code>X</code> 为整数。后续很多版本的发布软件中。</li>
</ul>
<h2 id="api-组" class="heading-element">
  <a href="#api-%e7%bb%84" class="heading-mark"></a>API 组</h2><p><code>API</code> 组 能够简化对 <code>k8s API</code> 的扩展。 <code>API</code> 组信息出现在 <code>REST</code> 路径中，也出现在序列化对象的 <code>apiVersion</code> 字段中。</p>
<p>可以通过在 API 服务器上设置 <code>--runtime-config</code> 参数来启用或禁用（需要重新 <code>api</code> 服务）。格式为 <code>&lt;key&gt;[=true | false ]</code>，当缺省值时默认为 <code>true</code></p>
<h2 id="api-持久化" class="heading-element">
  <a href="#api-%e6%8c%81%e4%b9%85%e5%8c%96" class="heading-mark"></a>API 持久化</h2><p><code>k8s</code> 通过 <code>API</code> 资源来将序列化的状态写到 <code>etcd</code> 中存储</p>
<h1 id="资源-uri" class="heading-element">
  <a href="#%e8%b5%84%e6%ba%90-uri" class="heading-mark"></a>资源 URI</h1><p>资源 <code>URI</code> 地址有以下路径：</p>
<ul>
<li><code>/apis/GROUP/VERSION/RESOURCETYPE</code>: 返回指定集群资源类型的资源的集合</li>
<li><code>GET /apis/GROUP/VERSION/RESOURCETYPE/NAME</code>: 返回指定集群资源类型下名称为 <code>NAME</code> 的资源</li>
<li><code>GET /apis/GROUP/VERSION/RESOURCETYPE</code>: 返回所有名称空间中指定资源类型的全部实例的集合</li>
<li><code>GET /apis/GROUP/VERSION/namespaces/NAMESPACE/RESOURCETYPE</code>:  返回名称空间（<code>NAMESPACE</code>）内给定资源类型的全部实例的集合</li>
<li><code>GET /apis/GROUP/VERSION/namespaces/NAMESPACE/RESOURCETYPE/NAME</code>: 反回名称空间（<code>NAMESPACE</code>）中给定资源类型的名称为 <code>NAME</code> 的实例</li>
</ul>
<h1 id="api-服务访问控制" class="heading-element">
  <a href="#api-%e6%9c%8d%e5%8a%a1%e8%ae%bf%e9%97%ae%e6%8e%a7%e5%88%b6" class="heading-mark"></a><code>API</code> 服务访问控制</h1><p>访问 <code>k8s API</code> 服务有以下方式：</p>
<ul>
<li><code>REST API</code>：通过 <code>http</code> 直接访问<code>API</code>服务或使用 <code>kubectl proxy</code> 命令代理 <code>api</code> 服务（也是 <code>HTTP</code> 方式）</li>
<li><code>kubeconfig</code> 文件：应用程序通过 <code>kubeconfig</code> 文件定位和验证 <code>API</code> 服务器。如 <code>kubectl</code></li>
</ul>
<p>访问 <code>API</code> 大致分为以下步骤：</p>
<ol>
<li>身份认证</li>
<li>鉴权: 检查是否有操作权限</li>
<li>准入控制</li>
<li>审计</li>
</ol>
<h2 id="用户认证" class="heading-element">
  <a href="#%e7%94%a8%e6%88%b7%e8%ae%a4%e8%af%81" class="heading-mark"></a>用户认证</h2><p><code>k8s</code> 中只有服务账号并不包含用来代表普通用户账号的对象，因此普通用户的信息无法通过 <code>API</code> 调用添加到集群中：</p>
<ul>
<li>服务账号是 <code>k8s API</code> 所管理的用户。它们被绑定到特定的名字空间， 或者由 <code>API</code> 服务器自动创建，或者通过 <code>API</code> 调用创建。服务账号与一组以 <code>Secret</code> 保存的凭据相关，这些凭据会被挂载到 <code>Pod</code> 中，从而允许集群内的进程访问 <code>Kubernetes</code> <code>API</code></li>
<li>普通用户账号： 普通用户的信息无法通过 <code>API</code> 调用添加到集群中。但能够提供由集群的证书机构签名的合法证书的用户是通过身份认证的用户。</li>
</ul>
<h2 id="服务账户" class="heading-element">
  <a href="#%e6%9c%8d%e5%8a%a1%e8%b4%a6%e6%88%b7" class="heading-mark"></a>服务账户</h2><p><code>k8s</code> 区分用户账号和服务账号的概念，主要基于以下原因：</p>
<ul>
<li>用户账号是针对操作人员，服务账户是针对 <code>pod</code> 中的进程</li>
<li>用户账户是集群域全局的，服务账户是名称空间域的</li>
<li>用户账户通常涉及到复杂的业务流程。服务账号创建有意做得更轻量，允许集群用户为了具体的任务创建服务账号以遵从权限最小化原则</li>
<li>对操作人员和服务账号审计所考虑的因素可能不同</li>
</ul>
<p>服务账号通常用于 <code>pod</code> 内进程与 <code>k8s API</code> 服务连接时的身份验证。</p>
<h2 id="身份认证策略" class="heading-element">
  <a href="#%e8%ba%ab%e4%bb%bd%e8%ae%a4%e8%af%81%e7%ad%96%e7%95%a5" class="heading-mark"></a>身份认证策略</h2><p><code>k8s</code> 可能启用一个或多个身份认证模块时，<code>API</code>  服务器并不保证身份认证模块的运行顺序。当有一个成功地对请求完成身份认证的模块会直接做出评估决定。 对于所有通过身份认证的用户，<code>system:authenticated</code> 组都会被添加到其组列表中。</p>
<p><code>k8s</code> 身份认证插件使用客户准备端证书（<code>X509</code>）、令牌（<code>Bearer Token</code>）、认证代理（<code>Proxy</code>） 来认证 <code>API</code> 请求的身份。<code>HTTP</code> 请求发给 <code>API</code> 服务器时，插件会将以下属性关联到请求本身。这些属性对于身份认证系统而言都是不透明的， 只有被鉴权组件解释过之后才有意义：</p>
<ul>
<li>用户名：用来辩识最终用户的字符串。常见的值可以是 <code>kube-admin</code> 或 <code>jane@example.com</code>。</li>
<li>用户 <code>ID</code>：用来辩识最终用户的字符串，旨在比用户名有更好的一致性和唯一性。</li>
<li>用户组：取值为一组字符串，其中各个字符串用来标明用户是某个命名的用户逻辑集合的成员。 常见的值可能是 <code>system:masters</code> 或者 <code>devops-team</code> 等。</li>
<li>附加字段：一组额外的键-值映射，键是字符串，值是一组字符串； 用来保存一些鉴权组件可能觉得有用的额外信息。</li>
</ul>
<p>对于其它身份认证协议都可以通过使用一个身份认证代理或身份认证 <code>Webhoook</code> 来实现。</p>
<h3 id="http-x509-客户证书认证" class="heading-element">
  <a href="#http-x509-%e5%ae%a2%e6%88%b7%e8%af%81%e4%b9%a6%e8%ae%a4%e8%af%81" class="heading-mark"></a>HTTP x509 客户证书认证</h3><p><code>API</code> 服务使用 <code>--client-ca-file=SOMEFILE</code> 指定 <code>CA</code> 证书，如果提供了客户端证书并且证书被验证通过，则 <code>subject</code> 中的公共名称（<code>Common Name</code>） 就被作为请求的用户名。从 <code>k8s &gt;= 1.4</code> 开始，客户端证书还可以通过证书的 <code>organization</code> 字段标明用户的组成员信息。</p>
<ol>
<li>查看 <code>k8s api</code> 服务是否启用客户端证书认证</li>
</ol>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@node1 ~<span class="o">]</span><span class="c1"># kubectl -n kube-system get pod  kube-apiserver-node1.localdomain -o yaml  | grep &#39;\--client-ca-file&#39;</span>
</span></span><span class="line"><span class="cl">    - --client-ca-file<span class="o">=</span>/etc/kubernetes/pki/ca.crt</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>创建客户端请求证书</li>
</ol>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@node1 ~<span class="o">]</span><span class="c1"># cd /etc/kubernetes/pki</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@node1 pki<span class="o">]</span><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@node1 pki<span class="o">]</span><span class="c1"># ll ca.crt</span>
</span></span><span class="line"><span class="cl">-rw-r--r--. <span class="m">1</span> root root <span class="m">1070</span> Sep <span class="m">11</span> 03:03 ca.crt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 生成秘钥，给客户端使用</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@node1 pki<span class="o">]</span><span class="c1"># openssl genrsa -out user.key 2048</span>
</span></span><span class="line"><span class="cl">Generating RSA private key, <span class="m">2048</span> bit long modulus <span class="o">(</span><span class="m">2</span> primes<span class="o">)</span>
</span></span><span class="line"><span class="cl">....................+++++
</span></span><span class="line"><span class="cl">..............+++++
</span></span><span class="line"><span class="cl">e is <span class="m">65537</span> <span class="o">(</span>0x010001<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 生成请求证书（SCR）</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 从 k8s 1.4 开始证书中 organization 字段可以指定多个用户组（如：&#34;/CN=jbeda/O=app1/O=app2&#34;）</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 下面命令表示 ，user01 用户，且该用户属于 users 组</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@node1 pki<span class="o">]</span><span class="c1"># openssl req -new -key user.key -out user01.scr -subj &#34;/CN=user01/O=users&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>使用 <code>api</code> 服务的 <code>CA</code> 证书为客户端请求证书签名</li>
</ol>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 有效期为 1200 天</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@node1 pki<span class="o">]</span><span class="c1"># openssl x509 -req -in user01.scr -CA ca.crt -CAkey ca.key -CAcreateserial -out user01.crt -days 1200</span>
</span></span><span class="line"><span class="cl">Signature ok
</span></span><span class="line"><span class="cl"><span class="nv">subject</span><span class="o">=</span><span class="nv">CN</span> <span class="o">=</span> user01, <span class="nv">O</span> <span class="o">=</span> users
</span></span><span class="line"><span class="cl">Getting CA Private Key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@node1 pki<span class="o">]</span><span class="c1"># ls  user*</span>
</span></span><span class="line"><span class="cl">user01.crt  user01.scr  user.key</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>使用 <code>REST API</code> 方式访问（还没富裕权限，因此没有实质意义）</li>
</ol>
<div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@node1 pki<span class="o">]</span><span class="c1"># curl -sk --cert user01.crt --key user.key https://192.168.6.11:6443/api/| jq</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;APIVersions&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;versions&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;v1&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">]</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;serverAddressByClientCIDRs&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;clientCIDR&#34;</span>: <span class="s2">&#34;0.0.0.0/0&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;serverAddress&#34;</span>: <span class="s2">&#34;192.168.6.11:6443&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用启动引导令牌认证" class="heading-element">
  <a href="#%e4%bd%bf%e7%94%a8%e5%90%af%e5%8a%a8%e5%bc%95%e5%af%bc%e4%bb%a4%e7%89%8c%e8%ae%a4%e8%af%81" class="heading-mark"></a>使用启动引导令牌认证</h3><p>启动引导令牌是一种简单的持有者令牌（<code>Bearer Token</code>），这种令牌是在新建集群 或者在现有集群中添加新节点时使用的。</p>
<p>启动引导令牌被定义成一个特定类型的 <code>Secret</code>（<code>bootstrap.kubernetes.io/token</code>）， 并存在于 <code>kube-system</code> 名字空间中。 这些 <code>Secret</code> 会被 <code>API</code> 服务器上的启动引导认证组件（<code>Bootstrap Authenticator</code>）读取。 控制器管理器中的控制器 <code>TokenCleaner</code> 能够删除过期的令牌。 这些令牌也被用来在节点发现的过程中会使用的一个特殊的 <code>ConfigMap</code> 对象。 <code>BootstrapSigner</code> 控制器也会使用这一 <code>ConfigMap</code>。</p>
<p>动引导令牌必须符合正则表达式 <code>[a-z0-9]{6}\.[a-z0-9]{16}</code>。令牌的第一部分是（<code>Token ID</code>），它是一种公开信息，用于引用令牌并确保不会泄露认证所使用的秘密信息。 第二部分是令牌秘密（<code>Token Secret</code>），它应该被共享给受信的第三方。</p>
<p>在 <code>api</code> 服务使用 <code>--enable-bootstrap-token-auth</code> 选项启动引导令牌认证组件</p>
<h3 id="匿名请求" class="heading-element">
  <a href="#%e5%8c%bf%e5%90%8d%e8%af%b7%e6%b1%82" class="heading-mark"></a>匿名请求</h3><p>启用匿名请求支持之后，如果请求没有被被已配置的其他身份认证方法拒绝且没有提供有效的身份标识，则被视作匿名请求。如在一个配置了令牌身份认证且启用了匿名访问的服务器上，如果请求提供了非法的持有者令牌， 则会返回 <code>401 Unauthorized</code> 错误。如果请求没有提供持有者令牌，则被视为匿名请求。</p>
<p>在 <code>k8s 1.5x</code> 版本中，匿名访问默认情况下是被禁用的，可以通过为 API 服务器设定 <code>--anonymous-auth=true</code> 启用。在 <code>k8s 1.6</code> 之后版本中，如果所使用的鉴权模式不是 <code>AlwaysAllow</code>，则匿名访问默认是被启用的。</p>
<p>从 <code>k8s 1.6</code> 版本开始，<code>ABAC</code> 或 <code>RBAC</code>  鉴权模块要求对 <code>system:anonymous</code> 用户或者 <code>system:unauthenticated</code> 用户组执行显式的权限判定，用户 <code>*</code> 或用户组 <code>*</code> 赋予访问权限的策略规则都不再包含匿名用户。</p>
<p>如果要禁用匿名的未经过身份验证的用户访问，请在 API 服务器配置中中添加 <code>--anonymous-auth=false</code> 的配置选项。</p>
<h2 id="鉴权概述" class="heading-element">
  <a href="#%e9%89%b4%e6%9d%83%e6%a6%82%e8%bf%b0" class="heading-mark"></a>鉴权概述</h2><p><code>k8s</code> 使用 <code>api</code> 服务器对 <code>api</code> 请求根据所有策略评估所有请求属性来决定允许或拒绝请求。 默认是拒绝，只有明确允许的操作才会执行。</p>
<p>依赖于特定对象种类的特定字段的访问控制和策略由准入控制器处理</p>
<p><code>k8s</code> 仅审查以下 <code>API</code> 属性：</p>
<ul>
<li>用户： 身份验证期间提供的 <code>user</code> 字符串</li>
<li>组：经过身份验证的用户所属的组名列表</li>
<li><code>API</code>: 请求是否针对 <code>API</code> 资源。</li>
<li>请求路径：各种非资源端点的路径</li>
<li>请求动词：<code>HTTP</code> 请求动词对应的请求动词：
<ul>
<li><code>POST</code>: <code>create</code></li>
<li><code>GET</code>, <code>HEAD</code>: <code>get</code>(针对单个资源)、<code>list</code>（针对集合）</li>
<li><code>PUT</code>: <code>update</code></li>
<li><code>PATCH</code>: <code>patch</code></li>
<li><code>DELETE</code>: <code>delete</code>(针对单个资源)、<code>deletecollection</code>(针对集合)</li>
</ul>
</li>
<li>资源：正在访问的资源的 <code>ID</code> 或名称（仅限资源请求）， 对于使用 <code>get</code>、<code>update</code>、<code>patch</code> 和 <code>delete</code> 动词的资源请求，必须提供名称</li>
<li>名称空间：正在访问的对象的名称空间（仅适用于名字空间资源请求）。</li>
<li><code>API</code> 组：正在访问的 <code>API</code> 组 （仅限资源请求）。空字符串表示核心 <code>API</code> 组。</li>
</ul>
<p>有以下鉴权插件：</p>
<ul>
<li><code>node</code>: 一个专用鉴权模式，根据调度到 <code>kubelet</code> 上运行的 <code>Pod</code> 为 <code>kubelet</code> 授予权限。</li>
<li><code>ABAC</code>: 基于属性的访问控制（<code>ABAC</code>）定义了一种访问控制范型，通过使用将属性组合在一起的策略， 将访问权限授予用户。策略可以使用任何类型的属性（用户属性、资源属性、对象，环境属性等）</li>
<li><code>RBAC</code>: 基于角色的访问控制（<code>RBAC</code>） 是一种基于企业内个人用户的角色来管理对计算机或网络资源的访问的方法。 在此上下文中，权限是单个用户执行特定任务的能力， 例如查看、创建或修改文件。</li>
<li><code>Webhook</code>:  它是一个 <code>HTTP</code> 回调：发生某些事情时调用的 <code>HTTP</code> <code>POST</code>； 通过 <code>HTTP</code> <code>POST</code> 进行简单的事件通知。 实现 <code>WebHook</code> 的 <code>Web</code> 应用程序会在发生某些事情时将消息发布到 <code>URL</code>。</li>
</ul>
<p>查看启用的鉴权插件，靠前的模块具有更高的优先级来允许或拒绝请求：</p>
<div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@node1 ~<span class="o">]</span><span class="c1"># kubectl get pod kube-apiserver-node1.localdomain -n kube-system -o=jsonpath=&#39;{$.spec.containers[0].command}&#39; | jq | grep &#34;authorization-mode&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;--authorization-mode=Node,RBAC&#34;</span>,</span></span></code></pre></td></tr></table>
</div>
</div><p><code>kubectl auth can-i</code> 命令使用 <code>SelfSubjectAccessReview</code> <code>API</code> 来确定当前用户是否可以执行给定操作</p>
<div class="highlight" id="id-6"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 检查名字空间 dev 里的 dev-sa 服务账户是否可以列举名字空间 target 里的 Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@node1 ~<span class="o">]</span><span class="c1"># kubectl auth can-i list pods --namespace target --as system:serviceaccount:dev:dev-sa</span>
</span></span><span class="line"><span class="cl">no
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 检查当前用户可以在 dev 名称空间是否允许创建 `deployments`</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@node1 ~<span class="o">]</span><span class="c1"># kubectl auth can-i create deployments --namespace dev</span>
</span></span><span class="line"><span class="cl">yes</span></span></code></pre></td></tr></table>
</div>
</div><p>也可以通过创建普通的 <code>k8s</code> 资源来查询这些 <code>API</code>，其中返回对象的响应 <code>status</code> 字段是查询的结果。</p>
<div class="highlight" id="id-7"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@node1 ~<span class="o">]</span><span class="c1"># kubectl create -f - -o yaml &lt;&lt; EOF</span>
</span></span><span class="line"><span class="cl">&gt; apiVersion: authorization.k8s.io/v1
</span></span><span class="line"><span class="cl">&gt; kind: SelfSubjectAccessReview
</span></span><span class="line"><span class="cl">&gt; spec:
</span></span><span class="line"><span class="cl">&gt;   resourceAttributes:
</span></span><span class="line"><span class="cl">&gt;     group: apps
</span></span><span class="line"><span class="cl">&gt;     name: deployments
</span></span><span class="line"><span class="cl">&gt;     verb: create
</span></span><span class="line"><span class="cl">&gt;     namespace: dev
</span></span><span class="line"><span class="cl">&gt; EOF
</span></span><span class="line"><span class="cl">apiVersion: authorization.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: SelfSubjectAccessReview
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  creationTimestamp: null
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  resourceAttributes:
</span></span><span class="line"><span class="cl">    group: apps
</span></span><span class="line"><span class="cl">    name: deployments
</span></span><span class="line"><span class="cl">    namespace: dev
</span></span><span class="line"><span class="cl">    verb: create
</span></span><span class="line"><span class="cl">status:
</span></span><span class="line"><span class="cl">  allowed: true</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="rbac-鉴权" class="heading-element">
  <a href="#rbac-%e9%89%b4%e6%9d%83" class="heading-mark"></a>RBAC 鉴权</h3><p>基于角色（<code>Role</code>）的访问控制（<code>RBAC</code>）是一种基于组织中用户的角色来调节控制对计算机或网络资源的访问的方法。<code>RBAC</code> 鉴权机制使用 <code>rbac.authorization.k8s.io</code> <code>API</code> 组来驱动鉴权决定， 允许你通过 <code>Kubernetes API</code> 动态配置策略。</p>
<p>在 <code>kube-apiserver --authorization-mode</code> 选项包含 <code>RBAC</code> 参数时表示启用了 <code>RBAC</code> 鉴权</p>
<div class="highlight" id="id-8"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@node1 ~<span class="o">]</span><span class="c1"># kubectl get pod kube-apiserver-node1.localdomain -n kube-system -o=jsonpath=&#39;{$.spec.containers[0].command}&#39; | jq | grep &#34;authorization-mode&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;--authorization-mode=Node,RBAC&#34;</span>,</span></span></code></pre></td></tr></table>
</div>
</div><p><code>RBAC API</code> 声明了以下 <code>k8s</code> 对象：</p>
<ul>
<li>权限定义对象，一组相关权限规则。权限是纯粹累加的，不存在拒绝某种操作的规则。
<ul>
<li><code>Role</code>: 某个名称空间内权限</li>
<li><code>ClusterRole</code>: 定义集群级别区域权限</li>
</ul>
</li>
<li>角色绑定对象：
<ul>
<li><code>RoleBinding</code>: 将 <code>Role</code> 定义的权限赋予一个或者一组用户</li>
<li><code>ClusterRoleBinding</code>: 将 <code>ClusterRole</code> 定义的权限赋予一个或者一组用户</li>
</ul>
</li>
</ul>
<p>它们的生效范围：</p>
<ul>
<li><code>RoleBinding</code> 绑定 <code>Role</code>：在固定名称空间生效。且 <code>RoleBinding</code> 和 <code>Role</code> 必须在同一名称空间</li>
<li><code>RoleBinding</code> 绑定 <code>ClusterRole</code>：在 <code>RoleBingding</code> 定义的名称空间生效</li>
<li><code>ClusterRoleBinding</code> 绑定 <code>ClusterRole</code>：在整个集群生效</li>
</ul>
<h4 id="role-与-clusterrole" class="heading-element">
  <a href="#role-%e4%b8%8e-clusterrole" class="heading-mark"></a><code>Role</code> 与 <code>ClusterRole</code></h4><p><code>RBAC</code> 的 <code>Role</code> 或 <code>ClusterRole</code> 中包含一组代表相关权限的规则。 这些权限是纯粹累加的。不存在拒绝某操作的规则。<code>Role</code> 总是用来在某个名字空间内设置访问权限，创建 <code>Role</code> 时必须指定该 <code>Role</code> 所属的名字空间。<code>ClusterRole</code> 则是一个集群作用域的资源。</p>
<ul>
<li><code>role</code> 示例</li>
</ul>
<div class="highlight" id="id-9"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">note</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">user-role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;v1&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;pods&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>ClusterRole</code> 示例</li>
</ul>
<div class="highlight" id="id-10"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">user-cluster-role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;v1&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;nodes&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">]</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="聚合的-clusterrole" class="heading-element">
  <a href="#%e8%81%9a%e5%90%88%e7%9a%84-clusterrole" class="heading-mark"></a>聚合的 ClusterRole</h4><p>可以把若干个 <code>ClusterRole</code> 聚合起来，形成一个复合的 <code>ClusterRole</code>。作为集群控制面的一部分，控制器会监视带有 <code>aggregationRule</code> 的 ClusterRole 对象集合。</p>
<p><code>aggregationRule</code> 为控制器定义一个标签选择算符供后者匹配应该组合到当前 <code>ClusterRole</code> 的 <code>roles</code> 字段中的 <code>ClusterRole</code> 对象</p>
<p>下面是一个聚合 <code>ClusterRole</code> 的示例：</p>
<div class="highlight" id="id-11"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">monitoring</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">aggregationRule</span><span class="p">:</span><span class="w">    </span><span class="c"># 聚合标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterRoleSelectors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">rbac.example.com/aggregate-to-monitoring</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="c"># 控制面自动填充这里的规则</span></span></span></code></pre></td></tr></table>
</div>
</div><p>再创建一个带有 <code>rbac.example.com/aggregate-to-monitoring: true</code> 标签的 <code>ClusterRole</code> 新的规则也会被添加到名为 <code>monitoring</code> 的 <code>ClusterRole</code> 中</p>
<div class="highlight" id="id-12"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">monitoring-endpoints</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rbac.example.com/aggregate-to-monitoring</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 当你创建 &#34;monitoring-endpoints&#34; ClusterRole 时，</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 下面的规则会被添加到 &#34;monitoring&#34; ClusterRole 中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;services&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;endpoints&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;pods&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">]</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="rolebinding-和-clusterrolebinding" class="heading-element">
  <a href="#rolebinding-%e5%92%8c-clusterrolebinding" class="heading-mark"></a><code>RoleBinding</code> 和 <code>ClusterRoleBinding</code></h4><p><code>RoleBinding</code> 与 <code>ClusterRoleBinding</code> 都是用于把权限与某个或某些用户、用户组、服务账号关联，这些主体名称没有过多限制。以下前缀是 <code>k8s</code> 系统保留的：</p>
<ul>
<li><code>system:</code></li>
<li><code>system:serviceaccount:</code>: 是用于服务账户用户名的前缀</li>
<li><code>system:serviceaccounts:</code>: 是用于服务账户组名的前缀</li>
</ul>
<p><code>RoleBinding</code> 示例</p>
<div class="highlight" id="id-13"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">user-role-binding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">note</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">User</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">user-role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="默认的-roles-和-rolebindings" class="heading-element">
  <a href="#%e9%bb%98%e8%ae%a4%e7%9a%84-roles-%e5%92%8c-rolebindings" class="heading-mark"></a>默认的 <code>Roles</code> 和 <code>RoleBindings</code></h4><p><code>API</code> 服务会创建一组默认的 <code>ClusterRole</code> 与 <code>ClusterRoleBinding</code> 对象，它们都带有 <code>kubernetes.io/bootstrapping=rbac-defaults</code> 。其中有很多用 <code>system:</code> 作为前缀来标识对应资源是直接由集群控制面管理的。因此修改这些资源时要小心，可能导致集群无法正常运作。</p>
<p>每次启动时 <code>API</code> 服务器都会为默认的 <code>ClusterRole</code> 添加缺少的权限，并为默认的 <code>ClusterRoleBindin</code> 添加缺少的主体。这种机制称为自动协商，它有助于保证角色和角色绑定在新的发行版本中有权限或主体变更时仍然保持最新。如果想禁用则把它们的注解 <code>rbac.authorization.kubernetes.io/autoupdate</code> 由 <code>true</code> 改为 <code>false</code>。注意，缺少默认权限和角色绑定主体可能会导致集群无法正常工作。如果启用了 <code>RBAC</code> 鉴权，则该机制是默认启用的</p>
<p>无论是经过身份验证的还是未经过身份验证的用户， 默认的角色绑定都授权他们读取被认为是可安全地公开访问的 <code>API</code> (由名为 <code>system:discovery</code> 的<code>ClusterRole</code> 资源定义)</p>
<p><code>RBAC</code> 会发现以下<code>ClusterRole</code>并通过自动协商机制修复</p>
<table>
<thead>
<tr>
<th style="text-align:left">默认的 <code>ClusterRole</code></th>
<th style="text-align:left">默认绑定的主体</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>system:basic-user</code></td>
<td style="text-align:left"><code>system:authenticated</code> 组</td>
<td style="text-align:left">允许用户以只读的方式去访问他们自己的基本信息。在 <code>k8s 1.14</code> 版本之前是 <code>system:unauthenticated</code> 组的一员</td>
</tr>
<tr>
<td style="text-align:left"><code>system:discovery</code></td>
<td style="text-align:left"><code>system:authenticated</code> 组</td>
<td style="text-align:left">允许以只读方式访问 <code>API</code> 发现端点，这些端点用来发现和协商 <code>API</code> 级别。在 <code>k8s 1.14</code> 版本之前是 <code>system:unauthenticated</code> 组的一员</td>
</tr>
<tr>
<td style="text-align:left"><code>system:public-info-viewer</code></td>
<td style="text-align:left"><code>system:authenticated</code> 组 <br/> <code>system:unauthenticated</code> 组</td>
<td style="text-align:left">允许对集群的非敏感信息进行只读访问，在 <code>k8s 1.14</code> 版本中引入</td>
</tr>
</tbody>
</table>
<p>以下 <code>ClusterRole</code> 是面向用户的，允许管理员使用 <code>ClusterRole</code> 聚合标签来添加用于定制资源的规则。</p>
<table>
<thead>
<tr>
<th style="text-align:left">默认的 <code>ClusterRole</code></th>
<th style="text-align:left">默认关联的主体</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>cluster-admin</code></td>
<td style="text-align:left"><code>system:masters</code> 组</td>
<td style="text-align:left">允许超级用户在平台上的任何资源上执行所有操作。在 <code>RoleBinding</code> 资源中关联时，可以授权控制角色绑定所在名字空间中的所有资源，包括名字空间本身。</td>
</tr>
<tr>
<td style="text-align:left"><code>admin</code></td>
<td style="text-align:left">无</td>
<td style="text-align:left">允许管理员访问权限，旨在使用 <code>RoleBinding</code> 在名字空间内执行授权。可授予对名字空间中的大多数资源的读/写权限， 包括创建角色和角色绑定的能力。 此角色不允许对资源配额或者名字空间本身进行写操作。不允许对 <code>k8s 1.22</code> 以上版本的 <code>Endpoints</code> 资源进行写操作</td>
</tr>
<tr>
<td style="text-align:left"><code>edit</code></td>
<td style="text-align:left">无</td>
<td style="text-align:left">允许对名字空间的大多数对象进行读/写操作。此角色不允许查看或者修改角色或者角色绑定。 不过可以访问 <code>Secret</code>，以名字空间中任何 <code>ServiceAccount</code> 的身份运行 <code>Pod</code>， 所以可以用来了解名字空间内所有服务账户的 <code>API</code> 访问级别。 不允许对 <code>k8s 1.22</code> 以上版本的 <code>Endpoints</code> 资源进行写操作</td>
</tr>
<tr>
<td style="text-align:left"><code>view</code></td>
<td style="text-align:left">无</td>
<td style="text-align:left">允许对名字空间的大多数对象有只读权限。 它不允许查看角色或角色绑定。此角色不允许查看 <code>Secrets</code>，因为读取 <code>Secret</code> 的内容意味着可以访问名字空间中 <code>ServiceAccount</code> 的凭据信息，进而允许利用名字空间中任何 <code>ServiceAccount</code> 的身份访问 <code>API</code>（这是一种特权提升）。</td>
</tr>
</tbody>
</table>
<p>面向用户的 <code>ClusterRole</code> 聚合标签：</p>
<div class="highlight" id="id-14"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rbac.authorization.k8s.io/aggregate-to-admin</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rbac.authorization.k8s.io/aggregate-to-edit</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rbac.authorization.k8s.io/aggregate-to-view</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>以下是核心组件的 <code>ClusterRole</code></p>
<table>
<thead>
<tr>
<th style="text-align:left">默认的 <code>ClusterRole</code></th>
<th style="text-align:left">默认关联的主体</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>system:kube-scheduler</code></td>
<td style="text-align:left"><code>system:kube-scheduler</code> 用户</td>
<td style="text-align:left">允许访问 <code>scheduler</code> 组件所需要的资源</td>
</tr>
<tr>
<td style="text-align:left"><code>system:volume-scheduler</code></td>
<td style="text-align:left"><code>system:kube-scheduler</code> 用户</td>
<td style="text-align:left">允许访问 <code>kube-scheduler</code> 组件所需要的资源</td>
</tr>
<tr>
<td style="text-align:left"><code>system:kube-controller-manager</code></td>
<td style="text-align:left"><code>system:kube-controller-manager</code> 用户</td>
<td style="text-align:left">允许访问控制器管理器组件所需要的资源</td>
</tr>
<tr>
<td style="text-align:left"><code>system:node</code></td>
<td style="text-align:left">无</td>
<td style="text-align:left">允许访问 <code>kubelet</code> 所需要的资源，包括对所有 <code>Secret</code> 的读操作和对所有 <code>Pod</code> 状态对象的写操作。官方建议是使用 <code>node</code> 鉴权来实现这些权限，之所以得到保留是为了与从 <code>v1.8</code> 之前版本升级而来的集群兼容。</td>
</tr>
<tr>
<td style="text-align:left"><code>system:node-proxier</code></td>
<td style="text-align:left"><code>system:kube-proxy</code> 用户</td>
<td style="text-align:left">允许访问 <code>kube-proxy</code> 组件所需要的资源。</td>
</tr>
</tbody>
</table>
<p>以下是其它组件的 <code>ClusterRole</code></p>
<table>
<thead>
<tr>
<th style="text-align:left">默认的 <code>ClusterRole</code></th>
<th style="text-align:left">默认关联的主体</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>system:auth-delegator</code></td>
<td style="text-align:left">无</td>
<td style="text-align:left">第三方的身份认证和鉴权检查操作权限</td>
</tr>
<tr>
<td style="text-align:left"><code>system:kube-aggregator</code></td>
<td style="text-align:left">无</td>
<td style="text-align:left">为 <code>kube-aggregator</code> 组件定义的权限</td>
</tr>
<tr>
<td style="text-align:left"><code>system:kube-dns</code></td>
<td style="text-align:left">无</td>
<td style="text-align:left"><code>kube-system</code> 名称空间中的 <code>kube-dns</code> 服务账号</td>
</tr>
<tr>
<td style="text-align:left"><code>system:kubelet-api-admin</code></td>
<td style="text-align:left">无</td>
<td style="text-align:left">允许 <code>kubelet API</code> 的完全访问的权限</td>
</tr>
<tr>
<td style="text-align:left"><code>system:node-bootstrapper</code></td>
<td style="text-align:left">无</td>
<td style="text-align:left">允许访问执行 <code>kubelet TLS</code> 启动引导所需要的权限</td>
</tr>
<tr>
<td style="text-align:left"><code>system:node-problem-detector</code></td>
<td style="text-align:left">无</td>
<td style="text-align:left">为 <code>node-problem-detector</code> 组件定义的权限</td>
</tr>
<tr>
<td style="text-align:left"><code>system:persistent-volume-provisioner</code></td>
<td style="text-align:left">无</td>
<td style="text-align:left">允许访问大部分动态卷驱动所需要的权限</td>
</tr>
<tr>
<td style="text-align:left"><code>system:monitoring</code></td>
<td style="text-align:left"><code>system:monitoring</code> 组</td>
<td style="text-align:left">允许对控制平面监控端点的读取访问权限</td>
</tr>
</tbody>
</table>
<p>控制器管理器（<code>kube-controller-manager</code>）的 <code>ClusterRole</code>。当使用 <code>kube-controller-manager --use-service-account-credentials</code> 启动时，使用单独的服务账户来启动每个控制器。 每个内置控制器都有相应的、前缀为 <code>system:controller:</code> 的角色。 否则它使用自己的身份凭据来运行所有的控制器，该身份必须被授予所有相关的角色</p>
<h4 id="初始化与预防权限提升" class="heading-element">
  <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e4%b8%8e%e9%a2%84%e9%98%b2%e6%9d%83%e9%99%90%e6%8f%90%e5%8d%87" class="heading-mark"></a>初始化与预防权限提升</h4><p><code>RBAC API</code> 会阻止用户通过编辑角色或者角色绑定来提升权限。 由于这一点是在 <code>API</code> 级别实现的，所以在 <code>RBAC</code> 鉴权组件未启用的状态下依然可以正常工作。</p>
<p>只有在符合以下条件之一的情况才能创建/更新权限：</p>
<ul>
<li>已经拥有角色中包含的所有权限，且其作用域与正被修改的对象作用域相同。即明确授权允许修改或创建其它 <code>Role/ClusterRole</code> 的权限</li>
<li>授权 <code>escalate</code> 权限</li>
</ul>
<p>只以在符合以下条件之一才能创建或修改关联主体：</p>
<ul>
<li>有权限创建或更新 <code>RoleBinding</code> 或 <code>ClusterRoleBinding</code> 对象</li>
<li>有 <code>bind</code> 权限</li>
</ul>
<p>下面的 <code>ClusterRole</code> 和 <code>RoleBinding</code> 将允许用户 <code>user-1</code> 把名字空间 <code>user-1-namespace</code> 中的 <code>admin</code>、<code>edit</code> 和 <code>view</code> 角色赋予其他用户。</p>
<div class="highlight" id="id-15"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apiVersion: rbac.authorization.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: ClusterRole
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: role-grantor
</span></span><span class="line"><span class="cl">rules:
</span></span><span class="line"><span class="cl">- apiGroups: <span class="o">[</span><span class="s2">&#34;rbac.authorization.k8s.io&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">  resources: <span class="o">[</span><span class="s2">&#34;rolebindings&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">  verbs: <span class="o">[</span><span class="s2">&#34;create&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">- apiGroups: <span class="o">[</span><span class="s2">&#34;rbac.authorization.k8s.io&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">  resources: <span class="o">[</span><span class="s2">&#34;clusterroles&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">  verbs: <span class="o">[</span><span class="s2">&#34;bind&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 忽略 resourceNames 意味着允许绑定任何 ClusterRole</span>
</span></span><span class="line"><span class="cl">  resourceNames: <span class="o">[</span><span class="s2">&#34;admin&#34;</span>,<span class="s2">&#34;edit&#34;</span>,<span class="s2">&#34;view&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: rbac.authorization.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: RoleBinding
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: role-grantor-binding
</span></span><span class="line"><span class="cl">  namespace: user-1-namespace
</span></span><span class="line"><span class="cl">roleRef:
</span></span><span class="line"><span class="cl">  apiGroup: rbac.authorization.k8s.io
</span></span><span class="line"><span class="cl">  kind: ClusterRole
</span></span><span class="line"><span class="cl">  name: role-grantor
</span></span><span class="line"><span class="cl">subjects:
</span></span><span class="line"><span class="cl">- apiGroup: rbac.authorization.k8s.io
</span></span><span class="line"><span class="cl">  kind: User
</span></span><span class="line"><span class="cl">  name: user-1</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="服务账户权限" class="heading-element">
  <a href="#%e6%9c%8d%e5%8a%a1%e8%b4%a6%e6%88%b7%e6%9d%83%e9%99%90" class="heading-mark"></a>服务账户权限</h4><p>默认的 <code>RBAC</code> 策略为控制面组件、节点和控制器授予权限。 但是不会对 <code>kube</code>-<code>system</code> 名字空间之外的服务账户授予权限。 （除了授予所有已认证用户的发现权限）。可以根据需要向特定 <code>ServiceAccount</code> 授予特定权限。以下是按从最安全到最不安全的授权顺序：</p>
<ol>
<li>为特定应用的服务账户授予权限（最佳实践）</li>
<li>授予某名字空间中的 <code>default</code> 服务账户权限</li>
<li>授予名字空间中所有服务账户权限</li>
<li>在集群范围内为所有服务账户授予一个受限权限（不鼓励）</li>
<li>授予超级用户访问权限给集群范围内的所有服务帐户（强烈不鼓励）</li>
</ol>
<h4 id="endpoints-写入权限" class="heading-element">
  <a href="#endpoints-%e5%86%99%e5%85%a5%e6%9d%83%e9%99%90" class="heading-mark"></a><code>Endpoints</code> 写入权限</h4><p>在 <code>k8s 1.22</code> 之前的版本中，<code>edit</code> 与 <code>admin</code> 角色包含对 <code>Endpoints</code> 资源写入权限作为 <a href="https://github.com/kubernetes/kubernetes/issues/103675"target="_blank" rel="external nofollow noopener noreferrer"><code>CVE-2021-25740</code></a> 安全问题的缓解措施。在 <code>k8s 1.22</code> 及其以后的版本中不包含该权限（升级到 <code>k8s 1.22</code> 及其以后版本保留了该权限）。如果希望在新集群的聚合角色里保留此访问权限，你可以创建下面 <code>ClusterRole</code>：</p>
<div class="highlight" id="id-16"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubernetes.io/description</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      Add endpoints write permissions to the edit and admin roles. This was
</span></span></span><span class="line"><span class="cl"><span class="sd">      removed by default in 1.22 because of CVE-2021-25740. See
</span></span></span><span class="line"><span class="cl"><span class="sd">      https://issue.k8s.io/103675. This can allow writers to direct LoadBalancer
</span></span></span><span class="line"><span class="cl"><span class="sd">      or Ingress implementations to expose backend IPs that would not otherwise
</span></span></span><span class="line"><span class="cl"><span class="sd">      be accessible, and can circumvent network policies or security controls
</span></span></span><span class="line"><span class="cl"><span class="sd">      intended to prevent/isolate access to those backends.      </span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rbac.authorization.k8s.io/aggregate-to-edit</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">custom:aggregate-to-edit:endpoints</span><span class="w"> </span><span class="c"># 你可以随意愿更改这个 name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;endpoints&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;create&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;delete&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;deletecollection&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;patch&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;update&#34;</span><span class="p">]</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="从-abac-鉴权转换到-rbac-鉴权" class="heading-element">
  <a href="#%e4%bb%8e-abac-%e9%89%b4%e6%9d%83%e8%bd%ac%e6%8d%a2%e5%88%b0-rbac-%e9%89%b4%e6%9d%83" class="heading-mark"></a>从 <code>ABAC</code> 鉴权转换到 <code>RBAC</code> 鉴权</h4><p>原来运行较老版本 <code>k8s</code> 的集群通常会使用限制宽松的 <code>ABAC</code> 策略， 包括授予所有服务帐户全权访问 <code>API</code> 的能力。默认的 <code>RBAC</code> 策略为控制面组件、节点和控制器等授予有限的权限，但不会为 <code>kube-system</code> 名称空间外的服务账户授权（除了授予所有认证用户的发现权限之外），这样做虽然安全得多，但可能会干扰期望自动获得 <code>API</code> 权限的现有工作负载。 这里有两种方法来完成这种转换:</p>
<p>方法 1：同时运行 <code>RBAC</code> 和 <code>ABAC</code> 鉴权模式， 并指定包含现有的 <code>ABAC</code> 策略的策略文件：</p>
<div class="highlight" id="id-17"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># --vmodule=rbac RBAC 日志记录级别</span>
</span></span><span class="line"><span class="cl">--vmodule<span class="o">=</span>rbac*<span class="o">=</span><span class="m">5</span> --authorization-mode<span class="o">=</span>...,RBAC,ABAC --authorization-policy-file<span class="o">=</span>mypolicy.json</span></span></code></pre></td></tr></table>
</div>
</div><p><code>api</code> 服务启动后用服务账户去做 <code>ABAC</code> 鉴权授予的权限，根据日志 <code>ABAC</code> 中的拒绝提示（以 <code>RBAC</code> 为前缀）创建或修改 <code>RBAC</code> 直到没有拒绝日志后从 <code>--authorization-mode=</code> 选项中移除 <code>ABAC</code> 参数与删除 <code>--authorization-policy-file</code> 选项</p>
<p>方法2：使用 <code>RBAC</code> 角色绑定复制宽松的 <code>ABAC</code> 策略：</p>
<div class="highlight" id="id-18"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 允许 所有 服务帐户充当集群管理员。 容器中运行的所有应用程序都会自动收到服务帐户的凭据，可以对 API 执行任何操作， 包括查看 Secret 和修改权限。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 不推荐使用该方式</span>
</span></span><span class="line"><span class="cl">kubectl create clusterrolebinding permissive-binding <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --clusterrole<span class="o">=</span>cluster-admin <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --user<span class="o">=</span>admin <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --user<span class="o">=</span>kubelet <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --group<span class="o">=</span>system:serviceaccounts</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="node-鉴权" class="heading-element">
  <a href="#node-%e9%89%b4%e6%9d%83" class="heading-mark"></a><code>node</code> 鉴权</h3><p>节点鉴权是一种特殊用途的鉴权模式，专门对 <code>kubelet</code> 发出的 <code>API</code> 请求进行授权。允许 <code>kubelet</code> 执行 <code>API</code> 操作。</p>
<ul>
<li>读取： <code>services</code>、<code>endpoints</code>、<code>nodes</code>、<code>pods</code> 以及绑定到 <code>kubelet</code> 节点的 <code>Pod</code> 相关资源（<code>Secret</code>、<code>ConfigMap</code>、<code>PersistentVolumeClaim</code> 和持久卷）</li>
<li>写入：事件、<code>pod</code> 及其状态（启用 <code>NodeRestriction</code> 准入插件以限制 <code>kubelet</code> 只能修改绑定到自身的 <code>Pod</code>）、节点及其状态（启用 <code>NodeRestriction</code> 准入插件以限制 <code>kubelet</code> 只能修改自己的节点）</li>
<li>对于基于 <code>TLS</code> 的启动引导过程时使用的 <code>certificationsigningrequests API</code> 的读/写权限</li>
<li>为委派的身份验证/鉴权检查创建 <code>TokenReview</code> 和 <code>SubjectAccessReview</code> 的能力</li>
</ul>
<p>在以后的版本中节点鉴权器可能会添加或删除权限，以确保 <code>kubelet</code> 具有正确操作所需的最小权限集。为了获得节点鉴权器的授权，<code>kubelet</code> 必须使用一个凭证以表示它在 <code>system:nodes</code> 组中，用户名为 <code>system:node:&lt;nodeName&gt;</code>。上述的组名和用户名格式要与 <code>kubelet TLS</code> 启动引导 过程中为每个 <code>kubelet</code> 创建的标识相匹配。</p>
<p>节点名称必须与 <code>kubelet</code> 注册时使用的节点名称一致。获取节点名称优先级从上往下：</p>
<ul>
<li>使用 <code>kubelet --cloud-provider</code> 选项时具体的主机名可能由云提供商确定</li>
<li>使用 <code>kubelet --hostname-override</code> 选项指定的值</li>
<li>使用 <code>hostname</code> 命令提供的值</li>
</ul>
<p>在 <code>kube-apiserver --authorization-mode</code> 选项包含 <code>Node</code> 参数时表示启用了 <code>Node</code> 鉴权。想限制 <code>kubelet</code> 可写入的 <code>API</code> 对象需要使用 <code>kube-apiserver --enable-admission-plugins</code> 选项启用 <code>NodeRestriction</code> 准入管制器插件</p>
<p><code>Node</code> 鉴权只授权于 <code>system:nodes</code> 组的主体，如果 <code>kubelet</code> 具有 <code>system:nodes</code> 组的凭证，但无法给出关联的节点标识（<code>system:node:...</code> 格式的用户名），也不会被 <code>Node</code> 鉴权模式授权。</p>
<h4 id="版本变动" class="heading-element">
  <a href="#%e7%89%88%e6%9c%ac%e5%8f%98%e5%8a%a8" class="heading-mark"></a>版本变动</h4><p>使用 <code>RBAC</code> 时，将继续创建 <code>system:node</code> 集群角色，以便与将其他用户或组绑定到该角色的部署方法兼容。</p>
<ul>
<li>在 <code>k8s 1.6</code> 版本中，使用 <code>RBAC</code> 鉴权时，名为 <code>system:nodes</code> 的 <code>ClusterRole</code> 资源会自动关联到 <code>system:node</code> 组</li>
<li>在 <code>k8s 1.7</code> 版本中，不再推荐将 <code>system:nodes</code> 组自动绑定到 <code>system:node</code> 角色，因为节点鉴权器通过对 <code>Secret</code> 和 <code>ConfigMap</code> 访问的额外限制完成了相同的任务。 如果同时启用了 <code>Node</code> 和 <code>RBAC</code> 鉴权模。如果同时启用了 <code>RBAC</code> 与 <code>Node</code> 鉴权，则不会自动绑定</li>
<li>在 <code>k8s 1.8</code> 版本中，绑定将根本不会被创建</li>
</ul>
<p>从 <code>k8s 1.7</code> 版本之前升级的使用 <code>RBAC</code> 群将继续按原样运行，因为 <code>system:nodes</code> 组绑定已经存在。如果集群管理员希望开始使用 <code>Node</code> 鉴权器和 <code>NodeRestriction</code> 准入插件来限制节点对 <code>API</code> 的访问。可以通过以下操作完成：</p>
<ol>
<li>启用 <code>Node</code> 鉴权与 <code>NodeRestriction</code> 准入控制器插件</li>
<li>确保所有 <code>kubelet</code> 的凭据符合组/用户名要求</li>
<li>审核 <code>API</code> 服务器日志以确保 <code>Node</code> 鉴权器不会拒绝来自 <code>kubelet</code> 的请求（日志中没有持续的 <code>NODE DENY</code> 消息）</li>
<li>删除 <code>system:node</code> 集群角色绑定</li>
</ol>
<h2 id="准入控制器" class="heading-element">
  <a href="#%e5%87%86%e5%85%a5%e6%8e%a7%e5%88%b6%e5%99%a8" class="heading-mark"></a>准入控制器</h2><p>准入控制器是一段代码，它会在请求通过认证和授权之后、对象被持久化之前拦截到达 <code>API</code> 服务器的请求。可以执行验证和变更操作。它只限制创建、删除、修改对象或连接到代理的请求，不限制读取对象的请求。</p>
<p>准入控制过程分为以下两个阶段，某些控制器既是变更准入控制器又是验证准入控制器。如果两个阶段之一的任何一个控制器拒绝了某请求，则整个请求将立即被拒绝，并向最终用户返回错误。</p>
<ol>
<li>运行变更准入控制器</li>
<li>运行验证准入控制器</li>
</ol>
<p>准入控制器有很多，它们都编译进 <code>kube-apiserver</code> 可执行文件，并且只能由集群管理员配置。</p>
<ul>
<li>启用准入控制器：<code>kube-apiserver --enable-admission-plugins=NamespaceLifecycle,LimitRanger ...</code></li>
<li>关闭准入控制器：<code>kube-apiserver --disable-admission-plugins=PodNodeSelector,AlwaysDeny ...</code></li>
<li>查看已启用的准入控制器：<code>kube-apiserver -h | grep enable-admission-plugins</code></li>
</ul>
<h3 id="noderestriction" class="heading-element">
  <a href="#noderestriction" class="heading-mark"></a><code>NodeRestriction</code></h3><p>该准入控制器限制某个 <code>kubelet</code> 可以修改的 <code>Node</code> 与 <code>Pod</code> 资源对象，它通过限制 <code>system:nodes</code> 组（成员名格式为 <code>system:node:&lt;nodeName&gt;</code> ）的权限实现的。但无法更新或删除 <code>Node</code> 对象的污点。</p>
<p>该插件对 <code>kubelet</code> 做了以下限制：</p>
<ul>
<li>允许 <code>kubelet</code> 添加、修改、删除以下标签
<ul>
<li><code>kubernetes.io/hostname</code></li>
<li><code>kubernetes.io/arch</code></li>
<li><code>kubernetes.io/os</code></li>
<li><code>beta.kubernetes.io/instance-type</code></li>
<li><code>node.kubernetes.io/instance-type</code></li>
<li><code>failure-domain.beta.kubernetes.io/region</code> （已弃用）</li>
<li><code>failure-domain.beta.kubernetes.io/zone</code> （已弃用）</li>
<li><code>topology.kubernetes.io/region</code></li>
<li><code>topology.kubernetes.io/zone</code></li>
<li><code>kubelet.kubernetes.io/</code> 为前缀的标签</li>
<li><code>node.kubernetes.io/</code> 为前缀的标签</li>
</ul>
</li>
<li>禁止 <code>kubelet</code> 添加、修改、删除以下标签
<ul>
<li><code>node-restriction.kubernetes.io/</code> 为前缀的标签（这类前缀的标签时保留给管理员的，用以为 <code>Node</code> 对象设置标签以隔离工作负载）</li>
<li><code>kubernetes.io</code> 为前缀的标签（除非明确允许）</li>
<li><code>k8s.io</code> 为前缀的标签（除非明确允许）</li>
</ul>
</li>
</ul>
<h1 id="kubelet-api-访问控制" class="heading-element">
  <a href="#kubelet-api-%e8%ae%bf%e9%97%ae%e6%8e%a7%e5%88%b6" class="heading-mark"></a><code>kubelet API</code> 访问控制</h1><p>可以通过 <code>kubelet</code> 的监听端口访问 <code>kubelet API</code>，这些 <code>API</code> 可以访问敏感度不同的数据， 并允许你在节点上和容器内以不同级别的权限执行操作。</p>
<h2 id="kubelet-api-身份认证" class="heading-element">
  <a href="#kubelet-api-%e8%ba%ab%e4%bb%bd%e8%ae%a4%e8%af%81" class="heading-mark"></a><code>kubelet API</code> 身份认证</h2><p><code>kubelet API</code> 有以下身份认证方式：</p>
<ul>
<li>匿名请求：没有明确说明身份的用户赋予 <code>system:anonymous</code> 用户名和 <code>system:unauthenticated</code> 组。</li>
<li><code>x509</code> 客户端证书认证</li>
<li><code>token</code> 认证</li>
</ul>
<h3 id="匿名请求-1" class="heading-element">
  <a href="#%e5%8c%bf%e5%90%8d%e8%af%b7%e6%b1%82-1" class="heading-mark"></a>匿名请求</h3><p>使用 <code>kubelet ----anonymous-auth=true</code> 或在配置文件中使用启用</p>
<div class="highlight" id="id-19"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@k8s01 ~<span class="o">]</span><span class="c1"># cat /var/lib/kubelet/config.yaml</span>
</span></span><span class="line"><span class="cl">apiVersion: kubelet.config.k8s.io/v1beta1
</span></span><span class="line"><span class="cl">authentication:
</span></span><span class="line"><span class="cl">  anonymous:
</span></span><span class="line"><span class="cl">    enabled: true</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="x509-认证" class="heading-element">
  <a href="#x509-%e8%ae%a4%e8%af%81" class="heading-mark"></a><code>x509</code> 认证</h3><p><code>kube-apiserver</code> 使用 <code>x509</code> 认证 <code>kubelt API</code> 需要做以下操作（默认是使用的）</p>
<ol>
<li><code>kubelet</code> 指定一个 <code>CA</code> 证书，用于验证客户端证书</li>
</ol>
<div class="highlight" id="id-20"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 可以使用 kubelet --client-ca-file 选项指定</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s01 ~<span class="o">]</span><span class="c1"># cat /var/lib/kubelet/config.yaml</span>
</span></span><span class="line"><span class="cl">apiVersion: kubelet.config.k8s.io/v1beta1
</span></span><span class="line"><span class="cl">authentication:
</span></span><span class="line"><span class="cl">  x509:
</span></span><span class="line"><span class="cl">    clientCAFile: /etc/kubernetes/pki/ca.crt</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li><code>kube-apiserver</code> 使用 <code>--kubelet-client-certificate</code> 指定客户端证书，使用 <code>--kubelet-client-key</code> 指定秘钥</li>
</ol>
<div class="highlight" id="id-21"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@k8s01 ~<span class="o">]</span><span class="c1"># kubectl get pod kube-apiserver-k8s01.localdomain -n kube-system -o=jsonpath=&#39;{$.spec.containers[0].command}&#39; | jq</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;--kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;--kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key&#34;</span>,</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="token" class="heading-element">
  <a href="#token" class="heading-mark"></a><code>token</code></h3><ol>
<li><code>kube-apiserver</code> 服务中启用了 <code>authentication.k8s.io API</code> 组</li>
</ol>
<div class="highlight" id="id-22"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@node1 ~<span class="o">]</span><span class="c1"># kubectl api-versions | grep &#34;authentication.k8s.io&#34;</span>
</span></span><span class="line"><span class="cl">authentication.k8s.io/v1</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li><code>kubelet</code> 启用 <code>TokenReview API</code> 进行身份认证</li>
</ol>
<div class="highlight" id="id-23"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 可以使用 --authentication-token-webhook 选项指定</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s01 ~<span class="o">]</span><span class="c1"># cat /var/lib/kubelet/config.yaml</span>
</span></span><span class="line"><span class="cl">apiVersion: kubelet.config.k8s.io/v1beta1
</span></span><span class="line"><span class="cl">authentication:
</span></span><span class="line"><span class="cl">  webhook:
</span></span><span class="line"><span class="cl">    cacheTTL: 2m0s
</span></span><span class="line"><span class="cl">    enabled: true</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="鉴权" class="heading-element">
  <a href="#%e9%89%b4%e6%9d%83" class="heading-mark"></a>鉴权</h2><p><code>kubelet</code> 鉴权模式由 <code>--authorization-mode</code> 选项指定，有以下值：</p>
<ul>
<li><code>AlwaysAllow</code>: 允许所有请求（缺省时默认值）</li>
<li><code>Webhook</code>: 通过 <code>SubjectAccessReview API</code> 组委派给 <code>kube-apiserver</code> 进行鉴权。在此模式下确保传递给 <code>API</code> 服务器的由 <code>--kubelet-client-certificate</code> 和 <code>--kubelet-client-key</code> 标志标识的用户具有以下属性的鉴权：
<ul>
<li><code>verb=*, resource=nodes, subresource=proxy</code></li>
<li><code>verb=*, resource=nodes, subresource=stats</code></li>
<li><code>verb=*, resource=nodes, subresource=log</code></li>
<li><code>verb=*, resource=nodes, subresource=spec</code></li>
<li><code>verb=*, resource=nodes, subresource=metrics</code></li>
</ul>
</li>
</ul>
<p><code>kubelet</code> 使用与 <code>apiserver</code> 相同的请求属性对请求进行鉴权</p>
<table>
<thead>
<tr>
<th style="text-align:left"><code>HTTP</code> 动词</th>
<th style="text-align:left">请求动词</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>POST</code></td>
<td style="text-align:left"><code>create</code></td>
</tr>
<tr>
<td style="text-align:left"><code>GET</code>, <code>HEAD</code></td>
<td style="text-align:left"><code>get</code></td>
</tr>
<tr>
<td style="text-align:left"><code>PUT</code></td>
<td style="text-align:left"><code>update</code></td>
</tr>
<tr>
<td style="text-align:left"><code>PATCH</code></td>
<td style="text-align:left"><code>patch</code></td>
</tr>
<tr>
<td style="text-align:left"><code>DELETE</code></td>
<td style="text-align:left"><code>delete</code></td>
</tr>
</tbody>
</table>
<p><code>api url</code> 中地址为 <code>kubelet</code> 监听的 <code>ip:port</code>，名称空间、<code>API</code> 组、<code>node</code>都是空的。如：<code>https://localhost:10250/metrics</code></p>
<table>
<thead>
<tr>
<th style="text-align:left"><code>Kubelet API</code></th>
<th style="text-align:left">资源/子资源</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>/stats/*</code></td>
<td style="text-align:left">nodes/stats</td>
</tr>
<tr>
<td style="text-align:left"><code>/metrics/*</code></td>
<td style="text-align:left">nodes/metrics</td>
</tr>
<tr>
<td style="text-align:left"><code>/logs/*</code></td>
<td style="text-align:left">nodes/log</td>
</tr>
<tr>
<td style="text-align:left"><code>/spec/*</code></td>
<td style="text-align:left">nodes/spec</td>
</tr>
<tr>
<td style="text-align:left">其它所有</td>
<td style="text-align:left">nodes/proxy</td>
</tr>
</tbody>
</table>
<h1 id="api" class="heading-element">
  <a href="#api" class="heading-mark"></a>API</h1><p>查看已启用的 <code>API</code></p>
<div class="highlight" id="id-24"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@node1 ~<span class="o">]</span><span class="c1"># kubectl api-resources</span>
</span></span><span class="line"><span class="cl">...</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="subjectaccessreview" class="heading-element">
  <a href="#subjectaccessreview" class="heading-mark"></a>SubjectAccessReview</h2></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2022-10-04 11:56:54">更新于 2022-10-04&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/k8s-API/" class="post-tag" title="标签 - k8s API">k8s API</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/CMDjq/" class="post-nav-item" rel="prev" title="jq - 命令行 josn 数据处理工具"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>jq - 命令行 josn 数据处理工具</a>
      <a href="/linuxBash/" class="post-nav-item" rel="next" title="bash shell脚本">bash shell脚本<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.115.3"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.1"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2022 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/pangu/pangu.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"lightgallery":true,"pangu":{"enable":true,"selector":"article"},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":true,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.3,"type":"fuse","useExtendedSearch":false}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
