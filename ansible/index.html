<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Ansible 是一种 IT 自动化工具 - 小厮</title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="xiaosi" /><meta name="keywords" content='ansible' /><meta itemprop="name" content="Ansible 是一种 IT 自动化工具">
<meta itemprop="description" content=""><meta itemprop="datePublished" content="2023-04-18T16:44:59+08:00" />
<meta itemprop="dateModified" content="2023-04-20T22:30:39+08:00" />
<meta itemprop="wordCount" content="8865">
<meta itemprop="keywords" content="ansible," /><meta property="og:title" content="Ansible 是一种 IT 自动化工具" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/ansible/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-18T16:44:59+08:00" />
<meta property="article:modified_time" content="2023-04-20T22:30:39+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Ansible 是一种 IT 自动化工具"/>
<meta name="twitter:description" content=""/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#ffffff" data-dark="#252627" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="/ansible/" /><link rel="prev" href="/windowsWsl/" /><link rel="next" href="/neovimInitialization/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Ansible 是一种 IT 自动化工具",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "\/ansible\/"
    },"genre": "posts","keywords": "ansible","wordcount":  8865 ,
    "url": "\/ansible\/","datePublished": "2023-04-18T16:44:59+08:00","dateModified": "2023-04-20T22:30:39+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "小厮"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="wide"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="小厮"><span class="header-title-text">首页</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class='fa-solid fa-archive fa-fw fa-sm'></i> 所有文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="小厮"><span class="header-title-text">首页</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class='fa-solid fa-archive fa-fw fa-sm'></i> 所有文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container container-reverse"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Ansible 是一种 IT 自动化工具</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      小厮</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/ansible/" class="post-category" title="分类 - ansible"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> ansible</a></span></div><div class="post-meta-line"><span title="发布于 2023-04-18 16:44:59"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2023-04-18">2023-04-18</time></span>&nbsp;<span title="更新于 2023-04-20 22:30:39"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden="true"></i><time datetime="2023-04-20">2023-04-20</time></span>&nbsp;<span title="8865 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 8900 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 18 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#清单文件">清单文件</a>
      <ul>
        <li><a href="#主机分组">主机分组</a></li>
        <li><a href="#组嵌套">组嵌套</a></li>
        <li><a href="#主机范围">主机范围</a></li>
        <li><a href="#主机变量">主机变量</a></li>
        <li><a href="#清单目录">清单目录</a></li>
        <li><a href="#变量组">变量组</a></li>
        <li><a href="#变量组嵌套">变量组嵌套</a></li>
        <li><a href="#自定义变量文件">自定义变量文件</a></li>
      </ul>
    </li>
    <li><a href="#变量">变量</a>
      <ul>
        <li><a href="#连接到主机相关变量">连接到主机相关变量</a></li>
      </ul>
    </li>
    <li><a href="#连接方式">连接方式</a>
      <ul>
        <li><a href="#ssh-相关配置">ssh 相关配置</a></li>
      </ul>
    </li>
    <li><a href="#playbooks">Playbooks</a>
      <ul>
        <li><a href="#任务状态">任务状态</a>
          <ul>
            <li><a href="#重置-failed-条件">重置 failed 条件</a></li>
            <li><a href="#重置-changed-条件">重置 changed 条件</a></li>
          </ul>
        </li>
        <li><a href="#过滤器">过滤器</a></li>
        <li><a href="#过滤数据处理数据">过滤数据处理数据</a>
          <ul>
            <li><a href="#处理未定义变量">处理未定义变量</a></li>
            <li><a href="#为-truefalsenull-定义不同的值">为 true/false/null 定义不同的值</a></li>
            <li><a href="#查看数据类型">查看数据类型</a></li>
            <li><a href="#将字典转换为列表">将字典转换为列表</a></li>
            <li><a href="#将列表转换为字典">将列表转换为字典</a></li>
            <li><a href="#强制数据类型">强制数据类型</a></li>
          </ul>
        </li>
        <li><a href="#判断数据">判断数据</a>
          <ul>
            <li><a href="#比较字符串">比较字符串</a></li>
            <li><a href="#判断是否加密">判断是否加密</a></li>
            <li><a href="#truthy-and-falsy">truthy and falsy</a></li>
            <li><a href="#版本号比较">版本号比较</a></li>
            <li><a href="#集合比较">集合比较</a></li>
            <li><a href="#列表是否包含值">列表是否包含值</a></li>
            <li><a href="#判断列表值是否为-true">判断列表值是否为 True</a></li>
            <li><a href="#判断路径">判断路径</a></li>
            <li><a href="#检查任务状态">检查任务状态</a></li>
            <li><a href="#判断类型">判断类型</a></li>
          </ul>
        </li>
        <li><a href="#获取当前时间">获取当前时间</a></li>
        <li><a href="#循环">循环</a>
          <ul>
            <li><a href="#遍历列表">遍历列表</a></li>
            <li><a href="#遍历哈希">遍历哈希</a></li>
            <li><a href="#遍历字典">遍历字典</a></li>
            <li><a href="#重复执行任务知道满足条件">重复执行任务知道满足条件</a></li>
            <li><a href="#遍历清单文件">遍历清单文件</a></li>
            <li><a href="#限制循环输出信息">限制循环输出信息</a></li>
            <li><a href="#暂停循环">暂停循环</a></li>
            <li><a href="#循环列表的索引">循环列表的索引</a></li>
            <li><a href="#loop-扩展信息">loop 扩展信息</a></li>
          </ul>
        </li>
        <li><a href="#执行任务位置">执行任务位置</a>
          <ul>
            <li><a href="#本地执行">本地执行</a></li>
          </ul>
        </li>
        <li><a href="#条件句">条件句</a></li>
        <li><a href="#任务状态为-failed-触发其它任务">任务状态为 failed 触发其它任务</a></li>
        <li><a href="#任务状态为-changed-时触发其他任务">任务状态为 changed 时触发其他任务</a></li>
        <li><a href="#playbooks-错误处理">Playbooks 错误处理</a>
          <ul>
            <li><a href="#忽略-failed-状态">忽略 failed 状态</a></li>
            <li><a href="#忽略-unreachable-错误">忽略 UNREACHABLE 错误</a></li>
            <li><a href="#确保-shell-命令成功">确保 shell 命令成功</a></li>
            <li><a href="#等待补充">等待补充</a></li>
          </ul>
        </li>
        <li><a href="#ansible-lint">ansible-lint</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><!-- FileID: FID -->
<blockquote>
<p>运行环境：</p>
<ul>
<li>ansible: 2.9</li>
</ul>
<p>内容来自以下文档：</p>
<ul>
<li><a href="https://docs.ansible.com/ansible/latest/index.html"target="_blank" rel="external nofollow noopener noreferrer">ansible 文档</a></li>
</ul>
</blockquote>
<!-- 网址链接 -->
<!-- 图片链接 -->
<!-- 其它链接 -->
<h1 id="清单文件" class="heading-element">
  <a href="#%e6%b8%85%e5%8d%95%e6%96%87%e4%bb%b6" class="heading-mark"></a>清单文件</h1><p>清单文件中定义了被管理主机信息，存储格式是以配置文件中<code>inventory</code>部分<code>enable_plugins</code>选项指定。通常是<code>yaml</code>或<code>ini</code>格式</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># grep &#39;enable_plugins&#39; /etc/ansible/ansible.cfg</span>
</span></span><span class="line"><span class="cl"><span class="c1">#enable_plugins = host_list, virtualbox, yaml, constructed</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>ini</code> 格式示例：</p>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">mail.example.com</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[webservers]</span>
</span></span><span class="line"><span class="cl"><span class="na">foo.example.com</span>
</span></span><span class="line"><span class="cl"><span class="na">bar.example.com</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[dbservers]</span>
</span></span><span class="line"><span class="cl"><span class="na">one.example.com</span>
</span></span><span class="line"><span class="cl"><span class="na">two.example.com</span>
</span></span><span class="line"><span class="cl"><span class="na">three.example.com</span></span></span></code></pre></td></tr></table>
</div>
</div><p>以下是<code>yaml</code> 格式示例，它表达含义与上面的 <code>ini</code> 格式相同</p>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">all:
</span></span><span class="line"><span class="cl">  hosts:
</span></span><span class="line"><span class="cl">    mail.example.com:
</span></span><span class="line"><span class="cl">  children:
</span></span><span class="line"><span class="cl">    webservers:
</span></span><span class="line"><span class="cl">      hosts:
</span></span><span class="line"><span class="cl">        foo.example.com:
</span></span><span class="line"><span class="cl">        bar.example.com:
</span></span><span class="line"><span class="cl">    dbservers:
</span></span><span class="line"><span class="cl">      hosts:
</span></span><span class="line"><span class="cl">        one.example.com:
</span></span><span class="line"><span class="cl">        two.example.com:
</span></span><span class="line"><span class="cl">        three.example.com:</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="主机分组" class="heading-element">
  <a href="#%e4%b8%bb%e6%9c%ba%e5%88%86%e7%bb%84" class="heading-mark"></a>主机分组</h2><p>可以把被管理的服务器按需求进行分组（如地理位置、用途、系统版本等），一个服务器可以在不同的组中。<code>ansible</code>默认有以下<code>2</code>个组：</p>
<ul>
<li><code>all</code>: 所有被管理的主机</li>
<li><code>ungrouped</code>: 未分组的主机</li>
</ul>
<br>
<div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">all:</span>
</span></span><span class="line"><span class="cl">  <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">    <span class="err">mail.example.com:</span>
</span></span><span class="line"><span class="cl">  <span class="err">children:</span>
</span></span><span class="line"><span class="cl">    <span class="err">webservers:</span>
</span></span><span class="line"><span class="cl">      <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">        <span class="err">foo.example.com:</span>
</span></span><span class="line"><span class="cl">        <span class="err">bar.example.com:</span>
</span></span><span class="line"><span class="cl">    <span class="err">dbservers:</span>
</span></span><span class="line"><span class="cl">      <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">        <span class="err">one.example.com:</span>
</span></span><span class="line"><span class="cl">        <span class="err">two.example.com:</span>
</span></span><span class="line"><span class="cl">        <span class="err">three.example.com:</span>
</span></span><span class="line"><span class="cl">    <span class="err">east:</span>
</span></span><span class="line"><span class="cl">      <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">        <span class="err">foo.example.com:</span>
</span></span><span class="line"><span class="cl">        <span class="err">one.example.com:</span>
</span></span><span class="line"><span class="cl">        <span class="err">two.example.com:</span>
</span></span><span class="line"><span class="cl">    <span class="err">west:</span>
</span></span><span class="line"><span class="cl">      <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">        <span class="err">bar.example.com:</span>
</span></span><span class="line"><span class="cl">        <span class="err">three.example.com:</span>
</span></span><span class="line"><span class="cl">    <span class="err">prod:</span>
</span></span><span class="line"><span class="cl">      <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">        <span class="err">foo.example.com:</span>
</span></span><span class="line"><span class="cl">        <span class="err">one.example.com:</span>
</span></span><span class="line"><span class="cl">        <span class="err">two.example.com:</span>
</span></span><span class="line"><span class="cl">    <span class="err">test:</span>
</span></span><span class="line"><span class="cl">      <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">        <span class="err">bar.example.com:</span>
</span></span><span class="line"><span class="cl">        <span class="err">three.example.com:</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="组嵌套" class="heading-element">
  <a href="#%e7%bb%84%e5%b5%8c%e5%a5%97" class="heading-mark"></a>组嵌套</h2><p>组可以嵌套，</p>
<ul>
<li><code>ini</code> 格式：使用<code>:children</code>做为后缀</li>
<li><code>json</code> 格式：使用<code>children:</code>字段</li>
</ul>
<br>
<p>以下是 <code>json</code> 示例</p>
<div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">all:</span>
</span></span><span class="line"><span class="cl">  <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">    <span class="err">mail.example.com:</span>
</span></span><span class="line"><span class="cl">  <span class="err">children:</span>
</span></span><span class="line"><span class="cl">    <span class="err">webservers:</span>
</span></span><span class="line"><span class="cl">      <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">        <span class="err">foo.example.com:</span>
</span></span><span class="line"><span class="cl">        <span class="err">bar.example.com:</span>
</span></span><span class="line"><span class="cl">    <span class="err">dbservers:</span>
</span></span><span class="line"><span class="cl">      <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">        <span class="err">one.example.com:</span>
</span></span><span class="line"><span class="cl">        <span class="err">two.example.com:</span>
</span></span><span class="line"><span class="cl">        <span class="err">three.example.com:</span>
</span></span><span class="line"><span class="cl">    <span class="err">east:</span>
</span></span><span class="line"><span class="cl">      <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">        <span class="err">foo.example.com:</span>
</span></span><span class="line"><span class="cl">        <span class="err">one.example.com:</span>
</span></span><span class="line"><span class="cl">        <span class="err">two.example.com:</span>
</span></span><span class="line"><span class="cl">    <span class="err">west:</span>
</span></span><span class="line"><span class="cl">      <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">        <span class="err">bar.example.com:</span>
</span></span><span class="line"><span class="cl">        <span class="err">three.example.com:</span>
</span></span><span class="line"><span class="cl">    <span class="err">prod:</span>
</span></span><span class="line"><span class="cl">      <span class="err">children:</span>
</span></span><span class="line"><span class="cl">        <span class="err">east:</span>
</span></span><span class="line"><span class="cl">    <span class="err">test:</span>
</span></span><span class="line"><span class="cl">      <span class="err">children:</span>
</span></span><span class="line"><span class="cl">        <span class="err">west:</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="主机范围" class="heading-element">
  <a href="#%e4%b8%bb%e6%9c%ba%e8%8c%83%e5%9b%b4" class="heading-mark"></a>主机范围</h2><p>当主机名是连续的序列(连续的数字或字母)或步长(只限数字)时可以指定范围减少清单文件</p>
<div class="highlight" id="id-6"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[webserverso]</span>
</span></span><span class="line"><span class="cl"><span class="na">www[01:50].example.com</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[webservers1]</span>
</span></span><span class="line"><span class="cl"><span class="na">www[01:50:2].example.com</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[databases]</span>
</span></span><span class="line"><span class="cl"><span class="na">db-[a:f].example.com</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-7"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">...</span>
</span></span><span class="line"><span class="cl">  <span class="err">webservers</span><span class="mi">0</span><span class="err">:</span>
</span></span><span class="line"><span class="cl">    <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">      <span class="err">www</span><span class="p">[</span><span class="mi">01</span><span class="err">:</span><span class="mi">50</span><span class="p">]</span><span class="err">.example.com:</span>
</span></span><span class="line"><span class="cl"><span class="err">...</span>
</span></span><span class="line"><span class="cl">  <span class="err">webservers</span><span class="mi">1</span><span class="err">:</span>
</span></span><span class="line"><span class="cl">    <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">      <span class="err">www</span><span class="p">[</span><span class="mi">01</span><span class="err">:</span><span class="mi">50</span><span class="err">:</span><span class="mi">2</span><span class="p">]</span><span class="err">.example.com:</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="主机变量" class="heading-element">
  <a href="#%e4%b8%bb%e6%9c%ba%e5%8f%98%e9%87%8f" class="heading-mark"></a>主机变量</h2><p>在主机名后面可以添加自定义变量，多个变量以空格分隔</p>
<div class="highlight" id="id-8"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[atlanta]</span>
</span></span><span class="line"><span class="cl"><span class="na">host1 http_port</span><span class="o">=</span><span class="s">80 maxRequestsPerChild=808</span>
</span></span><span class="line"><span class="cl"><span class="na">host2 http_port</span><span class="o">=</span><span class="s">303 maxRequestsPerChild=909</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-9"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">atlanta:</span>
</span></span><span class="line"><span class="cl">  <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">    <span class="err">host</span><span class="mi">1</span><span class="err">:</span>
</span></span><span class="line"><span class="cl">      <span class="err">http_port:</span> <span class="mi">80</span>
</span></span><span class="line"><span class="cl">      <span class="err">maxRequestsPerChild:</span> <span class="mi">808</span>
</span></span><span class="line"><span class="cl">    <span class="err">host</span><span class="mi">2</span><span class="err">:</span>
</span></span><span class="line"><span class="cl">      <span class="err">http_port:</span> <span class="mi">303</span>
</span></span><span class="line"><span class="cl">      <span class="err">maxRequestsPerChild:</span> <span class="mi">909</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>ini</code> 格式中远程端口可以写在主机名后</p>
<div class="highlight" id="id-10"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">badwolf.example.com:5309</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="清单目录" class="heading-element">
  <a href="#%e6%b8%85%e5%8d%95%e7%9b%ae%e5%bd%95" class="heading-mark"></a>清单目录</h2><p>可以定义多个清单文件，使用多个 <code>-i</code> 选项引用它们。也可以把多个文件放入单独的目录中，使用 <code>-i</code> 选项引用该目录。<code>Ansible</code> 根据文件名以 <code>ASCII</code> 顺序加载清单源。如果您在一个文件或目录中定义父组，在其他文件或目录中定义子组，则必须首先加载定义子组的文件，否则报错 <code>Unable to parse /path/to/source_of_parent_groups as an inventory source</code></p>
<div class="highlight" id="id-11"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">inventory/
</span></span><span class="line"><span class="cl">  openstack.yml          <span class="c1"># configure inventory plugin to get hosts from OpenStack cloud</span>
</span></span><span class="line"><span class="cl">  dynamic-inventory.py   <span class="c1"># add additional hosts with dynamic inventory script</span>
</span></span><span class="line"><span class="cl">  on-prem                <span class="c1"># add static hosts and groups</span>
</span></span><span class="line"><span class="cl">  parent-groups          <span class="c1"># add static hosts and groups</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="变量组" class="heading-element">
  <a href="#%e5%8f%98%e9%87%8f%e7%bb%84" class="heading-mark"></a>变量组</h2><p>一个组以及嵌套组可以共享一些变量</p>
<div class="highlight" id="id-12"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[atlanta]</span>
</span></span><span class="line"><span class="cl"><span class="na">host1</span>
</span></span><span class="line"><span class="cl"><span class="na">host2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[atlanta:vars]</span>
</span></span><span class="line"><span class="cl"><span class="na">ntp_server</span><span class="o">=</span><span class="s">ntp.atlanta.example.com</span>
</span></span><span class="line"><span class="cl"><span class="na">proxy</span><span class="o">=</span><span class="s">proxy.atlanta.example.com</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-13"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">atlanta:</span>
</span></span><span class="line"><span class="cl">  <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">    <span class="err">host</span><span class="mi">1</span><span class="err">:</span>
</span></span><span class="line"><span class="cl">    <span class="err">host</span><span class="mi">2</span><span class="err">:</span>
</span></span><span class="line"><span class="cl">  <span class="err">vars:</span>
</span></span><span class="line"><span class="cl">    <span class="err">ntp_server:</span> <span class="err">ntp.atlanta.example.com</span>
</span></span><span class="line"><span class="cl">    <span class="err">proxy:</span> <span class="err">proxy.atlanta.example.com</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="变量组嵌套" class="heading-element">
  <a href="#%e5%8f%98%e9%87%8f%e7%bb%84%e5%b5%8c%e5%a5%97" class="heading-mark"></a>变量组嵌套</h2><p>变量组可以进行嵌套，子变量优先级高于父变量</p>
<ul>
<li><code>ini</code> 格式以 <code>:vars</code> 结尾</li>
<li><code>json</code> 格式用 <code>vars:</code> 字段</li>
</ul>
<br>
<div class="highlight" id="id-14"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[atlanta]</span>
</span></span><span class="line"><span class="cl"><span class="na">host1</span>
</span></span><span class="line"><span class="cl"><span class="na">host2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[raleigh]</span>
</span></span><span class="line"><span class="cl"><span class="na">host2</span>
</span></span><span class="line"><span class="cl"><span class="na">host3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[southeast:children]</span>
</span></span><span class="line"><span class="cl"><span class="na">atlanta</span>
</span></span><span class="line"><span class="cl"><span class="na">raleigh</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[southeast:vars]</span>
</span></span><span class="line"><span class="cl"><span class="na">some_server</span><span class="o">=</span><span class="s">foo.southeast.example.com</span>
</span></span><span class="line"><span class="cl"><span class="na">halon_system_timeout</span><span class="o">=</span><span class="s">30</span>
</span></span><span class="line"><span class="cl"><span class="na">self_destruct_countdown</span><span class="o">=</span><span class="s">60</span>
</span></span><span class="line"><span class="cl"><span class="na">escape_pods</span><span class="o">=</span><span class="s">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[usa:children]</span>
</span></span><span class="line"><span class="cl"><span class="na">southeast</span>
</span></span><span class="line"><span class="cl"><span class="na">northeast</span>
</span></span><span class="line"><span class="cl"><span class="na">southwest</span>
</span></span><span class="line"><span class="cl"><span class="na">northwest</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-15"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">all:</span>
</span></span><span class="line"><span class="cl">  <span class="err">children:</span>
</span></span><span class="line"><span class="cl">    <span class="err">usa:</span>
</span></span><span class="line"><span class="cl">      <span class="err">children:</span>
</span></span><span class="line"><span class="cl">        <span class="err">southeast:</span>
</span></span><span class="line"><span class="cl">          <span class="err">children:</span>
</span></span><span class="line"><span class="cl">            <span class="err">atlanta:</span>
</span></span><span class="line"><span class="cl">              <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">                <span class="err">host</span><span class="mi">1</span><span class="err">:</span>
</span></span><span class="line"><span class="cl">                <span class="err">host</span><span class="mi">2</span><span class="err">:</span>
</span></span><span class="line"><span class="cl">            <span class="err">raleigh:</span>
</span></span><span class="line"><span class="cl">              <span class="err">hosts:</span>
</span></span><span class="line"><span class="cl">                <span class="err">host</span><span class="mi">2</span><span class="err">:</span>
</span></span><span class="line"><span class="cl">                <span class="err">host</span><span class="mi">3</span><span class="err">:</span>
</span></span><span class="line"><span class="cl">          <span class="err">vars:</span>
</span></span><span class="line"><span class="cl">            <span class="err">some_server:</span> <span class="err">foo.southeast.example.com</span>
</span></span><span class="line"><span class="cl">            <span class="err">halon_system_timeout:</span> <span class="mi">30</span>
</span></span><span class="line"><span class="cl">            <span class="err">self_destruct_countdown:</span> <span class="mi">60</span>
</span></span><span class="line"><span class="cl">            <span class="err">escape_pods:</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="err">northeast:</span>
</span></span><span class="line"><span class="cl">        <span class="err">northwest:</span>
</span></span><span class="line"><span class="cl">        <span class="err">southwest:</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="自定义变量文件" class="heading-element">
  <a href="#%e8%87%aa%e5%ae%9a%e4%b9%89%e5%8f%98%e9%87%8f%e6%96%87%e4%bb%b6" class="heading-mark"></a>自定义变量文件</h2><p>可以把变量放在单独的<code>yaml</code>文件或目录中</p>
<div class="highlight" id="id-16"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/etc/ansible/group_vars/raleigh <span class="c1"># can optionally end in &#39;.yml&#39;, &#39;.yaml&#39;, or &#39;.json&#39;</span>
</span></span><span class="line"><span class="cl">/etc/ansible/group_vars/webservers
</span></span><span class="line"><span class="cl">/etc/ansible/host_vars/foosball</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="变量" class="heading-element">
  <a href="#%e5%8f%98%e9%87%8f" class="heading-mark"></a>变量</h1><p><code>Ansible</code> 预使用了一些变量</p>
<h2 id="连接到主机相关变量" class="heading-element">
  <a href="#%e8%bf%9e%e6%8e%a5%e5%88%b0%e4%b8%bb%e6%9c%ba%e7%9b%b8%e5%85%b3%e5%8f%98%e9%87%8f" class="heading-mark"></a>连接到主机相关变量</h2><p>设置以下变量控制 <code>Ansible</code> 如何与远程主机交互(<code>ssh</code>方式)：</p>
<ul>
<li><code>ansible_connection</code>: 到主机的连接类型。这可以是任何 <code>ansible</code> 连接插件的名称。</li>
<li><code>ansible_host</code>: 要连接的主机的名称</li>
<li><code>ansible_port</code>: 要连接的主机的远程端口号，缺省为 <code>22</code></li>
<li><code>ansible_user</code>: 要连接的主机的用户名</li>
<li><code>ansible_password</code>: 连接到主机时使用的用户名的密码</li>
<li><code>ansible_ssh_private_key_file</code>: <code>ssh</code> 使用的私钥文件，默认为 <code>~/.ssh/</code></li>
<li><code>ansible_ssh_common_args</code>: 连接后默认执行的命令行</li>
<li><code>ansible_sftp_extra_args</code>: 连接后默认执行的命令行(<code>sftp</code>)</li>
<li><code>ansible_scp_extra_args</code>: 连接后默认执行的命令行(<code>scp</code>)</li>
<li><code>ansible_ssh_extra_args</code>: 连接后默认执行的命令行(<code>ssh</code>)</li>
<li><code>ansible_ssh_pipelining</code>: 是否使用 <code>SSH</code> 流水线，会覆盖配置文件中 <code>pipelining</code> 选项值。(在 <code>2.2</code> 版本中加入)</li>
<li><code>ansible_become</code>: 是否允许使用 <code>su</code> 或 <code>sudo</code> 命令</li>
<li><code>ansible_sudo</code>: 是否允许使用 <code>sudu</code> 命令</li>
<li><code>ansible_su</code>: 是否允许使用 <code>su</code> 命令</li>
<li><code>ansible_become_method</code>: 允许设置权限升级方法</li>
<li><code>ansible_become_user</code>: 允许设置你通过权限升级成为的用户</li>
<li><code>ansible_sudo_user</code>: 允许使用 <code>sudo</code> 命令提权的用户</li>
<li><code>ansible_su_user</code>: 允许使用 <code>su</code> 命令提权的用户</li>
<li><code>ansible_become_password</code>: 提权使用到的密码</li>
<li><code>ansible_sudo_password</code>: 使用 <code>sudo</code> 命令用到的密码</li>
<li><code>ansible_su_password</code>: 使用 <code>su</code> 命令用到的密码</li>
<li><code>ansible_become_exe</code>: 使用 <code>su</code> 或 <code>sudo</code> 命令提权后允许执行的可执行文件</li>
<li><code>ansible_sudo_exe</code>: 使用 <code>sudo</code> 命令提权后允许执行的可执行文件</li>
<li><code>ansible_su_exe</code>:  使用 <code>su</code> 命令提权后允许执行的可执行文件</li>
<li><code>ansible_become_flags</code>: 使用 <code>sudo</code> 命令或 <code>su</code> 命令的参数，覆盖配置文件中 <code>sudo_flags</code> 选项值</li>
<li><code>ansible_sudo_flags</code>:  使用 <code>sudo</code> 命令命令的参数</li>
<li><code>ansible_su_flags</code>: 使用 <code>su</code> 命令的参数</li>
<li><code>ansible_shell_type</code>: 目标系统内核外壳类型，默认情况下，命令使用 <code>-style</code> 语法进行格式化<code>sh</code></li>
<li><code>ansible_python_interpreter</code>: 目标主机 <code>python</code> 路径，默认为 <code>/usr/bin/python*</code></li>
<li><code>ansible_*_interpreter</code>:</li>
<li><code>ansible_shell_executable</code>: 目标主机<code>shell</code> 路径，默认为 <code>/bin/sh</code>。覆盖配置文件中 <code>executable</code> 选项值</li>
</ul>
<h1 id="连接方式" class="heading-element">
  <a href="#%e8%bf%9e%e6%8e%a5%e6%96%b9%e5%bc%8f" class="heading-mark"></a>连接方式</h1><p>默认情况下，<code>Ansible</code> 使用本机 <code>OpenSSH</code>，因为它支持 <code>ControlPersist</code>（一种性能特性）、<code>Kerberos</code> 和<code>~/.ssh/configJump Host</code> 设置等选项。如果控制机器使用不支持 <code>ControlPersist</code> 的旧版本 <code>OpenSSH</code>，<code>Ansible</code> 将回退到名为<code>paramiko</code>的 <code>OpenSSH Python</code> 实现。除了 <code>ssh</code> 方式 <code>Ansible</code> 还支持本地连接 <code>localhost</code> 与 <code>docker</code> 连接。使用 <code>ansible_connection</code> 配置项目指定。更多相关 <code>ssh</code> 连接设置查看 <a href="https://docs.ansible.com/ansible/7/collections/ansible/builtin/ssh_connection.html"target="_blank" rel="external nofollow noopener noreferrer">ansible.builtin.ssh</a></p>
<h2 id="ssh-相关配置" class="heading-element">
  <a href="#ssh-%e7%9b%b8%e5%85%b3%e9%85%8d%e7%bd%ae" class="heading-mark"></a>ssh 相关配置</h2><p>默认情况下会检查密钥文件，当<code>known_hosts</code>文件中有同个主机有多个密钥时会报错，当没有主机连接记录时会要手动确认。如果想关闭该功能要修改 <code>ANSIBLE_HOST_KEY_CHECKING</code> 环境变量或配置文件中的 <code>host_key_checking</code> 配置项值为 <code>False</code></p>
<h1 id="playbooks" class="heading-element">
  <a href="#playbooks" class="heading-mark"></a>Playbooks</h1><p><code>Ansible Playbooks</code> 提供了一种可重复、可重用、简单的配置管理和多机部署系统，非常适合部署复杂的应用程序。它使用 <code>yaml</code> 文档声明执行方式</p>
<div class="highlight" id="id-17"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Update web servers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">webservers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">remote_user</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Ensure apache is at the latest version</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">httpd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Write the apache config file</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ansible.builtin.template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l">/srv/httpd.j2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/httpd.conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Update db servers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">databases</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">remote_user</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Ensure postgresql is at the latest version</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">postgresql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Ensure that postgresql is started</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ansible.builtin.service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">postgresql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">started</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>name</code>: 该字段指定说明信息，会输出到标准输出</li>
<li><code>hosts</code>: 该字段指定被操作的主机，可以是主机名、主机组（清单文件中定义）</li>
<li><code>remote_user</code>: 该字段指定远程用户</li>
<li><code>tasks</code>: 执行的任务列表。默认情况下，<code>Ansible</code> 针对与主机模式匹配的所有机器按顺序执行每个任务，一次一个。每个任务执行一个带有特定参数的模块。当一个任务在所有目标机器上执行完毕后，<code>Ansible</code> 会继续执行下一个任务</li>
<li><code>tasks.name</code>: 说明信息，会输出到标准输出</li>
<li><code>tasks.ansible.*</code>: 调用模块执行的操作。模块会检查是否已达到所需的最终状态，如果已达到该状态，则退出而不执行任何操作，大多数的模块具有幂等性（无论运行 <code>playbook</code> 一次还是多次，结果都应该是相同的）。但并非所有剧本和模块都以这种方式运行</li>
</ul>
<h2 id="任务状态" class="heading-element">
  <a href="#%e4%bb%bb%e5%8a%a1%e7%8a%b6%e6%80%81" class="heading-mark"></a>任务状态</h2><h3 id="重置-failed-条件" class="heading-element">
  <a href="#%e9%87%8d%e7%bd%ae-failed-%e6%9d%a1%e4%bb%b6" class="heading-mark"></a>重置 failed 条件</h3><p><a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_error_handling.html#defining-failure"target="_blank" rel="external nofollow noopener noreferrer">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_error_handling.html#defining-failure</a></p>
<h3 id="重置-changed-条件" class="heading-element">
  <a href="#%e9%87%8d%e7%bd%ae-changed-%e6%9d%a1%e4%bb%b6" class="heading-mark"></a>重置 changed 条件</h3><p><a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_error_handling.html#defining-changed"target="_blank" rel="external nofollow noopener noreferrer">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_error_handling.html#defining-changed</a></p>
<h2 id="过滤器" class="heading-element">
  <a href="#%e8%bf%87%e6%bb%a4%e5%99%a8" class="heading-mark"></a>过滤器</h2><p><code>Ansible</code> 使用 <a href="https://jinja.palletsprojects.com/en/latest/templates/"target="_blank" rel="external nofollow noopener noreferrer">Jinja2</a> 模板来启用动态表达式以及对变量和事实的访问。在目标机器上发送和执行任务之前，所有模板都发生在 <code>Ansible</code> 控制器上。这种方法最大限度地减少了对目标的包要求（<code>jinja2</code> 仅在控制器上需要）。它还限制了 <code>Ansible</code> 传递给目标机器的数据量。<code>Ansible</code> 在控制器上解析模板，只将每个任务需要的信息传递给目标机器，而不是将所有数据都传递到控制器上，然后在目标机器上解析。</p>
<p><code>Ansible</code> 使用 <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/template_module.html"target="_blank" rel="external nofollow noopener noreferrer">ansible.builtin.template</a> 将文件模板化到目标主机。它使用的文件和数据必须是 <code>utf-8</code> 编码的</p>
<h2 id="过滤数据处理数据" class="heading-element">
  <a href="#%e8%bf%87%e6%bb%a4%e6%95%b0%e6%8d%ae%e5%a4%84%e7%90%86%e6%95%b0%e6%8d%ae" class="heading-mark"></a>过滤数据处理数据</h2><p>过滤器可让您将 <code>JSON</code> 数据转换为 <code>YAML</code> 数据、拆分 <code>URL</code> 以提取主机名、获取字符串的 <code>SHA1</code> 哈希值、添加或乘以整数等等。有以下过滤器：</p>
<ul>
<li><code>Ansible</code> 过滤器</li>
<li><code>Jinja2</code> 过滤器</li>
<li><a href="https://jinja.palletsprojects.com/en/3.1.x/templates/#python-methods"target="_blank" rel="external nofollow noopener noreferrer">python 方法转换数据</a></li>
</ul>
<h3 id="处理未定义变量" class="heading-element">
  <a href="#%e5%a4%84%e7%90%86%e6%9c%aa%e5%ae%9a%e4%b9%89%e5%8f%98%e9%87%8f" class="heading-mark"></a>处理未定义变量</h3><p>在 <code>playbook</code> 中可以使用 <code>{{  }}</code> 引用变量，如果引用的变量不存在则会报错，可以通过忽略变量、提供默认值、使变量可选项等方式处理</p>
<p><code>default()</code> 函数可以为变量提供一个默认值，如下面示例，当 <code>some_variable</code> 变量不存在时其值为 <code>5</code></p>
<div class="highlight" id="id-18"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">{{<span class="w"> </span><span class="l">some_variable | default(5) }}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>从 <code>2.8</code> 开始还可以同时设置多少默认值，如</p>
<div class="highlight" id="id-19"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">{{<span class="w"> </span><span class="l">lookup(&#39;env&#39;, &#39;MY_USER&#39;) | default(&#39;admin&#39;, true) }}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>default()</code> 值为 <code>omit</code> 时可以将特定变量设为可选的。如下面示例创建文件指定其<code>mask</code>值</p>
<div class="highlight" id="id-20"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Touch files with an optional mode</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.file</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.path }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">touch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.mode | default(omit) }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp/foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp/bar</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp/baz</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0444&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如果已经配置忽略未定义的变量的情况下，要强制必须有某些变量能可以使用 <code>mandatory</code> 关键字强制报错</p>
<div class="highlight" id="id-21"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">{{<span class="w"> </span><span class="l">variable | mandatory }}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>undef</code> 关键字可以重写变量</p>
<div class="highlight" id="id-22"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">galaxy_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://galaxy.ansible.com&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">galaxy_api_key</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ undef(hint=&#39;You must specify your Galaxy API key&#39;) }}&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="为-truefalsenull-定义不同的值" class="heading-element">
  <a href="#%e4%b8%ba-truefalsenull-%e5%ae%9a%e4%b9%89%e4%b8%8d%e5%90%8c%e7%9a%84%e5%80%bc" class="heading-mark"></a>为 true/false/null 定义不同的值</h3><p>在 <code>1.9</code> 版本中加入的新功能，创建一个测试，然后定义一个值在测试返回 <code>true</code> 时使用，在测试返回 <code>false</code> 时使用另一个值</p>
<div class="highlight" id="id-23"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span><span class="err">{</span> <span class="err">(status</span> <span class="err">==</span> <span class="err">&#39;needs_restart&#39;)</span> <span class="err">|</span> <span class="err">ternary(&#39;restart&#39;,</span> <span class="err">&#39;continue&#39;)</span> <span class="p">}</span><span class="err">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>2.8</code> 版本中增强了该功能，可以定义一个值用于 <code>true</code>，一个值用于 <code>false</code>，第三个值用于 <code>null</code></p>
<div class="highlight" id="id-24"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span><span class="err">{</span> <span class="err">enabled</span> <span class="err">|</span> <span class="err">ternary(&#39;no</span> <span class="err">shutdown&#39;,</span> <span class="err">&#39;shutdown&#39;,</span> <span class="err">omit)</span> <span class="p">}</span><span class="err">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="查看数据类型" class="heading-element">
  <a href="#%e6%9f%a5%e7%9c%8b%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b" class="heading-mark"></a>查看数据类型</h3><p><code>type_debug</code> 关键字可以查看变量的底层 <code>python</code> 数据类型</p>
<div class="highlight" id="id-25"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span><span class="err">{</span> <span class="err">myvar</span> <span class="err">|</span> <span class="err">type_debug</span> <span class="p">}</span><span class="err">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="将字典转换为列表" class="heading-element">
  <a href="#%e5%b0%86%e5%ad%97%e5%85%b8%e8%bd%ac%e6%8d%a2%e4%b8%ba%e5%88%97%e8%a1%a8" class="heading-mark"></a>将字典转换为列表</h3><p><code>dict2items</code> 关键字可以将字典转换为适合列表</p>
<div class="highlight" id="id-26"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span><span class="err">{</span> <span class="err">dict</span> <span class="err">|</span> <span class="err">dict2items</span> <span class="p">}</span><span class="err">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>2.8</code> 版本中增强了该功能。可以指定键值对</p>
<div class="highlight" id="id-27"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span><span class="err">{</span> <span class="err">files</span> <span class="err">|</span> <span class="err">dict2items(key_name=&#39;file&#39;,</span> <span class="err">value_name=&#39;path&#39;)</span> <span class="p">}</span><span class="err">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="将列表转换为字典" class="heading-element">
  <a href="#%e5%b0%86%e5%88%97%e8%a1%a8%e8%bd%ac%e6%8d%a2%e4%b8%ba%e5%ad%97%e5%85%b8" class="heading-mark"></a>将列表转换为字典</h3><p>在 <code>2.7</code> 版本开始可以使用<code>items2dict</code>过滤器将列表转换为字典，将内容映射成键值对</p>
<div class="highlight" id="id-28"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span><span class="err">{</span> <span class="err">tags</span> <span class="err">|</span> <span class="err">items2dict</span> <span class="p">}</span><span class="err">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>也可以指定键值对，但并非所有列表都使用<code>key</code>做为键，<code>value</code>做为值</p>
<div class="highlight" id="id-29"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">fruits:</span>
</span></span><span class="line"><span class="cl">  <span class="err">-</span> <span class="err">fruit:</span> <span class="err">apple</span>
</span></span><span class="line"><span class="cl">    <span class="err">color:</span> <span class="err">red</span>
</span></span><span class="line"><span class="cl">  <span class="err">-</span> <span class="err">fruit:</span> <span class="err">pear</span>
</span></span><span class="line"><span class="cl">    <span class="err">color:</span> <span class="err">yellow</span>
</span></span><span class="line"><span class="cl">  <span class="err">-</span> <span class="err">fruit:</span> <span class="err">grapefruit</span>
</span></span><span class="line"><span class="cl">    <span class="err">color:</span> <span class="err">yellow</span></span></span></code></pre></td></tr></table>
</div>
</div><p>上面的列表必须指定键值对，否则会报错：<code>KeyError: keyKey, Error: my_typo</code></p>
<div class="highlight" id="id-30"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span><span class="err">{</span> <span class="err">tags</span> <span class="err">|</span> <span class="err">items2dict(key_name=&#39;fruit&#39;,</span> <span class="err">value_name=&#39;color&#39;)</span> <span class="p">}</span><span class="err">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="强制数据类型" class="heading-element">
  <a href="#%e5%bc%ba%e5%88%b6%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b" class="heading-mark"></a>强制数据类型</h3><p>从 <code>1.6</code> 版本开始可以将值转换为特定类型</p>
<div class="highlight" id="id-31"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 将其识别为布尔值而不是字符串</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">some_string_value | bool</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-32"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 将它识别为一个整数而不是一个字符串</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">echo &#34;only on Red Hat 6, derivatives, and later&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">ansible_facts[&#39;os_family&#39;] == &#34;RedHat&#34; and ansible_facts[&#39;lsb&#39;][&#39;major_release&#39;] | int &gt;= 6</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="判断数据" class="heading-element">
  <a href="#%e5%88%a4%e6%96%ad%e6%95%b0%e6%8d%ae" class="heading-mark"></a>判断数据</h2><p>从 <code>Ansible 2.5</code> 开始，使用 <code>jinja</code> 测试作为过滤器将生成弃用警告。从 <code>Ansible 2.9+</code> 开始，需要使用 <code>jinja</code> 测试语法。语法如下</p>
<div class="highlight" id="id-33"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">variable is test_name</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="比较字符串" class="heading-element">
  <a href="#%e6%af%94%e8%be%83%e5%ad%97%e7%ac%a6%e4%b8%b2" class="heading-mark"></a>比较字符串</h3><p>将字符串与子字符串或正则表达式进行匹配可以使用以下关键字：</p>
<ul>
<li><code>match</code>: 从字符串开头匹配</li>
<li><code>search</code>: 匹配部分字符串</li>
<li><code>regex</code>: 使用正则表达式匹配
<br></li>
</ul>
<p>以上所有的字符串测试也采用可选的<code>ignorecase</code>和<code>multiline</code>参数</p>
<div class="highlight" id="id-34"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://example.com/users/foo/resources/bar&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;matched pattern 1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">url is match(&#34;https://example.com/users/.*/resources&#34;)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;matched pattern 2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">url is search(&#34;users/.*/resources/.*&#34;)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;matched pattern 3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">url is search(&#34;users&#34;)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;matched pattern 4&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">url is regex(&#34;example\.com/\w+/foo&#34;)</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="判断是否加密" class="heading-element">
  <a href="#%e5%88%a4%e6%96%ad%e6%98%af%e5%90%a6%e5%8a%a0%e5%af%86" class="heading-mark"></a>判断是否加密</h3><p>从 <code>2.10</code> 开始可以使用<code>vault_encrypted</code>关键字测试值是否加密</p>
<div class="highlight" id="id-35"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">variable</span><span class="p">:</span><span class="w"> </span>!<span class="l">vault |</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">$ANSIBLE_VAULT;1.2;AES256;dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="m">61323931353866666336306139373937316366366138656131323863373866376666353364373761</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">3539633234313836346435323766306164626134376564330a373530313635343535343133316133</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="m">36643666306434616266376434363239346433643238336464643566386135356334303736353136</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">6565633133366366360a326566323363363936613664616364623437336130623133343530333739</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="m">3039</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;{{ (variable is vault_encrypted) | ternary(&#34;Vault encrypted&#34;, &#34;Not vault encrypted&#34;) }}&#39;</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="truthy-and-falsy" class="heading-element">
  <a href="#truthy-and-falsy" class="heading-mark"></a>truthy and falsy</h3><p>从 <code>Ansible 2.10</code> 开始，您现在可以像 <code>Python</code> 一样执行 <code>truthy</code> 和 <code>falsy</code> 检查，这两个关键字可以加 <code>convert_bool</code> 参数尝试转换为布尔值</p>
<div class="highlight" id="id-36"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Truthy&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">value is truthy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;some string&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Falsy&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">value is falsy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Truthy&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">value is truthy(convert_bool=True)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;yes&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Falsy&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">value is falsy(convert_bool=True)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;off&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="版本号比较" class="heading-element">
  <a href="#%e7%89%88%e6%9c%ac%e5%8f%b7%e6%af%94%e8%be%83" class="heading-mark"></a>版本号比较</h3><p>从<code>1.6</code> 版本开始可使用 <code>version_compare</code> 函数对比数值，到 <code>2.5</code> 版本改名为 <code>version</code>。它的第一个参数为数值，第二个参数为运算符，第三个参数为<code>strict</code>或<code>version_type</code>。</p>
<div class="highlight" id="id-37"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">my_version</span><span class="p">:</span><span class="w"> </span><span class="m">1.2.3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;my_version is higher than 1.0.0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">my_version is version(&#39;1.0.0&#39;, &#39;&gt;&#39;)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如下示例。如果<code>ansible_facts['distribution_version']</code>大于或等于 <code>12.04</code>，则此测试返回 <code>True</code>，否则返回 <code>False</code></p>
<div class="highlight" id="id-38"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">{{<span class="w"> </span><span class="l">ansible_facts[&#39;distribution_version&#39;] is version(&#39;12.04&#39;, &#39;&gt;=&#39;) }}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>version</code> 函数可接受以下运算符</p>
<div class="highlight" id="id-39"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">&lt;, lt, &lt;=, le, &gt;, gt, &gt;=, ge, ==, =, eq, !=, &lt;&gt;, ne</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>strict</code> 参数值为 <code>True</code>(启用严格匹配) 或 <code>False</code>(宽松匹配，也是默认值)</p>
<div class="highlight" id="id-40"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">{{<span class="w"> </span><span class="l">sample_version_var is version(&#39;1.0&#39;, operator=&#39;lt&#39;, strict=True) }}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>从 <code>Ansible 2.11</code> 开始，<code>version</code> 函数接受一个 <code>version_type</code> 参数，该参数不能同时与 <code>strict</code> 参数使用。<code>version_type</code> 参数有以下值：</p>
<ul>
<li><code>loose</code>: 宽松匹配</li>
<li><code>strict</code>: 版本号由两个或三个点分隔的数字部分组成，末尾有一个可选的<code>[a|b][0-9]</code>标签</li>
<li><code>semver</code>/<code>semantic</code>: 版本比较</li>
<li><code>pep440</code>: <code> 2.14</code> 版本本添加的，实现<code>Python PEP-440</code>版本控制规则对比
<br></li>
</ul>
<div class="highlight" id="id-41"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">{{<span class="w"> </span><span class="l">sample_semver_var is version(&#39;2.0.0-rc.1+build.123&#39;, &#39;lt&#39;, version_type=&#39;semver&#39;) }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>{{<span class="w"> </span><span class="s1">&#39;2.14.0rc1&#39;</span><span class="w"> </span><span class="l">is version(&#39;2.14.0&#39;, &#39;lt&#39;, version_type=&#39;pep440&#39;) }}</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="集合比较" class="heading-element">
  <a href="#%e9%9b%86%e5%90%88%e6%af%94%e8%be%83" class="heading-mark"></a>集合比较</h3><p>从<code>2.1</code>版本开始可以使用<code>issubset</code>函数(子集)与<code>issuperset</code>函数(超集)判断一个集合是否包含另一个集合。从<code>2.5</code> 版本开始改名为 <code>subset</code> 与 <code>superset</code></p>
<div class="highlight" id="id-42"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">a</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">4</span><span class="p">,</span><span class="m">5</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">b</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;A includes B&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">a is superset(b)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;B is included in A&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">b is subset(a)</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="列表是否包含值" class="heading-element">
  <a href="#%e5%88%97%e8%a1%a8%e6%98%af%e5%90%a6%e5%8c%85%e5%90%ab%e5%80%bc" class="heading-mark"></a>列表是否包含值</h3><p>从<code>2.8</code>版本开始，可以使用<code>contains</code>函数判断列表中是否含有某个值。通常与<code>select</code>、<code>reject</code>、<code>selectattr</code>和<code>rejectattr</code>函数一起使用</p>
<div class="highlight" id="id-43"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">lacp_groups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">master</span><span class="p">:</span><span class="w"> </span><span class="l">lacp0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">network</span><span class="p">:</span><span class="w"> </span><span class="m">10.65.100.0</span><span class="l">/24</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">gateway</span><span class="p">:</span><span class="w"> </span><span class="m">10.65.100.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dns4</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="m">10.65.100.10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="m">10.65.100.11</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">interfaces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">em1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">em2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">master</span><span class="p">:</span><span class="w"> </span><span class="l">lacp1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">network</span><span class="p">:</span><span class="w"> </span><span class="m">10.65.120.0</span><span class="l">/24</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">gateway</span><span class="p">:</span><span class="w"> </span><span class="m">10.65.120.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dns4</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="m">10.65.100.10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="m">10.65.100.11</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">interfaces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="l">em3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="l">em4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">## 判断 interfaces 列表是否含有 em1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ (lacp_groups|selectattr(&#39;interfaces&#39;, &#39;contains&#39;, &#39;em1&#39;)|first).master }}&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="判断列表值是否为-true" class="heading-element">
  <a href="#%e5%88%a4%e6%96%ad%e5%88%97%e8%a1%a8%e5%80%bc%e6%98%af%e5%90%a6%e4%b8%ba-true" class="heading-mark"></a>判断列表值是否为 True</h3><p>从<code>2.4</code>版本可以使用 <code>any</code> 和 <code>all</code> 来检查列表中的任何或所有元素是否为真</p>
<div class="highlight" id="id-44"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mylist</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;{{ 3 == 3 }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="kc">True</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">myotherlist</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="kc">False</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="kc">True</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;all are true!&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">mylist is all</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;at least one is true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">myotherlist is any</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="判断路径" class="heading-element">
  <a href="#%e5%88%a4%e6%96%ad%e8%b7%af%e5%be%84" class="heading-mark"></a>判断路径</h3><div class="highlight" id="id-45"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;path is a directory&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">mypath is directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;path is a file&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">mypath is file</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;path is a symlink&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">mypath is link</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;path already exists&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">mypath is exists</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;path is {{ (mypath is abs)|ternary(&#39;absolute&#39;,&#39;relative&#39;)}}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;path is the same file as path2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">mypath is same_file(path2)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;path is a mount&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">mypath is mount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;path is a directory&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">mypath is directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">mypath</span><span class="p">:</span><span class="w"> </span><span class="l">/my/patth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;path is a file&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#39;/my/path&#39; is file&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="检查任务状态" class="heading-element">
  <a href="#%e6%a3%80%e6%9f%a5%e4%bb%bb%e5%8a%a1%e7%8a%b6%e6%80%81" class="heading-mark"></a>检查任务状态</h3><p>从<code>2.1</code>开始，还可以使用<code>success</code>、<code>failure</code>、<code>change</code>、<code>skip</code>来进行语法匹配</p>
<div class="highlight" id="id-46"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/bin/foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l">result</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ignore_errors</span><span class="p">:</span><span class="w"> </span><span class="kc">True</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;it failed&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">result is failed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># in most cases you&#39;ll want a handler, but if you want to do something right now, this is nice</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;it changed&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">result is changed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;it succeeded in Ansible &gt;= 2.1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">result is succeeded</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;it succeeded&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">result is success</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;it was skipped&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">result is skipped</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="判断类型" class="heading-element">
  <a href="#%e5%88%a4%e6%96%ad%e7%b1%bb%e5%9e%8b" class="heading-mark"></a>判断类型</h3><p><code>type_debug</code> 类型测试比较</p>
<div class="highlight" id="id-47"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;String interpretation&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">a_string</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;A string&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">a_dictionary</span><span class="p">:</span><span class="w"> </span>{<span class="nt">&#34;a&#34;: </span><span class="s2">&#34;dictionary&#34;</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">a_list</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;a&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">assert</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">that</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Note that a string is classed as also being &#34;iterable&#34; and &#34;sequence&#34;, but not &#34;mapping&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">a_string is string and a_string is iterable and a_string is sequence and a_string is not mapping</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Note that a dictionary is classed as not being a &#34;string&#34;, but is &#34;iterable&#34;, &#34;sequence&#34; and &#34;mapping&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">a_dictionary is not string and a_dictionary is iterable and a_dictionary is mapping</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Note that a list is classed as not being a &#34;string&#34; or &#34;mapping&#34; but is &#34;iterable&#34; and &#34;sequence&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">a_list is not string and a_list is not mapping and a_list is iterable</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Number interpretation&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">a_float</span><span class="p">:</span><span class="w"> </span><span class="m">1.01</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">a_float_as_string</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1.01&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">an_integer</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">an_integer_as_string</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">assert</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">that</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Both a_float and an_integer are &#34;number&#34;, but each has their own type as well</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">a_float is number and a_float is float</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">an_integer is number and an_integer is integer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Both a_float_as_string and an_integer_as_string are not numbers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">a_float_as_string is not number and a_float_as_string is string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">an_integer_as_string is not number and a_float_as_string is string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># a_float or a_float_as_string when cast to a float and then to a string should match the same value cast only to a string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">a_float | float | string == a_float | string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">a_float_as_string | float | string == a_float_as_string | string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Likewise an_integer and an_integer_as_string when cast to an integer and then to a string should match the same value cast only to an integer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">an_integer | int | string == an_integer | string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">an_integer_as_string | int | string == an_integer_as_string | string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># However, a_float or a_float_as_string cast as an integer and then a string does not match the same value cast to a string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">a_float | int | string != a_float | string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">a_float_as_string | int | string != a_float_as_string | string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Again, Likewise an_integer and an_integer_as_string cast as a float and then a string does not match the same value cast to a string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">an_integer | float | string != an_integer | string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">an_integer_as_string | float | string != an_integer_as_string | string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Native Boolean interpretation&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="kc">yes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="kc">True</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="kc">TRUE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="kc">no</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="kc">No</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="kc">NO</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="kc">False</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="kc">FALSE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">assert</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">that</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Note that while other values may be cast to boolean values, these are the only ones which are natively considered boolean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Note also that `yes` is the only case sensitive variant of these values.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">item is boolean</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="获取当前时间" class="heading-element">
  <a href="#%e8%8e%b7%e5%8f%96%e5%bd%93%e5%89%8d%e6%97%b6%e9%97%b4" class="heading-mark"></a>获取当前时间</h2><p><code>now</code> 函数获取对象的本地时间，有以下参数：</p>
<ul>
<li><code>utc</code>: 使用<code>UTC</code>标准时间。值为 <code>True</code> 或 <code>False</code>(默认值)</li>
<li>自定义格式，参考<a href="https://docs.python.org/3/library/datetime.html#strftime-strptime-behavior"target="_blank" rel="external nofollow noopener noreferrer">strftime-strptime-behavior</a></li>
</ul>
<h2 id="循环" class="heading-element">
  <a href="#%e5%be%aa%e7%8e%af" class="heading-mark"></a>循环</h2><p><code>Ansible</code> 提供<code>loop</code>、<code>with_&lt;lookup&gt;</code>和<code>until</code>关键字来多次执行任务</p>
<h3 id="遍历列表" class="heading-element">
  <a href="#%e9%81%8d%e5%8e%86%e5%88%97%e8%a1%a8" class="heading-mark"></a>遍历列表</h3><p><code>loop</code>关键字可以输入一个列表（以逗号分割），<code>item</code> 变量循环获取 <code>loop</code> 列表的每个值。</p>
<div class="highlight" id="id-48"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Add several users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.user</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;wheel&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="l">testuser1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="l">testuser2</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-49"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Optimal yum</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ list_of_packages }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Non-optimal yum, slower and may cause issues with interdependencies</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ list_of_packages }}&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可以使用 <code>Jinja2</code> 表达式迭代复杂列表</p>
<div class="highlight" id="id-50"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Give users access to multiple databases</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">community.mysql.mysql_user</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item[0] }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">priv</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item[1] }}.*:ALL&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">append_privs</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;foo&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ [&#39;alice&#39;, &#39;bob&#39;] | product([&#39;clientdb&#39;, &#39;employeedb&#39;, &#39;providerdb&#39;]) | list }}&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>从<code>Ansible 2.5</code> 引入了一个名为<code>query</code>的新 <code>Jinja2</code> 函数。该函数始终反回一个列表</p>
<div class="highlight" id="id-51"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ query(&#39;inventory_hostnames&#39;, &#39;all&#39;) }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 等效</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ lookup(&#39;inventory_hostnames&#39;, &#39;all&#39;, wantlist=True) }}&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="遍历哈希" class="heading-element">
  <a href="#%e9%81%8d%e5%8e%86%e5%93%88%e5%b8%8c" class="heading-mark"></a>遍历哈希</h3><p>如果是键值对列表可以引用子键</p>
<div class="highlight" id="id-52"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Add several users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.user</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.name }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.groups }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- {<span class="w"> </span><span class="nt">name: &#39;testuser1&#39;, groups</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;wheel&#39;</span><span class="w"> </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- {<span class="w"> </span><span class="nt">name: &#39;testuser2&#39;, groups</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="w"> </span>}</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="遍历字典" class="heading-element">
  <a href="#%e9%81%8d%e5%8e%86%e5%ad%97%e5%85%b8" class="heading-mark"></a>遍历字典</h3><p>如果是遍历字典，需要使用 <code>dict2items</code> 关键字转换为列表</p>
<div class="highlight" id="id-53"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Using dict2items</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.key }} - {{ item.value }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ tag_data | dict2items }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tag_data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">Environment</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">Application</span><span class="p">:</span><span class="w"> </span><span class="l">payment</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="重复执行任务知道满足条件" class="heading-element">
  <a href="#%e9%87%8d%e5%a4%8d%e6%89%a7%e8%a1%8c%e4%bb%bb%e5%8a%a1%e7%9f%a5%e9%81%93%e6%bb%a1%e8%b6%b3%e6%9d%a1%e4%bb%b6" class="heading-mark"></a>重复执行任务知道满足条件</h3><p>从 <code>1.4</code> 版本开始，可以使用 <code>until</code> 关键字重试任务，<code>ansible-playbook -vv</code> 可以查看重试的次数，结果在注册变量中的 <code>attempts</code> 键</p>
<div class="highlight" id="id-54"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Retry a task until a certain condition is met</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.shell</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/bin/foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l">result</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 重试条件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">until</span><span class="p">:</span><span class="w"> </span><span class="l">result.stdout.find(&#34;all systems go&#34;) != -1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 重试次数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">retries</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 重试间隔时间，单位秒</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">delay</span><span class="p">:</span><span class="w"> </span><span class="m">10</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="遍历清单文件" class="heading-element">
  <a href="#%e9%81%8d%e5%8e%86%e6%b8%85%e5%8d%95%e6%96%87%e4%bb%b6" class="heading-mark"></a>遍历清单文件</h3><p>可以使用 <code>ansible_play_batch</code> 变量、 <code>groups</code> 变量、<code>inventory_hostnames</code> 变量遍历清单列表</p>
<div class="highlight" id="id-55"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Show all the hosts in the inventory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ groups[&#39;all&#39;] }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Show all the hosts in the current play</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ ansible_play_batch }}&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-56"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Show all the hosts in the inventory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ query(&#39;inventory_hostnames&#39;, &#39;all&#39;) }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Show all the hosts matching the pattern, ie all but the group www</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ query(&#39;inventory_hostnames&#39;, &#39;all:!www&#39;) }}&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="限制循环输出信息" class="heading-element">
  <a href="#%e9%99%90%e5%88%b6%e5%be%aa%e7%8e%af%e8%be%93%e5%87%ba%e4%bf%a1%e6%81%af" class="heading-mark"></a>限制循环输出信息</h3><p><code>loop_control.label</code> 关键字能指定 <code>loop</code> 关键字的输出信息，使用 <code>no_log: yes</code> 能禁止输出信息</p>
<div class="highlight" id="id-57"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Create servers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">digital_ocean</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.name }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">server1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">disks</span><span class="p">:</span><span class="w"> </span><span class="l">3gb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ram</span><span class="p">:</span><span class="w"> </span><span class="l">15Gb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">network</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">nic01</span><span class="p">:</span><span class="w"> </span><span class="l">100Gb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">nic02</span><span class="p">:</span><span class="w"> </span><span class="l">10Gb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loop_control</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.name }}&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="暂停循环" class="heading-element">
  <a href="#%e6%9a%82%e5%81%9c%e5%be%aa%e7%8e%af" class="heading-mark"></a>暂停循环</h3><p>从<code>2.2</code> 版本开始，可以使用<code>loop_control</code>下<code>pause</code> 字段能控制循环任务间隔时间（秒）</p>
<div class="highlight" id="id-58"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># main.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Create servers, pause 3s before creating next</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">community.digitalocean.digital_ocean</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">server1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">server2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loop_control</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pause</span><span class="p">:</span><span class="w"> </span><span class="m">3</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="循环列表的索引" class="heading-element">
  <a href="#%e5%be%aa%e7%8e%af%e5%88%97%e8%a1%a8%e7%9a%84%e7%b4%a2%e5%bc%95" class="heading-mark"></a>循环列表的索引</h3><p>从<code>2.5</code> 版本开始，可以使用<code>loop_control</code>下<code>index_var</code>字段能获取列表索引值</p>
<div class="highlight" id="id-59"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Count our fruit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }} with index {{ my_idx }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">apple</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">banana</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">pear</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loop_control</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">index_var</span><span class="p">:</span><span class="w"> </span><span class="l">my_idx</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="loop-扩展信息" class="heading-element">
  <a href="#loop-%e6%89%a9%e5%b1%95%e4%bf%a1%e6%81%af" class="heading-mark"></a>loop 扩展信息</h3><p>从 <code>2.8</code> 版本开始，可以启用<code>loop_control.extended</code>启用以下变量，它会占用更多的内存</p>
<ul>
<li><code>ansible_loop.allitems</code>: 循环中的列表值。从<code>2.14</code>开始可以使用<code>true</code>或<code>false</code>关闭</li>
<li><code>ansible_loop.index</code>: 循环中索引(从1开始)</li>
<li><code>ansible_loop.index0</code>: 循环中索引(从0开始)</li>
<li><code>ansible_loop.revindex</code>: 循环次数</li>
<li><code>ansible_loop.revindex0</code>: 循环次数(从0开始)</li>
<li><code>ansible_loop.first</code>: 如果为 <code>True</code> 表示第一次迭代</li>
<li><code>ansible_loop.last</code>: 如果为 <code>True</code> 表示最后一次迭代</li>
<li><code>ansible_loop.length</code>: 循环中的项目个数</li>
<li><code>ansible_loop.previtem</code></li>
<li><code>ansible_loop.nextitem</code></li>
</ul>
<h2 id="执行任务位置" class="heading-element">
  <a href="#%e6%89%a7%e8%a1%8c%e4%bb%bb%e5%8a%a1%e4%bd%8d%e7%bd%ae" class="heading-mark"></a>执行任务位置</h2><p>执行的操作可以在当前主机执行，也可以目标主机上执行(默认)。以下操作只能在本地执行</p>
<ul>
<li><code>include</code></li>
<li><code>add_host</code></li>
<li><code>debug</code>
<br></li>
</ul>
<p>如果某些操作想在特定主机上执行可以使用<code>delegate_to</code>指定，指定的目标主机不一定是在清单文件中，但这样会缺少部分变量导致任务执行失败，可以使用<a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/add_host_module.html#add-host-module"target="_blank" rel="external nofollow noopener noreferrer">ansible.builtin.add_host</a> 模块添加到清单文件中</p>
<div class="highlight" id="id-60"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">webservers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serial</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Take out of load balancer pool</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ansible.builtin.command</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/bin/take_out_of_pool {{ inventory_hostname }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">delegate_to</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Actual steps would go here</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">acme-web-stack</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Add back to load balancer pool</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ansible.builtin.command</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/bin/add_back_to_pool {{ inventory_hostname }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">delegate_to</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="本地执行" class="heading-element">
  <a href="#%e6%9c%ac%e5%9c%b0%e6%89%a7%e8%a1%8c" class="heading-mark"></a>本地执行</h3><div class="highlight" id="id-61"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">webservers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serial</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Take out of load balancer pool</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ansible.builtin.command</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/bin/take_out_of_pool {{ inventory_hostname }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">delegate_to</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># host 指定为 127.0.0.1 表示本机</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">localhost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 修改默认的远程连接类型（可选）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l">local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serial</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Take out of load balancer pool</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ansible.builtin.command</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/bin/take_out_of_pool {{ inventory_hostname }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Take out of load balancer pool</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">local_action</span><span class="p">:</span><span class="w"> </span><span class="l">ansible.builtin.command /usr/bin/take_out_of_pool {{ inventory_hostname }}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://cloud.tencent.com/developer/article/1519723"target="_blank" rel="external nofollow noopener noreferrer">https://cloud.tencent.com/developer/article/1519723</a></p>
<h2 id="条件句" class="heading-element">
  <a href="#%e6%9d%a1%e4%bb%b6%e5%8f%a5" class="heading-mark"></a>条件句</h2><p><code>when</code> 字段用于当满足条件(<a href="https://jinja.palletsprojects.com/en/latest/templates/#comparisons"target="_blank" rel="external nofollow noopener noreferrer">Jinja 条件判断</a>、<a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_tests.html#playbooks-tests"target="_blank" rel="external nofollow noopener noreferrer">jinja 测试语句</a>、<a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_filters.html#playbooks-filters"target="_blank" rel="external nofollow noopener noreferrer">ansible 过滤器</a>)满足才执行操作。该子句是没有双花括号的原始 <code>Jinja2</code> 表达式。它是值为列表，每个列表表示一个条件判断，当有多个列表时所有条件满足才执行</p>
<div class="highlight" id="id-62"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># selinux 状态为 enabled 时执行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Configure SELinux to start mysql on any port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ansible.posix.seboolean</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysql_connect_any</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">persistent</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">ansible_selinux.status == &#34;enabled&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>当有多个条件时可以使用括号、逻辑运算符进行复杂的判断</p>
<div class="highlight" id="id-63"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Shut down CentOS 6 and Debian 7 systems</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ansible.builtin.command</span><span class="p">:</span><span class="w"> </span><span class="l">/sbin/shutdown -t now</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">(ansible_facts[&#39;distribution&#39;] == &#34;CentOS&#34; and ansible_facts[&#39;distribution_major_version&#39;] == &#34;6&#34;) or</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="l">(ansible_facts[&#39;distribution&#39;] == &#34;Debian&#34; and ansible_facts[&#39;distribution_major_version&#39;] == &#34;7&#34;)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Shut down CentOS 6 systems</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ansible.builtin.command</span><span class="p">:</span><span class="w"> </span><span class="l">/sbin/shutdown -t now</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">when</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ansible_facts[&#39;distribution&#39;] == &#34;CentOS&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ansible_facts[&#39;distribution_major_version&#39;] == &#34;6&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">ansible.builtin.shell</span><span class="p">:</span><span class="w"> </span><span class="l">echo &#34;only on Red Hat 6, derivatives, and later&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">ansible_facts[&#39;os_family&#39;] == &#34;RedHat&#34; and ansible_facts[&#39;lsb&#39;][&#39;major_release&#39;] | int &gt;= 6</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="任务状态为-failed-触发其它任务" class="heading-element">
  <a href="#%e4%bb%bb%e5%8a%a1%e7%8a%b6%e6%80%81%e4%b8%ba-failed-%e8%a7%a6%e5%8f%91%e5%85%b6%e5%ae%83%e4%bb%bb%e5%8a%a1" class="heading-mark"></a>任务状态为 failed 触发其它任务</h2><p><code>block</code> 可以把多个任务进行分组处理，并提供以下异常处理方式：</p>
<ul>
<li><code>rescue</code>字段用于<code>block</code>字段中的任意一个任务失败(<code>failed</code>状态)时触发的任务</li>
<li><code>always</code> 字段是 <code>block</code>字段任务执行后（不管成功还是失败）都会执行
<br></li>
</ul>
<div class="highlight" id="id-64"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Attempt and graceful roll back demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">block</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Print a message</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;I execute normally&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Force a failure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ansible.builtin.command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Never print this</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;I never execute, due to the above task failing, :-(&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rescue</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Print when errors</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;I caught an error&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Force a failure in middle of recovery! &gt;:-)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ansible.builtin.command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Never print this</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;I also never execute :-(&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">always</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Always do this</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;This always executes&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如果<code>block</code>中的任务触发<code>rescue</code>字段，且这些字段中定义的任务执行成功。则不会中段后续任务。也不会触发<code>any_errors_fatal</code>与<code>max_fail_percentage</code>配置项。但<code>ansible</code>输出信息中任然有失败信息。可以在 <code>rescue</code> 中使用<code>meta: flush_handlers</code>忽略错误</p>
<div class="highlight" id="id-65"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w"> </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Attempt and graceful roll back demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">block</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Print a message</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;I execute normally&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nt">changed_when</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="l">run me even after an error</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Force a failure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nt">ansible.builtin.command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">rescue</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Make sure all handlers run</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nt">meta</span><span class="p">:</span><span class="w"> </span><span class="l">flush_handlers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">handlers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Run me even after an error</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;This handler runs even on error&#39;</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>rescue</code> 提供以下变量，这些变量在 <code>2.14</code> 开始可以在 <code>rescue</code> 外获取</p>
<ul>
<li><code>ansible_failed_task.</code>: 待补充</li>
<li><code>ansible_failed_result</code>: 待补充</li>
</ul>
<h2 id="任务状态为-changed-时触发其他任务" class="heading-element">
  <a href="#%e4%bb%bb%e5%8a%a1%e7%8a%b6%e6%80%81%e4%b8%ba-changed-%e6%97%b6%e8%a7%a6%e5%8f%91%e5%85%b6%e4%bb%96%e4%bb%bb%e5%8a%a1" class="heading-mark"></a>任务状态为 changed 时触发其他任务</h2><p><code>notify</code> 字段可以在任务状态为 <code>changed</code> 时调用 <code>handlers</code> 字段中的任务。<code>handlers</code> 字段中的任务列表名称是全局唯一的，按执行顺序以<code>yaml</code>文件定义为准，而不是<code>notify</code>列表顺序</p>
<div class="highlight" id="id-66"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Template configuration file</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l">template.j2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/foo.conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 任务状态结果为 changed 时调用 handlers 列表中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 名为 Restart apache 与 Restart memcached 任务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">notify</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">Restart apache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">Restart memcached</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">handlers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 优先执行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Restart memcached</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ansible.builtin.service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">memcached</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">restarted</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 最后执行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Restart apache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ansible.builtin.service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">restarted</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如果<code>tasks</code>列表中有多少任务调用同一个 <code>handlers</code> 任务则它们中最后的一个任务状态为 <code>changed</code> 才会调用，忽略之前的调用。</p>
<p>默认情况下只有 <code>tasks</code> 任务列表正常结束（没有失败，因为失败会中断剧本执行）后才会调用 <code>handlers</code> 列表，这样可以保证<code>handlers</code> 列表中的任务只会执行一次。可以使用<code>tasks.meta</code>字段直接调用（插队）。</p>
<div class="highlight" id="id-67"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Some tasks go here</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ansible.builtin.shell</span><span class="p">:</span><span class="w"> </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 调用 handlers 任务列表中任务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Flush handlers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">meta</span><span class="p">:</span><span class="w"> </span><span class="l">flush_handlers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Some other tasks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ansible.builtin.shell</span><span class="p">:</span><span class="w"> </span><span class="l">..</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>handlers</code> 任务列表中的任务是可以使用 <code>listen</code> 字段进行分组。<code>notify</code> 字段可以调用分组</p>
<div class="highlight" id="id-68"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Restart everything</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">echo &#34;this task will restart the web services&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;restart web services&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">handlers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Restart memcached</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">memcached</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">restarted</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">listen</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;restart web services&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Restart apache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">restarted</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">listen</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;restart web services&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="playbooks-错误处理" class="heading-element">
  <a href="#playbooks-%e9%94%99%e8%af%af%e5%a4%84%e7%90%86" class="heading-mark"></a>Playbooks 错误处理</h2><p>默认情况下，<code>ansible</code> 收到非<code>0</code>的状态码或模块返回的错误时（状态），会停止该主机上继续执行其他任务，其它主机不受影响。</p>
<h3 id="忽略-failed-状态" class="heading-element">
  <a href="#%e5%bf%bd%e7%95%a5-failed-%e7%8a%b6%e6%80%81" class="heading-mark"></a>忽略 failed 状态</h3><p>当模块执行状态为 <code>failed</code> 时可以启用 <code>ignore_errors</code> 字段忽略错误，使后续任务能继续在目标主机执行</p>
<div class="highlight" id="id-69"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Do not count this as a failure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ignore_errors</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="忽略-unreachable-错误" class="heading-element">
  <a href="#%e5%bf%bd%e7%95%a5-unreachable-%e9%94%99%e8%af%af" class="heading-mark"></a>忽略 UNREACHABLE 错误</h3><p>由于主机无法连接导致报错 <code>UNREACHABLE</code>，可以启用<code>ignore_unreachable</code> 关键字忽略该错误(这有什么用途？)</p>
<div class="highlight" id="id-70"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">This executes, fails, and the failure is ignored</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ignore_unreachable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">This executes, fails, and ends the play for this host</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ansible.builtin.command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/true</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="确保-shell-命令成功" class="heading-element">
  <a href="#%e7%a1%ae%e4%bf%9d-shell-%e5%91%bd%e4%bb%a4%e6%88%90%e5%8a%9f" class="heading-mark"></a>确保 shell 命令成功</h3><p><code>ansible.builtin.shell</code> 模块执行的命令返回值不为 <code>0</code> 时，任务状态码为 <code>failed</code>。因此可以通过使用 <code>||</code> 让命令返回的状态码为 <code>0</code></p>
<div class="highlight" id="id-71"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Run this command and ignore the result</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ansible.builtin.shell</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/bin/somecommand || /bin/true</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="等待补充" class="heading-element">
  <a href="#%e7%ad%89%e5%be%85%e8%a1%a5%e5%85%85" class="heading-mark"></a>等待补充</h3><p><a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_error_handling.html#ensuring-success-for-command-and-shell"target="_blank" rel="external nofollow noopener noreferrer">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_error_handling.html#ensuring-success-for-command-and-shell</a></p>
<h2 id="ansible-lint" class="heading-element">
  <a href="#ansible-lint" class="heading-mark"></a>ansible-lint</h2><p>运行 <code>playbook</code> 之前验证它们以捕获语法错误和其他问题。<code>ansible-playbook</code>命令提供了多个验证选项，包括<code>--check</code>、<code>--diff</code>、<code>--list-hosts</code>、<code>--list-tasks</code>和<code>--syntax-check</code>。用于验证剧本的工具描述了用于验证和测试剧本的其他工具。也可以使用 <code>ansible-lint</code> 命令</p>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2023-04-20 22:30:39">更新于 2023-04-20&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/ansible/" class="post-tag" title="标签 - ansible">ansible</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/windowsWsl/" class="post-nav-item" rel="prev" title="Windows Subsystem for Linux "><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Windows Subsystem for Linux </a>
      <a href="/neovimInitialization/" class="post-nav-item" rel="next" title="neovim 初始化">neovim 初始化<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.115.3"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.1"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2022 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/pangu/pangu.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"lightgallery":true,"pangu":{"enable":true,"selector":"article"},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":true,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.3,"type":"fuse","useExtendedSearch":false}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
